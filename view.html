<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Streaming Tester</title>
  <!-- 若 API 不在同網域，改這裡 -->
  <meta id="api-meta" data-api-base="http://localhost:8000/api/v1">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --bg:#0b1220; --panel:#111827; --text:#e5e7eb; --sub:#9ca3af; --accent:#3b82f6; --danger:#ef4444; --muted:#374151; --border:#21314d; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial }
    header{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--border) }
    h1{ font-size:20px; margin:0 }
    .pill{ background:var(--danger); color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer }
    .btn{ background:var(--accent); color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer }
    .btn.secondary{ background:#4b5563 }
    .btn.danger{ background:var(--danger) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; position:relative }
    fieldset{ border:1px solid var(--border); border-radius:14px; padding:14px; margin:12px 0 }
    legend{ padding:0 8px; color:var(--sub) }
    video{ width:100%; aspect-ratio:16/9; background:#1f2937; border-radius:14px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    select, input{ background:#0f1629; border:1px solid var(--border); color:var(--text); padding:10px; border-radius:10px }
    .grow{ flex:1 1 220px }
    .small{ width:110px; text-align:center }
    .hint{ color:var(--sub); font-size:12px }
    .right{ margin-left:auto }
    .copywrap{ display:flex; gap:8px; align-items:center }
    .copywrap input{ flex:1 1 auto; min-width:0 }
    #overlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:9999 }
    #overlay.show{ display:grid }
    .dialog{ width:min(420px, 92vw); background:#0d1117; border:1px solid #263142; border-radius:14px; padding:16px; box-shadow:0 25px 80px rgba(0,0,0,.6) }
    .dialog header{ display:flex; align-items:center; justify-content:space-between; padding:0; border:0; margin-bottom:8px }
    .x{ width:32px; height:32px; border-radius:8px; border:1px solid #2b3546; background:#0b0f14; color:#cbd5e1; cursor:pointer }
    label{ display:block; margin:8px 0 4px; color:#cbd5e1 }
    .dialog input{ width:100% }
    .err{ color:#fca5a5; min-height:1em; font-size:12px; margin-top:6px }
    #toast{ position:fixed; right:18px; bottom:18px; background:#111827; border:1px solid #334155; padding:10px 12px; border-radius:10px; opacity:0; transform:translateY(10px); transition:.25s; pointer-events:none }
    #toast.show{ opacity:1; transform:translateY(0) }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Streaming Tester</h1>
      <div class="row">
        <span id="who" class="hint">未登入</span>
        <button id="loginBtn" class="pill" style="background:#64748b">Login</button>
        <button id="logoutBtn" class="pill" style="display:none">Logout</button>
      </div>
    </header>

    <div class="wrap">
      <fieldset>
        <legend>播放器</legend>
        <video id="video" controls autoplay muted playsinline></video>
      </fieldset>

      <div class="row" style="margin-top:10px">
        <select id="camera" class="grow"></select>
        <input id="ttl" class="small" type="number" min="30" max="3600" value="60" title="token 存活秒數" />
        <input id="seg" class="small" type="number" min="1" max="600" value="30" title="HLS 分段秒數（segment_seconds）" />
        <button id="connect" class="btn">建立串流</button>
        <button id="playWrtc" class="btn secondary">▶ WebRTC</button>
        <button id="stopWrtc" class="btn danger" style="display:none">停止 WebRTC</button>
        <button id="toggleHls" class="btn secondary right">▶ HLS</button>
      </div>

      <fieldset>
        <legend>推流設定</legend>
        <div class="copywrap">
          <input id="rtspUrl" type="text" readonly placeholder="建立串流後會顯示 RTSP 推流連結（含短效 token）" />
          <button id="copyRtsp" class="btn secondary" disabled>複製</button>
        </div>
        <p class="hint">此 URL 給你/相機端推 RTSP 到 MediaMTX。為短效，前端會定期重新索取並更新。</p>
      </fieldset>

      <p class="hint" id="info"></p>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="overlay">
    <div class="dialog" role="dialog" aria-modal="true" aria-label="Login">
      <header>
        <h3 style="margin:0">登入</h3>
        <button class="x" id="closeLogin" aria-label="Close">✕</button>
      </header>
      <form id="loginForm">
        <label for="account">帳號</label>
        <input id="account" name="username" autocomplete="username" placeholder="例：admin" required>
        <label for="password">密碼</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required>
        <div class="row" style="margin-top:12px">
          <button id="submitLogin" class="btn" type="submit">登入</button>
          <span class="hint">成功後將 access_token 存到 cookie 與 localStorage（1 小時）</span>
        </div>
        <div id="loginErr" class="err"></div>
      </form>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ===== 工具 =====
    const $ = (s) => document.querySelector(s);
    const API_BASE = (()=>{ const meta=document.querySelector('#api-meta'); return (meta?.dataset.apiBase||'/api/v1').replace(/\/+$/,''); })();

    function setCookie(name, value, maxAgeSec){
      let s = `${name}=${encodeURIComponent(value)}; path=/; SameSite=Lax`;
      if (maxAgeSec) s += `; max-age=${maxAgeSec}`;
      if (location.protocol === 'https:') s += '; Secure';
      document.cookie = s;
    }
    function getCookie(name){ const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-.\\w]/g,"\\$&")+'=([^;]*)')); return m?decodeURIComponent(m[1]):null }
    function delCookie(name){ document.cookie = `${name}=; path=/; max-age=0; SameSite=Lax` + (location.protocol==='https:'?'; Secure':''); }
    function setToken(t){ try{localStorage.setItem('access_token', t)}catch{} setCookie('access_token', t, 3600) }
    function getToken(){ return getCookie('access_token') || ( ()=>{ try{return localStorage.getItem('access_token')}catch{return null} } )() }
    function clearToken(){ try{localStorage.removeItem('access_token')}catch{} delCookie('access_token') }
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200) }

    async function api(path, opts={}){
      const url = /^https?:\/\//.test(path) ? path : `${API_BASE}${path.startsWith('/')?path:`/${path}`}`;
      const h = new Headers(opts.headers || {});
      const token = getToken();
      if (token) h.set('Authorization', 'Bearer '+token);
      h.set('Cache-Control','no-store');
      const r = await fetch(url, { ...opts, headers: h });
      if (r.status === 401) throw new Error('401');
      return r;
    }

    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); toast('已複製到剪貼簿'); }
      catch{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('已複製'); }
    }

    // ===== 登入 Modal =====
    function showLogin(){ $('#overlay').classList.add('show'); document.body.style.overflow='hidden'; $('#app').inert = true; setTimeout(()=>$('#account').focus(),0); }
    function closeLogin(){ $('#overlay').classList.remove('show'); document.body.style.overflow=''; $('#app').inert = false; $('#loginErr').textContent=''; $('#loginForm').reset(); }

    // ===== App 狀態 =====
    const state = {
      user: null,
      cameras: [],
      hls: null,
      whep: null,     // WHEPPlayer
      last: {
        hlsUrl:null, wrtcUrl:null, rtspUrl:null, camId:null,
        ttl:{ hls:0, webrtc:0, rtsp:0 }
      },
      timers: { hls:null, webrtc:null, rtsp:null }
    };

    function updateHeader(){
      const who = $('#who');
      if (state.user) { who.textContent = `Hi, ${state.user.name ?? 'user'} (#${state.user.id})`; $('#loginBtn').style.display='none'; $('#logoutBtn').style.display='inline-block'; }
      else { who.textContent = '未登入'; $('#loginBtn').style.display='inline-block'; $('#logoutBtn').style.display='none'; }
    }

    // ===== 載入使用者與鏡頭 =====
    async function fetchMe(){
      const r = await api('/users/me'); const j = await r.json();
      // 兼容回傳格式（{} 或 {user:{...}}）
      const u = j?.user || j;
      if (!u || typeof u.id === 'undefined') throw new Error('me payload missing id');
      state.user = { id: u.id, name: u.name || u.account || 'user', role: u.role || '' };
      updateHeader(); return state.user;
    }

    async function loadCameras(){
      if (!state.user?.id) return;
      const r = await api(`/camera/?user_id=${encodeURIComponent(state.user.id)}&page=1&size=100`);
      const j = await r.json(); const items = j?.items || [];
      state.cameras = items; const sel = $('#camera'); sel.innerHTML = '';
      if (!items.length){ sel.insertAdjacentHTML('beforeend', `<option value="" selected>(無相機)</option>`); return; }
      for (const c of items){ sel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name} — ${c.id}</option>`); }
    }

    // ===== 續期（改為重新索取 URL） =====
    function clearTimer(which){ if (state.timers[which]){ clearTimeout(state.timers[which]); state.timers[which]=null; } }

    function scheduleRefresh(kind){
      clearTimer(kind);
      const ttl = state.last.ttl[kind] || 0;
      if (!ttl || !state.last.camId) return;
      const wait = Math.max(5, ttl - 10) * 1000;
      state.timers[kind] = setTimeout(async ()=>{
        try{
          if (kind === 'hls') {
            const { url, ttl } = await getPlayHlsUrl(state.last.camId);
            state.last.hlsUrl = url; state.last.ttl.hls = ttl;
            if (state.hls) state.hls.loadSource(url);
          } else if (kind === 'webrtc') {
            const { url, ttl } = await getPlayWebrtcUrl(state.last.camId);
            state.last.wrtcUrl = url; state.last.ttl.webrtc = ttl;
            if (state.whep) await state.whep.reconnect(url);
          } else if (kind === 'rtsp') {
            const { url, ttl } = await getPublishRtspUrl(state.last.camId);
            state.last.rtspUrl = url; state.last.ttl.rtsp = ttl;
            setRtspDisplay(url);
          }
          scheduleRefresh(kind);
        }catch(e){ console.warn('refresh failed', e); }
      }, wait);
    }

    // ===== 播放控制（HLS） =====
    function setHlsButtonPlaying(isPlaying){
      const b = $('#toggleHls');
      if (isPlaying){
        b.textContent = '■ 停止 HLS';
        b.classList.remove('secondary'); b.classList.add('danger');
      }else{
        b.textContent = '▶ HLS';
        b.classList.remove('danger'); b.classList.add('secondary');
      }
    }

    async function getPlayHlsUrl(camId){
      const ttl = +($('#ttl').value || 60);
      const r = await api(`/camera/${camId}/play-hls-url?ttl=${ttl}`);
      if (!r.ok) throw new Error('取得 HLS 連結失敗');
      const j = await r.json();
      const url = j.play_hls_url || j.url || j.href;
      if (!url) throw new Error('未取得 HLS URL');
      const out = { url, ttl: j.ttl || ttl };
      return out;
    }

    async function playHls(){
      const camId = $('#camera').value; if (!camId) return toast('請先選擇鏡頭');
      state.last.camId = camId;

      const { url, ttl } = await getPlayHlsUrl(camId);
      state.last.hlsUrl = url; state.last.ttl.hls = ttl;

      const video = $('#video');
      if (Hls.isSupported()){
        if (state.hls) { state.hls.destroy(); state.hls = null; }
        const hls = state.hls = new Hls({ lowLatencyMode:true, backBufferLength:15, liveSyncDuration:1.5, liveMaxLatencyDuration:3, maxLiveSyncPlaybackRate:1.1 });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}) );
        hls.on(Hls.Events.ERROR, (_, data)=>{
          if (data.fatal){
            if (data.type===Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
            else if (data.type===Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
            else { hls.destroy(); setHlsButtonPlaying(false); }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')){
        video.src = url; video.play().catch(()=>{});
      } else { alert('此瀏覽器不支援 HLS'); setHlsButtonPlaying(false); return; }

      scheduleRefresh('hls');
      setHlsButtonPlaying(true);
    }

    function stopHls(){
      if (state.hls){ state.hls.destroy(); state.hls=null; }
      const v=$('#video'); v.removeAttribute('src'); v.srcObject=null;
      clearTimer('hls');
      setHlsButtonPlaying(false);
      toast('HLS 已停止');
    }

    // ===== WHEP 播放器（WebRTC） =====
    class WHEPPlayer {
      constructor(videoEl){ this.video=videoEl; this.pc=null; this.remoteStream=null; }
      async start(whepUrl){ await this._connect(whepUrl); }
      async reconnect(whepUrl){ await this.stop(false); await this._connect(whepUrl); }
      async _connect(whepUrl){
        await this.stop(false);
        this.pc = new RTCPeerConnection();
        this.remoteStream = new MediaStream();
        this.video.srcObject = this.remoteStream;

        this.pc.addTransceiver('video', { direction:'recvonly' });
        this.pc.addTransceiver('audio', { direction:'recvonly' });

        this.pc.ontrack = (ev) => {
          ev.streams[0].getTracks().forEach(t => this.remoteStream.addTrack(t));
          this.video.play().catch(()=>{});
        };

        const offer = await this.pc.createOffer();
        await this.pc.setLocalDescription(offer);

        await new Promise(res=>{
          if (this.pc.iceGatheringState === 'complete') return res();
          const fn = () => { if (this.pc.iceGatheringState === 'complete'){ this.pc.removeEventListener('icegatheringstatechange', fn); res(); } };
          this.pc.addEventListener('icegatheringstatechange', fn);
        });

        const r = await fetch(whepUrl, { method:'POST', headers:{'Content-Type':'application/sdp'}, body:this.pc.localDescription.sdp });
        if (!r.ok) throw new Error(`WHEP offer failed: ${r.status}`);
        const answerSdp = await r.text();
        await this.pc.setRemoteDescription({ type:'answer', sdp:answerSdp });
      }
      async stop(clearMedia=true){
        if (this.pc){ try{ this.pc.close(); }catch{} this.pc=null; }
        if (clearMedia && this.video){ try{ this.video.srcObject?.getTracks().forEach(t=>t.stop()); }catch{} this.video.srcObject=null; }
      }
    }

    async function getPlayWebrtcUrl(camId){
      const ttl = +($('#ttl').value || 60);
      const r = await api(`/camera/${camId}/play-webrtc-url?ttl=${ttl}`);
      if (!r.ok) throw new Error('取得 WebRTC 連結失敗');
      const j = await r.json();
      const url = j.play_webrtc_url || j.url || j.href;
      if (!url) throw new Error('未取得 WebRTC URL');
      return { url, ttl: j.ttl || ttl };
    }

    async function playWebrtc(){
      const camId = $('#camera').value; if (!camId) return toast('請先選擇鏡頭');
      state.last.camId = camId;

      const { url, ttl } = await getPlayWebrtcUrl(camId);
      state.last.wrtcUrl = url; state.last.ttl.webrtc = ttl;

      if (!state.whep) state.whep = new WHEPPlayer($('#video'));
      await state.whep.start(url);
      $('#playWrtc').style.display='none'; $('#stopWrtc').style.display='inline-block';
      scheduleRefresh('webrtc');
    }
    async function stopWebrtc(){
      clearTimer('webrtc'); if (state.whep){ await state.whep.stop(); }
      $('#playWrtc').style.display='inline-block'; $('#stopWrtc').style.display='none';
      toast('WebRTC 已停止');
    }

    // ===== 推流 RTSP =====
    function setRtspDisplay(url){ const box=$('#rtspUrl'), btn=$('#copyRtsp'); box.value=url||''; btn.disabled=!url; }

    async function getPublishRtspUrl(camId){
      const ttl = +($('#ttl').value || 60);
      const r = await api(`/camera/${camId}/publish_rtsp_url?ttl=${ttl}`);
      if (!r.ok) throw new Error('取得 RTSP 推流 URL 失敗');
      const j = await r.json();
      // 端點 schema 未明，盡量兼容命名
      const url = j.publish_rtsp_url || j.rtsp_url || j.url || j.href;
      if (!url) throw new Error('未取得 RTSP 推流 URL');
      return { url, ttl: j.ttl || ttl };
    }

    async function connectStream(){
      const camId = $('#camera').value; if (!camId) return toast('請先選擇鏡頭');
      state.last.camId = camId;
      const ttl = +($('#ttl').value || 60);
      const segment_seconds = +($('#seg').value || 30);

      // 1) 建立串流（後端會準備推/播資源）
      const r = await api(`/camera/${camId}/stream/connect`, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'publish', ttl, segment_seconds })
      });
      if (!r.ok) { toast('建立串流失敗'); return; }
      // connect 回應目前只有 ttl/info，不含 URL。

      // 2) 各自索取 URL
      try{
        const { url: rtspUrl, ttl: rtspTtl } = await getPublishRtspUrl(camId);
        state.last.rtspUrl = rtspUrl; state.last.ttl.rtsp = rtspTtl; setRtspDisplay(rtspUrl);
      }catch(e){ console.warn(e); }

      try{
        const { url: hlsUrl, ttl: hlsTtl } = await getPlayHlsUrl(camId);
        state.last.hlsUrl = hlsUrl; state.last.ttl.hls = hlsTtl;
      }catch(e){ console.warn(e); }

      try{
        const { url: wrtcUrl, ttl: wrtcTtl } = await getPlayWebrtcUrl(camId);
        state.last.wrtcUrl = wrtcUrl; state.last.ttl.webrtc = wrtcTtl;
      }catch(e){ console.warn(e); }

      // 3) 啟動續期
      scheduleRefresh('rtsp'); scheduleRefresh('hls'); scheduleRefresh('webrtc');
      toast('串流已建立');
    }

    // ===== Auth =====
    async function doLogin(e){
      e?.preventDefault?.(); $('#loginErr').textContent='';
      const form = new FormData($('#loginForm'));
      const username = form.get('username'); const password = form.get('password');
      try{
        const r = await fetch(`${API_BASE}/auth/login`, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body:new URLSearchParams({ username, password }) });
        if (!r.ok) throw new Error(r.status === 401 ? '帳號或密碼錯誤' : `登入失敗(${r.status})`);
        const j = await r.json(); if (!j.access_token) throw new Error('伺服器未回傳 access_token');
        setToken(j.access_token); await fetchMe(); await loadCameras(); closeLogin(); toast('登入成功');
      }catch(err){ $('#loginErr').textContent = err.message || String(err); }
    }
    function doLogout(){
      ['rtsp','hls','webrtc'].forEach(clearTimer);
      stopHls(); stopWebrtc(); setRtspDisplay('');
      clearToken(); state.user=null; updateHeader(); toast('已登出');
    }

    // ===== 啟動與綁定 =====
    async function boot(){
      updateHeader();
      if (!getToken()){ showLogin(); return; }
      try{ await fetchMe(); await loadCameras(); }catch(e){ if (String(e.message)==='401'){ showLogin(); } }
      setHlsButtonPlaying(false);
    }

    $('#loginBtn').onclick = showLogin;
    $('#closeLogin').onclick = closeLogin;
    $('#overlay').addEventListener('click', (e)=>{ if (e.target === $('#overlay')) closeLogin(); });
    window.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && $('#overlay').classList.contains('show')) closeLogin(); });
    $('#loginForm').addEventListener('submit', doLogin);

    $('#logoutBtn').onclick = doLogout;
    $('#connect').onclick = ()=> connectStream().catch(()=>toast('建立串流失敗'));
    $('#playWrtc').onclick = ()=> playWebrtc().catch((e)=>{ console.warn(e); toast('WebRTC 失敗'); });
    $('#stopWrtc').onclick = ()=> stopWebrtc();
    $('#toggleHls').onclick = async ()=>{
      if (state.hls){ stopHls(); }
      else { await playHls().catch((e)=>{ console.warn(e); toast('播放失敗'); setHlsButtonPlaying(false); }); }
    };
    $('#copyRtsp').onclick = ()=>{ const url=$('#rtspUrl').value.trim(); if (url) copyText(url); };

    boot();
  </script>
</body>
</html>
