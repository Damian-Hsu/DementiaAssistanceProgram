<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>System Tester</title>
  <!-- è‹¥ API ä¸åœ¨åŒç¶²åŸŸï¼Œæ”¹é€™è£¡ -->
  <meta id="api-meta" data-api-base="http://localhost:30000/api/v1">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --bg:#0b1220; --panel:#111827; --text:#e5e7eb; --sub:#9ca3af; --accent:#3b82f6; --danger:#ef4444; --success:#10b981; --muted:#374151; --border:#21314d; --nav-width:240px; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial; overflow:hidden }
    
    /* Layout */
    .app-container{ display:flex; height:100vh }
    .sidebar{ width:var(--nav-width); background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0 }
    .main-content{ flex:1; display:flex; flex-direction:column; overflow:hidden }
    
    /* Sidebar */
    .sidebar-header{ padding:20px; border-bottom:1px solid var(--border) }
    .sidebar-header h1{ font-size:18px; margin:0 0 8px; font-weight:600 }
    .user-info{ font-size:12px; color:var(--sub); display:flex; align-items:center; gap:8px; margin-top:8px }
    .nav-menu{ flex:1; padding:12px 8px; overflow-y:auto }
    .nav-item{ display:flex; align-items:center; gap:12px; padding:12px 16px; margin:4px 0; border-radius:10px; cursor:pointer; transition:.2s; color:var(--sub); text-decoration:none }
    .nav-item:hover{ background:rgba(59,130,246,.1); color:var(--accent) }
    .nav-item.active{ background:var(--accent); color:#fff }
    .nav-item svg{ width:20px; height:20px; flex-shrink:0 }
    .sidebar-footer{ padding:12px; border-top:1px solid var(--border) }
    
    /* Top Bar */
    header{ display:flex; align-items:center; justify-content:space-between; padding:16px 24px; border-bottom:1px solid var(--border); background:var(--panel); flex-shrink:0 }
    .page-title{ font-size:20px; margin:0; font-weight:600 }
    .header-actions{ display:flex; gap:8px; align-items:center }
    
    /* Content Area */
    .content-area{
      flex:1;
      overflow:hidden; /* å¤–å±¤ä¸æ²ï¼Œç”±èŠå¤©åˆ—è¡¨è² è²¬æ² */
      padding:24px;
      display:flex;            /* è®“å­å±¤å¯ç”¨ 100% é«˜åº¦çš„ flex å®¹å™¨ */
      flex-direction:column;
      min-height:0;            /* å…è¨±å…§å±¤ç¸®å°ï¼Œæ²å‹•æ¬Šäº¤çµ¦å…§å±¤ */
    }
    .page{ display:none; min-height:0; }
    .page.active{ display:flex; flex:1; min-height:0; }
    
    /* Common */
    .pill, .btn{ border:0; border-radius:8px; padding:8px 16px; cursor:pointer; font-size:13px; font-weight:500; transition:.2s }
    .pill{ background:var(--muted); color:var(--text) }
    .pill:hover{ background:#4b5563 }
    .pill.success{ background:var(--success); color:#fff }
    .pill.danger{ background:var(--danger); color:#fff }
    .btn{ background:var(--accent); color:#fff }
    .btn.secondary{ background:#4b5563 }
    .btn.danger{ background:var(--danger) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn:hover:not(:disabled){ filter:brightness(1.1) }
    
    /* Cards & Sections */
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px }
    .card-title{ font-size:15px; font-weight:600; margin:0 0 16px; color:var(--text) }
    fieldset{ border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0 }
    legend{ padding:0 8px; color:var(--sub); font-weight:500 }
    
    /* Video */
    video{ width:100%; aspect-ratio:16/9; background:#000; border-radius:12px }

    /* YouTube-like layout for Streaming page */
    .yt-layout{ display:flex; gap:24px; align-items:flex-start; }
    .yt-left{ flex:1; min-width:0; }
    .yt-right{ width:360px; }
    .video-shell{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px }
    .video-title{ font-size:18px; font-weight:600; margin:12px 0 8px }
    .video-meta{ color:var(--sub); font-size:12px; display:flex; gap:12px; align-items:center }
    .action-bar{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 }
    .chip{ background:#0f1629; border:1px solid var(--border); color:var(--text); border-radius:999px; padding:8px 12px; font-size:12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer }
    .chip:hover{ border-color:#3b82f6 }
    .recommend-list{ margin-top:16px; display:flex; flex-direction:column; gap:12px }
    .rec-item{ display:flex; gap:10px; cursor:pointer }
    .rec-thumb{ width:160px; height:90px; border-radius:8px; background:#0b0f14; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:12px }
    .rec-body{ flex:1; min-width:0 }
    .rec-title{ font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .rec-sub{ color:var(--sub); font-size:12px; margin-top:4px }
    
    /* Form Elements */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    select, input, textarea{ background:#0f1629; border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:8px; font-size:14px }
    select:focus, input:focus, textarea:focus{ outline:none; border-color:var(--accent) }
    .grow{ flex:1 1 220px }
    .small{ width:110px; text-align:center }
    .hint{ color:var(--sub); font-size:12px; margin-top:4px }
    .copywrap{ display:flex; gap:8px; align-items:center }
    .copywrap input{ flex:1 1 auto; min-width:0 }
    label{ display:block; margin:8px 0 4px; color:var(--sub); font-size:13px; font-weight:500 }
    .err{ color:#fca5a5; min-height:1em; font-size:12px; margin-top:6px }
    
    /* Videos Grid */
    .videos-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px; margin-bottom:20px }
    .video-card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; transition:.2s }
    .video-card:hover{ border-color:var(--accent); transform:translateY(-2px) }
    .video-thumbnail{ width:100%; height:180px; background:#0b0f14; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:14px; margin-bottom:12px }
    .video-info h3{ font-size:16px; font-weight:600; margin:0 0 8px; color:var(--text) }
    .video-meta{ color:var(--sub); font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:8px }
    .video-actions{ display:flex; gap:8px; margin-top:12px }
    
    /* Events List */
    .events-list{ display:flex; flex-direction:column; gap:12px; margin-bottom:20px }
    .event-card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; transition:.2s }
    .event-card:hover{ border-color:var(--accent) }
    .event-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px }
    .event-time{ color:var(--accent); font-size:14px; font-weight:500 }
    .event-duration{ color:var(--sub); font-size:12px }
    .event-summary{ font-size:15px; margin-bottom:8px; color:var(--text) }
    .event-tags{ display:flex; gap:6px; flex-wrap:wrap }
    .event-tag{ background:#0f1629; border:1px solid var(--border); color:var(--text); border-radius:999px; padding:4px 8px; font-size:11px }
    
    /* Jobs List */
    .jobs-list{ display:flex; flex-direction:column; gap:12px; margin-bottom:20px }
    .job-card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; transition:.2s }
    .job-card:hover{ border-color:var(--accent) }
    .job-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px }
    .job-id{ color:var(--accent); font-size:14px; font-weight:500; font-family:monospace }
    .job-status{ padding:4px 8px; border-radius:999px; font-size:11px; font-weight:500 }
    .job-status.pending{ background:#fef3c7; color:#92400e }
    .job-status.processing{ background:#dbeafe; color:#1e40af }
    .job-status.success{ background:#d1fae5; color:#065f46 }
    .job-status.failed{ background:#fee2e2; color:#991b1b }
    .job-info{ color:var(--sub); font-size:12px; margin-bottom:8px }
    .job-progress{ margin-top:8px }
    .job-progress-bar{ width:100%; height:4px; background:#0f1629; border-radius:2px; overflow:hidden }
    .job-progress-fill{ height:100%; background:var(--accent); transition:width .3s }
    
    /* Pagination */
    .pagination{ display:flex; justify-content:center; align-items:center; gap:8px; margin-top:20px }
    .pagination button{ padding:8px 12px; border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:6px; cursor:pointer; transition:.2s }
    .pagination button:hover:not(:disabled){ border-color:var(--accent); color:var(--accent) }
    .pagination button:disabled{ opacity:.5; cursor:not-allowed }
    .pagination button.active{ background:var(--accent); color:#fff; border-color:var(--accent) }
    .pagination-info{ color:var(--sub); font-size:12px; margin:0 12px }

    /* Settings Page */
    .settings-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; max-width:1200px; margin:0 auto }
    .settings-section{ display:flex; flex-direction:column; gap:16px }
    .setting-item{ display:flex; flex-direction:column; gap:8px }
    .setting-item label{ font-weight:500; color:var(--text) }
    .setting-item input, .setting-item select{ padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#0f1629; color:var(--text) }
    .setting-item input[type="checkbox"]{ width:auto; margin-right:8px }
    .setting-hint{ color:var(--sub); font-size:12px; margin-top:4px }
    
    /* Video Modal */
    .modal-overlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:1000 }
    .modal-overlay.show{ display:flex }
    .modal-content{ background:var(--panel); border:1px solid var(--border); border-radius:12px; max-width:90vw; max-height:90vh; overflow:hidden }
    .video-modal{ width:800px; max-width:90vw }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border) }
    .modal-header h3{ margin:0; font-size:18px; font-weight:600 }
    .modal-close{ background:none; border:none; color:var(--sub); font-size:20px; cursor:pointer; padding:4px; border-radius:4px; transition:.2s }
    .modal-close:hover{ background:var(--muted); color:var(--text) }
    .modal-body{ padding:20px }

    /* Chat Interface */
    .chat-container{ display:flex; flex-direction:column; height:100%; max-width:900px; margin:0 auto }
    .chat-messages{ flex:1; overflow-y:auto; padding:20px; padding-bottom:20px; display:flex; flex-direction:column; gap:16px; -webkit-overflow-scrolling:touch; scroll-behavior:smooth }

    /* é‡å°èŠå¤©é ï¼šæŠŠé«˜åº¦èˆ‡æ²å‹•æ¬Šä¸€è·¯å‚³éåˆ°æœ€å…§å±¤ */
    #chatPage .chat-container{ display:flex; flex:1; min-height:0; }
    #chatPage .chat-messages{ flex:1; min-height:0; overflow-y:auto; }
    .chat-message{ display:flex; gap:12px; max-width:85% }
    .chat-message.user{ align-self:flex-end; flex-direction:row-reverse }
    .chat-avatar{ width:36px; height:36px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0 }
    .chat-message.ai .chat-avatar{ background:var(--success) }
    .chat-bubble{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px 16px; word-break:break-word }
    .chat-message.user .chat-bubble{ background:var(--accent); border-color:var(--accent); color:#fff }
    .chat-time{ font-size:11px; color:var(--sub); margin-top:4px }
    .chat-input-area{ position:sticky; bottom:0; z-index:1; border-top:1px solid var(--border); padding:16px; background:var(--panel) }
    .chat-input-wrapper{ display:flex; gap:12px; align-items:flex-end }
    .chat-input-wrapper textarea{ flex:1; min-height:44px; max-height:120px; resize:vertical; font-family:inherit }
    .chat-filters{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap }
    .chat-filters input[type="date"]{ flex:1; min-width:140px }
    
    /* Events List */
    .event-item{ background:#0f1629; border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px }
    .event-time{ color:var(--accent); font-weight:600; font-size:13px }
    .event-summary{ color:var(--text); margin:4px 0 }
    .event-meta{ color:var(--sub); font-size:12px }
    
    /* Modals */
    #overlay, #registerOverlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:9999; backdrop-filter:blur(4px) }
    #overlay.show, #registerOverlay.show{ display:grid }
    .dialog{ width:min(440px, 92vw); background:#0d1117; border:1px solid #263142; border-radius:14px; padding:20px; box-shadow:0 25px 80px rgba(0,0,0,.7) }
    .dialog header{ display:flex; align-items:center; justify-content:space-between; padding:0; border:0; margin-bottom:16px }
    .dialog h3{ margin:0; font-size:18px }
    .x{ width:32px; height:32px; border-radius:8px; border:1px solid #2b3546; background:#0b0f14; color:#cbd5e1; cursor:pointer; display:flex; align-items:center; justify-content:center }
    .x:hover{ background:#1a1e2e }
    .dialog input, .dialog select{ width:100% }
    
    /* Toast */
    #toast{ position:fixed; right:20px; bottom:20px; background:#111827; border:1px solid #334155; padding:12px 16px; border-radius:10px; opacity:0; transform:translateY(10px); transition:.25s; pointer-events:none; box-shadow:0 10px 30px rgba(0,0,0,.5) }
    #toast.show{ opacity:1; transform:translateY(0) }
    
    /* Loading */
    .loading{ color:var(--sub); font-size:13px; padding:8px 0 }
    .loading::after{ content:'...'; animation:dots 1.5s infinite }
    @keyframes dots{ 0%, 20%{ content:'.' } 40%{ content:'..' } 60%, 100%{ content:'...' } }
    
    /* Scrollbar */
    ::-webkit-scrollbar{ width:8px; height:8px }
    ::-webkit-scrollbar-track{ background:transparent }
    ::-webkit-scrollbar-thumb{ background:var(--muted); border-radius:4px }
    ::-webkit-scrollbar-thumb:hover{ background:#4b5563 }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ğŸ¥ System Tester</h1>
        <div class="user-info">
          <span id="userAvatar" style="display:none">ğŸ‘¤</span>
          <span id="userName">æœªç™»å…¥</span>
        </div>
      </div>
      
      <nav class="nav-menu">
        <a class="nav-item active" data-page="streaming">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <span>è¦–è¨Šä¸²æµ</span>
        </a>
        <a class="nav-item" data-page="videos">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4zM9 6v10a1 1 0 102 0V6a1 1 0 10-2 0zm4 0v10a1 1 0 102 0V6a1 1 0 10-2 0z"/></svg>
          <span>å½±ç‰‡ç®¡ç†</span>
        </a>
        <a class="nav-item" data-page="events">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
          <span>äº‹ä»¶æŸ¥çœ‹</span>
        </a>
        <a class="nav-item" data-page="jobs">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span>ä»»å‹™ç‹€æ…‹</span>
        </a>
        <a class="nav-item" data-page="chat">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
          <span>AI åŠ©æ‰‹</span>
        </a>
        <a class="nav-item" data-page="settings">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          <span>è¨­å®š</span>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        <button id="registerBtn" class="pill success" style="width:100%; margin-bottom:8px; display:none">è¨»å†Šå¸³è™Ÿ</button>
        <button id="loginBtn" class="pill" style="width:100%; margin-bottom:8px">ç™»å…¥</button>
        <button id="logoutBtn" class="pill danger" style="width:100%; display:none">ç™»å‡º</button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header>
        <h2 class="page-title" id="pageTitle">è¦–è¨Šä¸²æµ</h2>
        <div class="header-actions">
          <span id="cameraCount" class="hint" style="display:none"></span>
        </div>
      </header>

      <div class="content-area">
        <!-- Streaming Page -->
        <div id="streamingPage" class="page active">
          <div class="yt-layout">
            <div class="yt-left">
              <div class="video-shell">
                <video id="video" controls autoplay muted playsinline></video>
                <div class="video-title">æ’­æ”¾å™¨</div>
                <div class="video-meta">
                  <span>ä¸²æµæ§åˆ¶</span>
                </div>
                <div class="action-bar">
                  <select id="camera" class="grow" style="min-width:260px"></select>
                  <input id="ttl" class="small" type="number" min="30" max="3600" value="60" title="token å­˜æ´»ç§’æ•¸" />
                  <input id="seg" class="small" type="number" min="1" max="600" value="60" title="å½±ç‰‡åˆ†æ®µç§’æ•¸ï¼ˆsegment_secondsï¼‰" />
                </div>
                <div class="action-bar">
                  <button id="connect" class="chip">å»ºç«‹ä¸²æµ</button>
                  <button id="playWrtc" class="chip">â–¶ WebRTC</button>
                  <button id="stopWrtc" class="chip" style="display:none">â–  åœæ­¢ WebRTC</button>
                  <button id="toggleHls" class="chip">â–¶ HLS</button>
                </div>
              </div>
            </div>
            <aside class="yt-right">
              <div class="video-shell">
                <div class="video-title">æ¨æµè¨­å®š</div>
                <div class="copywrap" style="margin-bottom:8px">
                  <input id="rtspUrl" type="text" readonly placeholder="å»ºç«‹ä¸²æµå¾Œæœƒé¡¯ç¤º RTSP æ¨æµé€£çµï¼ˆå«çŸ­æ•ˆ tokenï¼‰" />
                  <button id="copyRtsp" class="btn secondary" disabled>è¤‡è£½</button>
                </div>
                <p class="hint">æ­¤ URL çµ¦ä½ /ç›¸æ©Ÿç«¯æ¨ RTSP åˆ° MediaMTXã€‚ç‚ºçŸ­æ•ˆï¼Œå‰ç«¯æœƒå®šæœŸé‡æ–°ç´¢å–ä¸¦æ›´æ–°ã€‚</p>
                <div class="video-title" style="margin-top:16px">å»ºè­°ä¸²æµ</div>
                <div class="recommend-list" id="recList">
                  <div class="rec-item">
                    <div class="rec-thumb">cam ä¾†æº</div>
                    <div class="rec-body">
                      <div class="rec-title">ä½¿ç”¨ HLS æ’­æ”¾</div>
                      <div class="rec-sub">æ›´ç›¸å®¹ç€è¦½å™¨ï¼Œå»¶é²è¼ƒé«˜</div>
                    </div>
                  </div>
                  <div class="rec-item">
                    <div class="rec-thumb">webrtc</div>
                    <div class="rec-body">
                      <div class="rec-title">ä½¿ç”¨ WebRTC æ’­æ”¾</div>
                      <div class="rec-sub">ä½å»¶é²ï¼Œéœ€æ”¯æ´çš„ç€è¦½å™¨</div>
                    </div>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        </div>

        <!-- Videos Page -->
        <div id="videosPage" class="page">
          <div class="card">
            <div class="card-title">å½±ç‰‡åˆ—è¡¨</div>
            <div class="row" style="margin-bottom:16px">
              <input id="videoKeywords" type="text" placeholder="æœå°‹é—œéµå­—..." class="grow" />
              <input id="videoDateFrom" type="date" placeholder="é–‹å§‹æ—¥æœŸ" />
              <input id="videoDateTo" type="date" placeholder="çµæŸæ—¥æœŸ" />
              <select id="videoSort" class="small">
                <option value="-start_time">æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰</option>
                <option value="start_time">æ™‚é–“ï¼ˆèˆŠåˆ°æ–°ï¼‰</option>
                <option value="-created_at">å»ºç«‹æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰</option>
                <option value="created_at">å»ºç«‹æ™‚é–“ï¼ˆèˆŠåˆ°æ–°ï¼‰</option>
                <option value="-duration">é•·åº¦ï¼ˆé•·åˆ°çŸ­ï¼‰</option>
                <option value="duration">é•·åº¦ï¼ˆçŸ­åˆ°é•·ï¼‰</option>
              </select>
              <button id="searchVideos" class="btn">æœå°‹</button>
            </div>
            <div id="videosList" class="videos-grid">
              <!-- å½±ç‰‡åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
            <div id="videosPagination" class="pagination">
              <!-- åˆ†é æ§åˆ¶å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
          </div>
        </div>

        <!-- Events Page -->
        <div id="eventsPage" class="page">
          <div class="card">
            <div class="card-title">äº‹ä»¶åˆ—è¡¨</div>
            <div class="row" style="margin-bottom:16px">
              <input id="eventKeywords" type="text" placeholder="æœå°‹é—œéµå­—..." class="grow" />
              <input id="eventDateFrom" type="date" placeholder="é–‹å§‹æ—¥æœŸ" />
              <input id="eventDateTo" type="date" placeholder="çµæŸæ—¥æœŸ" />
              <select id="eventSort" class="small">
                <option value="-start_time">æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰</option>
                <option value="start_time">æ™‚é–“ï¼ˆèˆŠåˆ°æ–°ï¼‰</option>
                <option value="-created_at">å»ºç«‹æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰</option>
                <option value="created_at">å»ºç«‹æ™‚é–“ï¼ˆèˆŠåˆ°æ–°ï¼‰</option>
                <option value="-duration">é•·åº¦ï¼ˆé•·åˆ°çŸ­ï¼‰</option>
                <option value="duration">é•·åº¦ï¼ˆçŸ­åˆ°é•·ï¼‰</option>
              </select>
              <button id="searchEvents" class="btn">æœå°‹</button>
            </div>
            <div id="eventsList" class="events-list">
              <!-- äº‹ä»¶åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
            <div id="eventsPagination" class="pagination">
              <!-- åˆ†é æ§åˆ¶å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
          </div>
        </div>

        <!-- Jobs Page -->
        <div id="jobsPage" class="page">
          <div class="card">
            <div class="card-title">ä»»å‹™ç‹€æ…‹</div>
            <div class="row" style="margin-bottom:16px">
              <select id="jobStatusFilter" class="grow">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="pending">å¾…è™•ç†</option>
                <option value="processing">è™•ç†ä¸­</option>
                <option value="success">æˆåŠŸ</option>
                <option value="failed">å¤±æ•—</option>
              </select>
              <button id="refreshJobs" class="btn">é‡æ–°æ•´ç†</button>
            </div>
            <div id="jobsList" class="jobs-list">
              <!-- ä»»å‹™åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
            <div id="jobsPagination" class="pagination">
              <!-- åˆ†é æ§åˆ¶å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
          <div class="settings-container">
            <!-- ä½¿ç”¨è€…è¨­å®š -->
            <div class="card">
              <div class="card-title">ä½¿ç”¨è€…è¨­å®š</div>
              <div class="settings-section">
                <div class="setting-item">
                  <label>é¡¯ç¤ºåç¨±</label>
                  <input id="userNameInput" type="text" placeholder="è«‹è¼¸å…¥é¡¯ç¤ºåç¨±" />
                </div>
                <div class="setting-item">
                  <label>é›»å­éƒµä»¶</label>
                  <input id="userEmailInput" type="email" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" />
                </div>
                <div class="setting-item">
                  <label>é›»è©±è™Ÿç¢¼</label>
                  <input id="userPhoneInput" type="tel" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" />
                </div>
                <div class="setting-item">
                  <label>æ™‚å€</label>
                  <select id="userTimezoneSelect">
                    <option value="Asia/Taipei">å°åŒ—æ™‚é–“ (UTC+8)</option>
                    <option value="UTC">UTC æ™‚é–“</option>
                    <option value="America/New_York">ç´ç´„æ™‚é–“ (UTC-5)</option>
                    <option value="Europe/London">å€«æ•¦æ™‚é–“ (UTC+0)</option>
                  </select>
                </div>
                <div class="setting-item">
                  <label>èªè¨€</label>
                  <select id="userLanguageSelect">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en-US">English</option>
                  </select>
                </div>
                <button id="saveUserSettings" class="btn">å„²å­˜ä½¿ç”¨è€…è¨­å®š</button>
              </div>
            </div>

            <!-- é¡é ­è¨­å®š -->
            <div class="card">
              <div class="card-title">é¡é ­è¨­å®š</div>
              <div class="settings-section">
                <div class="setting-item">
                  <label>é è¨­åˆ†æ®µæ™‚é–“ï¼ˆç§’ï¼‰</label>
                  <input id="defaultSegmentTime" type="number" min="10" max="600" value="60" />
                </div>
                <div class="setting-item">
                  <label>Token å­˜æ´»æ™‚é–“ï¼ˆç§’ï¼‰</label>
                  <input id="defaultTokenTTL" type="number" min="30" max="3600" value="300" />
                </div>
                <div class="setting-item">
                  <label>è‡ªå‹•éŒ„è£½</label>
                  <input id="autoRecording" type="checkbox" />
                  <span class="setting-hint">å•Ÿç”¨å¾Œæœƒè‡ªå‹•é–‹å§‹éŒ„è£½</span>
                </div>
                <button id="saveCameraSettings" class="btn">å„²å­˜é¡é ­è¨­å®š</button>
              </div>
            </div>

            <!-- å½±ç‰‡è¨­å®š -->
            <div class="card">
              <div class="card-title">å½±ç‰‡è¨­å®š</div>
              <div class="settings-section">
                <div class="setting-item">
                  <label>é è¨­æ’­æ”¾å“è³ª</label>
                  <select id="defaultVideoQuality">
                    <option value="auto">è‡ªå‹•</option>
                    <option value="720p">720p</option>
                    <option value="480p">480p</option>
                    <option value="360p">360p</option>
                  </select>
                </div>
                <div class="setting-item">
                  <label>è‡ªå‹•æ’­æ”¾</label>
                  <input id="autoPlayVideos" type="checkbox" />
                  <span class="setting-hint">é»æ“Šå½±ç‰‡æ™‚è‡ªå‹•æ’­æ”¾</span>
                </div>
                <div class="setting-item">
                  <label>ä¸‹è¼‰æ ¼å¼</label>
                  <select id="downloadFormat">
                    <option value="mp4">MP4</option>
                    <option value="webm">WebM</option>
                    <option value="avi">AVI</option>
                  </select>
                </div>
                <button id="saveVideoSettings" class="btn">å„²å­˜å½±ç‰‡è¨­å®š</button>
              </div>
            </div>

            <!-- AI è¨­å®š -->
            <div class="card">
              <div class="card-title">AI è¨­å®š</div>
              <div class="settings-section">
                <div class="setting-item">
                  <label>é è¨­ LLM ä¾›æ‡‰å•†</label>
                  <select id="defaultLLMProvider">
                    <option value="google">Google Gemini</option>
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                  </select>
                </div>
                <div class="setting-item">
                  <label>é è¨­æ¨¡å‹</label>
                  <select id="defaultLLMModel">
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="claude-3">Claude 3</option>
                  </select>
                </div>
                <div class="setting-item">
                  <label>äº‹ä»¶åˆ†ææ•æ„Ÿåº¦</label>
                  <input id="eventSensitivity" type="range" min="1" max="10" value="5" />
                  <span class="setting-hint">æ•¸å€¼è¶Šé«˜ï¼Œåˆ†æè¶Šè©³ç´°</span>
                </div>
                <div class="setting-item">
                  <label>è‡ªå‹•ç”Ÿæˆæ‘˜è¦</label>
                  <input id="autoGenerateSummary" type="checkbox" checked />
                  <span class="setting-hint">è‡ªå‹•ç‚ºå½±ç‰‡ç”Ÿæˆæ‘˜è¦</span>
                </div>
                <button id="saveAISettings" class="btn">å„²å­˜ AI è¨­å®š</button>
              </div>
            </div>
          </div>
        </div>

              <!-- Chat Page -->
              <div id="chatPage" class="page">
                <div class="chat-container">
                  <div class="chat-filters">
                    <input id="chatDateFrom" type="date" placeholder="é–‹å§‹æ—¥æœŸ" />
                    <input id="chatDateTo" type="date" placeholder="çµæŸæ—¥æœŸ" />
                    <input id="chatLimit" type="number" min="1" max="50" value="10" class="small" placeholder="æ•¸é‡" />
                    <button id="clearChat" class="btn danger" style="margin-left:auto">æ¸…é™¤å°è©±</button>
                  </div>
            
            <div class="chat-messages" id="chatMessages">
              <div class="chat-message ai">
                <div class="chat-avatar">AI</div>
                <div>
                  <div class="chat-bubble">
                    ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI ç”Ÿæ´»åŠ©æ‰‹ã€‚<br><br>
                    æ‚¨å¯ä»¥å•æˆ‘ï¼š<br>
                    â€¢ "æˆ‘ä»Šå¤©å¹¾é»åƒæ—©é¤ï¼Ÿ"<br>
                    â€¢ "æˆ‘ä»Šå¤©å»äº†å“ªè£¡ï¼Ÿ"<br>
                    â€¢ "æˆ‘åœ¨å®¢å»³åšäº†ä»€éº¼ï¼Ÿ"<br>
                    â€¢ "æˆ‘ä»Šå¤©æœ‰æ•£æ­¥å—ï¼Ÿ"
                  </div>
                  <div class="chat-time">AI åŠ©æ‰‹</div>
                </div>
              </div>
            </div>
            
            <div class="chat-input-area">
              <div class="chat-input-wrapper">
                <textarea id="chatInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." rows="1"></textarea>
                <button id="chatSend" class="btn">
                  <svg style="width:18px;height:18px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerOverlay">
    <div class="dialog" role="dialog" aria-modal="true" aria-label="Register">
      <header>
        <h3 style="margin:0">è¨»å†Š</h3>
        <button class="x" id="closeRegister" aria-label="Close">âœ•</button>
      </header>
      <form id="registerForm">
        <label for="regAccount">å¸³è™Ÿ</label>
        <input id="regAccount" name="account" autocomplete="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
        <label for="regName">åç¨±</label>
        <input id="regName" name="name" placeholder="è«‹è¼¸å…¥é¡¯ç¤ºåç¨±" required>
        <label for="regGender">æ€§åˆ¥</label>
        <select id="regGender" name="gender" required>
          <option value="">è«‹é¸æ“‡</option>
          <option value="male">ç”·</option>
          <option value="female">å¥³</option>
        </select>
        <label for="regBirthday">ç”Ÿæ—¥</label>
        <input id="regBirthday" name="birthday" type="date" required>
        <label for="regPhone">é›»è©±</label>
        <input id="regPhone" name="phone" type="tel" placeholder="0912345678" required>
        <label for="regEmail">Email</label>
        <input id="regEmail" name="email" type="email" autocomplete="email" placeholder="your@email.com" required>
        <label for="regPassword">å¯†ç¢¼</label>
        <input id="regPassword" name="password" type="password" autocomplete="new-password" placeholder="è‡³å°‘ 6 å­—å…ƒ" required minlength="6">
        <label for="regConfirm">ç¢ºèªå¯†ç¢¼</label>
        <input id="regConfirm" name="confirm" type="password" autocomplete="new-password" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" required>
        <div class="row" style="margin-top:12px">
          <button id="submitRegister" class="btn" type="submit">è¨»å†Š</button>
          <span class="hint">è¨»å†ŠæˆåŠŸå¾Œæœƒè‡ªå‹•ç™»å…¥</span>
        </div>
        <div id="registerErr" class="err"></div>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="overlay">
    <div class="dialog" role="dialog" aria-modal="true" aria-label="Login">
      <header>
        <h3 style="margin:0">ç™»å…¥</h3>
        <button class="x" id="closeLogin" aria-label="Close">âœ•</button>
      </header>
      <form id="loginForm">
        <label for="account">å¸³è™Ÿ</label>
        <input id="account" name="username" autocomplete="username" placeholder="ä¾‹ï¼šadmin" required>
        <label for="password">å¯†ç¢¼</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required>
        <div class="row" style="margin-top:12px">
          <button id="submitLogin" class="btn" type="submit">ç™»å…¥</button>
          <span class="hint">æˆåŠŸå¾Œå°‡ access_token å­˜åˆ° cookie èˆ‡ localStorageï¼ˆ1 å°æ™‚ï¼‰</span>
        </div>
        <div id="loginErr" class="err"></div>
      </form>
    </div>
  </div>

  <div id="toast"></div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal-overlay">
    <div class="modal-content video-modal">
      <div class="modal-header">
        <h3 id="videoModalTitle">å½±ç‰‡æ’­æ”¾</h3>
        <button id="closeVideoModal" class="modal-close">âœ•</button>
      </div>
      <div class="modal-body">
        <video id="modalVideo" controls autoplay muted playsinline style="width: 100%; max-height: 70vh;">
          æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾
        </video>
        <div id="videoModalInfo" class="video-info" style="margin-top: 16px;">
          <!-- å½±ç‰‡è³‡è¨Šå°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== å·¥å…· =====
    const $ = (s) => document.querySelector(s);
    const API_BASE = (()=>{ const meta=document.querySelector('#api-meta'); return (meta?.dataset.apiBase||'/api/v1').replace(/\/+$/,''); })();

    function setCookie(name, value, maxAgeSec){
      let s = `${name}=${encodeURIComponent(value)}; path=/; SameSite=Lax`;
      if (maxAgeSec) s += `; max-age=${maxAgeSec}`;
      if (location.protocol === 'https:') s += '; Secure';
      document.cookie = s;
    }
    function getCookie(name){ const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-.\\w]/g,"\\$&")+'=([^;]*)')); return m?decodeURIComponent(m[1]):null }
    function delCookie(name){ document.cookie = `${name}=; path=/; max-age=0; SameSite=Lax` + (location.protocol==='https:'?'; Secure':''); }
    function setToken(t){ try{localStorage.setItem('access_token', t)}catch{} setCookie('access_token', t, 3600) }
    function getToken(){ return getCookie('access_token') || ( ()=>{ try{return localStorage.getItem('access_token')}catch{return null} } )() }
    function clearToken(){ try{localStorage.removeItem('access_token')}catch{} delCookie('access_token') }
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200) }

    async function api(path, opts={}){
      const url = /^https?:\/\//.test(path) ? path : `${API_BASE}${path.startsWith('/')?path:`/${path}`}`;
      const h = new Headers(opts.headers || {});
      const token = getToken();
      if (token) h.set('Authorization', 'Bearer '+token);
      h.set('Cache-Control','no-store');
      const r = await fetch(url, { ...opts, headers: h });
      if (r.status === 401) throw new Error('401');
      return r;
    }

    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'); }
      catch{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('å·²è¤‡è£½'); }
    }

    // ===== è¨»å†Š Modal =====
    function showRegister(){ 
      $('#registerOverlay').classList.add('show'); 
      document.body.style.overflow='hidden'; 
      const appContainer = $('.app-container');
      if (appContainer) appContainer.inert = true;
      setTimeout(()=>$('#regAccount').focus(),0); 
    }
    function closeRegister(){ 
      $('#registerOverlay').classList.remove('show'); 
      document.body.style.overflow=''; 
      const appContainer = $('.app-container');
      if (appContainer) appContainer.inert = false;
      $('#registerErr').textContent=''; 
      $('#registerForm').reset(); 
    }

    // ===== ç™»å…¥ Modal =====
    function showLogin(){ 
      $('#overlay').classList.add('show'); 
      document.body.style.overflow='hidden'; 
      const appContainer = $('.app-container');
      if (appContainer) appContainer.inert = true;
      setTimeout(()=>$('#account').focus(),0); 
    }
    function closeLogin(){ 
      $('#overlay').classList.remove('show'); 
      document.body.style.overflow=''; 
      const appContainer = $('.app-container');
      if (appContainer) appContainer.inert = false;
      $('#loginErr').textContent=''; 
      $('#loginForm').reset(); 
    }

    // ===== App ç‹€æ…‹ =====
    const state = {
      user: null,
      cameras: [],
      hls: null,
      whep: null,     // WHEPPlayer
      last: {
        hlsUrl:null, wrtcUrl:null, rtspUrl:null, camId:null,
        ttl:{ hls:0, webrtc:0, rtsp:0 }
      },
      timers: { hls:null, webrtc:null, rtsp:null },
      chatHistory: []  // å°è©±æ­·å²ï¼ˆç”¨æ–¼ Function Calling å¤šè¼ªå°è©±ï¼‰
    };

    function updateHeader(){
      const userName = $('#userName');
      const userAvatar = $('#userAvatar');
      const cameraCount = $('#cameraCount');
      
      if (state.user) { 
        userName.textContent = state.user.name ?? 'User';
        userAvatar.style.display = 'inline';
        $('#registerBtn').style.display='none';
        $('#loginBtn').style.display='none';
        $('#logoutBtn').style.display='block';
        
        // æ›´æ–°ç›¸æ©Ÿæ•¸é‡
        if (state.cameras.length > 0) {
          cameraCount.textContent = `${state.cameras.length} å€‹æ”å½±æ©Ÿ`;
          cameraCount.style.display = 'inline';
        }
      } else { 
        userName.textContent = 'æœªç™»å…¥';
        userAvatar.style.display = 'none';
        $('#registerBtn').style.display='block';
        $('#loginBtn').style.display='block';
        $('#logoutBtn').style.display='none';
        cameraCount.style.display = 'none';
      }
    }
    
    // ===== é é¢åˆ‡æ› =====
    function switchPage(pageName) {
      // æ›´æ–°å°èˆªé …ç›®
      document.querySelectorAll('.nav-item').forEach(item => {
        if (item.dataset.page === pageName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      
      // æ›´æ–°é é¢å…§å®¹
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // æ ¹æ“šé é¢åç¨±é¡¯ç¤ºå°æ‡‰çš„é é¢
      const pageMap = {
        'streaming': $('#streamingPage'),
        'videos': $('#videosPage'),
        'events': $('#eventsPage'),
        'jobs': $('#jobsPage'),
        'chat': $('#chatPage'),
        'settings': $('#settingsPage')
      };
      
      const targetPage = pageMap[pageName];
      if (targetPage) {
        targetPage.classList.add('active');
      }
      
      // æ›´æ–°é é¢æ¨™é¡Œ
      const titleMap = {
        'streaming': 'è¦–è¨Šä¸²æµ',
        'videos': 'å½±ç‰‡ç®¡ç†',
        'events': 'äº‹ä»¶æŸ¥çœ‹',
        'jobs': 'ä»»å‹™ç‹€æ…‹',
        'chat': 'AI åŠ©æ‰‹',
        'settings': 'è¨­å®š'
      };
      
      $('#pageTitle').textContent = titleMap[pageName] || 'æœªçŸ¥é é¢';
      
      // å¦‚æœåˆ‡æ›åˆ°éœ€è¦ç™»å…¥çš„é é¢ä¸”æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æç¤º
      if (['videos', 'events', 'jobs', 'chat'].includes(pageName) && !state.user) {
        showLogin();
        return;
      }
      
      // åˆ‡æ›è‡³èŠå¤©é æ™‚ï¼Œå¼·åˆ¶æ»¾åˆ°åº•
      if (pageName === 'chat') {
        scrollChatToBottom();
      }
      
      // è¼‰å…¥é é¢æ•¸æ“š
      if (pageName === 'videos') {
        loadVideos();
      } else if (pageName === 'events') {
        loadEvents();
      } else if (pageName === 'jobs') {
        loadJobs();
      } else if (pageName === 'settings') {
        loadSettings();
      }
    }

    // ===== è¼‰å…¥ä½¿ç”¨è€…èˆ‡é¡é ­ =====
    async function fetchMe(){
      const r = await api('/users/me'); const j = await r.json();
      // å…¼å®¹å›å‚³æ ¼å¼ï¼ˆ{} æˆ– {user:{...}}ï¼‰
      const u = j?.user || j;
      if (!u || typeof u.id === 'undefined') throw new Error('me payload missing id');
      state.user = { id: u.id, name: u.name || u.account || 'user', role: u.role || '' };
      updateHeader(); return state.user;
    }

    async function loadCameras(){
      if (!state.user?.id) return;
      const r = await api(`/camera/?user_id=${encodeURIComponent(state.user.id)}&page=1&size=100`);
      const j = await r.json(); const items = j?.items || [];
      state.cameras = items; const sel = $('#camera'); sel.innerHTML = '';
      if (!items.length){ sel.insertAdjacentHTML('beforeend', `<option value="" selected>(ç„¡ç›¸æ©Ÿ)</option>`); return; }
      for (const c of items){ sel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name} â€” ${c.id}</option>`); }
    }

    // ===== çºŒæœŸï¼ˆæ”¹ç‚ºé‡æ–°ç´¢å– URLï¼‰ =====
    function clearTimer(which){ if (state.timers[which]){ clearTimeout(state.timers[which]); state.timers[which]=null; } }

    function scheduleRefresh(kind){
      clearTimer(kind);
      const ttl = state.last.ttl[kind] || 0;
      if (!ttl || !state.last.camId) return;
      const wait = Math.max(5, ttl - 10) * 1000;
      state.timers[kind] = setTimeout(async ()=>{
        try{
          if (kind === 'hls') {
            const { url, ttl } = await getPlayHlsUrl(state.last.camId);
            state.last.hlsUrl = url; state.last.ttl.hls = ttl;
            if (state.hls) state.hls.loadSource(url);
          } else if (kind === 'webrtc') {
            const { url, ttl } = await getPlayWebrtcUrl(state.last.camId);
            state.last.wrtcUrl = url; state.last.ttl.webrtc = ttl;
            if (state.whep) await state.whep.reconnect(url);
          } else if (kind === 'rtsp') {
            const { url, ttl } = await getPublishRtspUrl(state.last.camId);
            state.last.rtspUrl = url; state.last.ttl.rtsp = ttl;
            setRtspDisplay(url);
          }
          scheduleRefresh(kind);
        }catch(e){ console.warn('refresh failed', e); }
      }, wait);
    }

    // ===== æ’­æ”¾æ§åˆ¶ï¼ˆHLSï¼‰ =====
    function setHlsButtonPlaying(isPlaying){
      const b = $('#toggleHls');
      if (isPlaying){
        b.textContent = 'â–  åœæ­¢ HLS';
        b.classList.remove('secondary'); b.classList.add('danger');
      }else{
        b.textContent = 'â–¶ HLS';
        b.classList.remove('danger'); b.classList.add('secondary');
      }
    }

    async function getPlayHlsUrl(camId){
      const ttl = +($('#ttl').value || 60);
      const r = await api(`/camera/${camId}/play-hls-url?ttl=${ttl}`);
      if (!r.ok) throw new Error('å–å¾— HLS é€£çµå¤±æ•—');
      const j = await r.json();
      const url = j.play_hls_url || j.url || j.href;
      if (!url) throw new Error('æœªå–å¾— HLS URL');
      const out = { url, ttl: j.ttl || ttl };
      return out;
    }

    async function playHls(){
      const camId = $('#camera').value; if (!camId) return toast('è«‹å…ˆé¸æ“‡é¡é ­');
      state.last.camId = camId;

      const { url, ttl } = await getPlayHlsUrl(camId);
      state.last.hlsUrl = url; state.last.ttl.hls = ttl;

      const video = $('#video');
      if (Hls.isSupported()){
        if (state.hls) { state.hls.destroy(); state.hls = null; }
        const hls = state.hls = new Hls({ lowLatencyMode:true, backBufferLength:15, liveSyncDuration:1.5, liveMaxLatencyDuration:3, maxLiveSyncPlaybackRate:1.1 });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}) );
        hls.on(Hls.Events.ERROR, (_, data)=>{
          if (data.fatal){
            if (data.type===Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
            else if (data.type===Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
            else { hls.destroy(); setHlsButtonPlaying(false); }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')){
        video.src = url; video.play().catch(()=>{});
      } else { alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ HLS'); setHlsButtonPlaying(false); return; }

      scheduleRefresh('hls');
      setHlsButtonPlaying(true);
    }

    function stopHls(){
      if (state.hls){ state.hls.destroy(); state.hls=null; }
      const v=$('#video'); v.removeAttribute('src'); v.srcObject=null;
      clearTimer('hls');
      setHlsButtonPlaying(false);
      toast('HLS å·²åœæ­¢');
    }

    // ===== WHEP æ’­æ”¾å™¨ï¼ˆWebRTCï¼‰ =====
    class WHEPPlayer {
      constructor(videoEl){ this.video=videoEl; this.pc=null; this.remoteStream=null; }
      async start(whepUrl){ await this._connect(whepUrl); }
      async reconnect(whepUrl){ await this.stop(false); await this._connect(whepUrl); }
      async _connect(whepUrl){
        await this.stop(false);
        this.pc = new RTCPeerConnection();
        this.remoteStream = new MediaStream();
        this.video.srcObject = this.remoteStream;

        this.pc.addTransceiver('video', { direction:'recvonly' });
        this.pc.addTransceiver('audio', { direction:'recvonly' });

        this.pc.ontrack = (ev) => {
          ev.streams[0].getTracks().forEach(t => this.remoteStream.addTrack(t));
          this.video.play().catch(()=>{});
        };

        const offer = await this.pc.createOffer();
        await this.pc.setLocalDescription(offer);

        await new Promise(res=>{
          if (this.pc.iceGatheringState === 'complete') return res();
          const fn = () => { if (this.pc.iceGatheringState === 'complete'){ this.pc.removeEventListener('icegatheringstatechange', fn); res(); } };
          this.pc.addEventListener('icegatheringstatechange', fn);
        });

        const r = await fetch(whepUrl, { method:'POST', headers:{'Content-Type':'application/sdp'}, body:this.pc.localDescription.sdp });
        if (!r.ok) throw new Error(`WHEP offer failed: ${r.status}`);
        const answerSdp = await r.text();
        await this.pc.setRemoteDescription({ type:'answer', sdp:answerSdp });
      }
      async stop(clearMedia=true){
        if (this.pc){ try{ this.pc.close(); }catch{} this.pc=null; }
        if (clearMedia && this.video){ try{ this.video.srcObject?.getTracks().forEach(t=>t.stop()); }catch{} this.video.srcObject=null; }
      }
    }

    async function getPlayWebrtcUrl(camId){
      const ttl = +($('#ttl').value || 60);
      const r = await api(`/camera/${camId}/play-webrtc-url?ttl=${ttl}`);
      if (!r.ok) throw new Error('å–å¾— WebRTC é€£çµå¤±æ•—');
      const j = await r.json();
      const url = j.play_webrtc_url || j.url || j.href;
      if (!url) throw new Error('æœªå–å¾— WebRTC URL');
      return { url, ttl: j.ttl || ttl };
    }

    async function playWebrtc(){
      const camId = $('#camera').value; if (!camId) return toast('è«‹å…ˆé¸æ“‡é¡é ­');
      state.last.camId = camId;

      const { url, ttl } = await getPlayWebrtcUrl(camId);
      state.last.wrtcUrl = url; state.last.ttl.webrtc = ttl;

      if (!state.whep) state.whep = new WHEPPlayer($('#video'));
      await state.whep.start(url);
      $('#playWrtc').style.display='none'; $('#stopWrtc').style.display='inline-block';
      scheduleRefresh('webrtc');
    }
    async function stopWebrtc(){
      clearTimer('webrtc'); if (state.whep){ await state.whep.stop(); }
      $('#playWrtc').style.display='inline-block'; $('#stopWrtc').style.display='none';
      toast('WebRTC å·²åœæ­¢');
    }

    // ===== æ¨æµ RTSP =====
    function setRtspDisplay(url){ const box=$('#rtspUrl'), btn=$('#copyRtsp'); box.value=url||''; btn.disabled=!url; }

    async function getPublishRtspUrl(camId){
      const ttl = +($('#ttl').value || 60);
      const r = await api(`/camera/${camId}/publish_rtsp_url?ttl=${ttl}`);
      if (!r.ok) throw new Error('å–å¾— RTSP æ¨æµ URL å¤±æ•—');
      const j = await r.json();
      // ç«¯é» schema æœªæ˜ï¼Œç›¡é‡å…¼å®¹å‘½å
      const url = j.publish_rtsp_url || j.rtsp_url || j.url || j.href;
      if (!url) throw new Error('æœªå–å¾— RTSP æ¨æµ URL');
      return { url, ttl: j.ttl || ttl };
    }

    async function connectStream(){
      const camId = $('#camera').value; if (!camId) return toast('è«‹å…ˆé¸æ“‡é¡é ­');
      state.last.camId = camId;
      const ttl = +($('#ttl').value || 60);
      const segment_seconds = +($('#seg').value || 30);

      // 1) å»ºç«‹ä¸²æµï¼ˆå¾Œç«¯æœƒæº–å‚™æ¨/æ’­è³‡æºï¼‰
      const r = await api(`/camera/${camId}/stream/connect`, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'publish', ttl, segment_seconds })
      });
      if (!r.ok) { toast('å»ºç«‹ä¸²æµå¤±æ•—'); return; }
      // connect å›æ‡‰ç›®å‰åªæœ‰ ttl/infoï¼Œä¸å« URLã€‚

      // 2) å„è‡ªç´¢å– URL
      try{
        const { url: rtspUrl, ttl: rtspTtl } = await getPublishRtspUrl(camId);
        state.last.rtspUrl = rtspUrl; state.last.ttl.rtsp = rtspTtl; setRtspDisplay(rtspUrl);
      }catch(e){ console.warn(e); }

      try{
        const { url: hlsUrl, ttl: hlsTtl } = await getPlayHlsUrl(camId);
        state.last.hlsUrl = hlsUrl; state.last.ttl.hls = hlsTtl;
      }catch(e){ console.warn(e); }

      try{
        const { url: wrtcUrl, ttl: wrtcTtl } = await getPlayWebrtcUrl(camId);
        state.last.wrtcUrl = wrtcUrl; state.last.ttl.webrtc = wrtcTtl;
      }catch(e){ console.warn(e); }

      // 3) å•Ÿå‹•çºŒæœŸ
      scheduleRefresh('rtsp'); scheduleRefresh('hls'); scheduleRefresh('webrtc');
      toast('ä¸²æµå·²å»ºç«‹');
    }

    // ===== Auth =====
    async function doRegister(e){
      e?.preventDefault?.(); $('#registerErr').textContent='';
      const form = new FormData($('#registerForm'));
      const account = form.get('account');
      const name = form.get('name');
      const gender = form.get('gender');
      const birthday = form.get('birthday');
      const phone = form.get('phone');
      const email = form.get('email');
      const password = form.get('password');
      const confirm = form.get('confirm');

      if (password !== confirm) { $('#registerErr').textContent = 'å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´'; return; }
      if (password.length < 6) { $('#registerErr').textContent = 'å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å­—å…ƒ'; return; }
      if (!gender) { $('#registerErr').textContent = 'è«‹é¸æ“‡æ€§åˆ¥'; return; }

      try{
        const r = await fetch(`${API_BASE}/auth/signup`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ account, name, gender, birthday, phone, email, password })
        });
        if (!r.ok) {
          const j = await r.json().catch(()=>({}));
          throw new Error(j.detail || `è¨»å†Šå¤±æ•— (${r.status})`);
        }
        const j = await r.json();
        
        // signup ç«¯é»ç›´æ¥å›å‚³ JWT token
        if (j.access_token) {
          setToken(j.access_token);
          await fetchMe();
          await loadCameras();
          closeRegister();
          toast('è¨»å†Šä¸¦ç™»å…¥æˆåŠŸï¼');
        } else {
          throw new Error('ä¼ºæœå™¨æœªå›å‚³ access_token');
        }
      }catch(err){
        $('#registerErr').textContent = err.message || String(err);
      }
    }

    async function doLogin(e){
      e?.preventDefault?.(); $('#loginErr').textContent='';
      const form = new FormData($('#loginForm'));
      const username = form.get('username'); const password = form.get('password');
      try{
        const r = await fetch(`${API_BASE}/auth/login`, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body:new URLSearchParams({ username, password }) });
        if (!r.ok) throw new Error(r.status === 401 ? 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' : `ç™»å…¥å¤±æ•—(${r.status})`);
        const j = await r.json(); if (!j.access_token) throw new Error('ä¼ºæœå™¨æœªå›å‚³ access_token');
        setToken(j.access_token); await fetchMe(); await loadCameras(); closeLogin(); toast('ç™»å…¥æˆåŠŸ');
      }catch(err){ $('#loginErr').textContent = err.message || String(err); }
    }
    function doLogout(){
      ['rtsp','hls','webrtc'].forEach(clearTimer);
      stopHls(); stopWebrtc(); setRtspDisplay('');
      clearToken(); state.user=null; updateHeader(); toast('å·²ç™»å‡º');
    }

    // ===== èŠå¤©åŠŸèƒ½ =====
    function scrollChatToBottom(){
      const cm = $('#chatMessages');
      if (!cm) return;
      // å–®ä¸€æ²å‹•ä¾†æºï¼šå°‡æ²å‹•å®¹å™¨è¨­ç‚ºæœ€å¤§é«˜åº¦
      cm.scrollTop = cm.scrollHeight;
    }

    // ä»»ä½•æœƒå½±éŸ¿èŠå¤©è¦–åœ–çš„äº‹ä»¶ï¼Œéƒ½æ‡‰å‘¼å«æ­¤å‡½æ•¸
    function hookChatAutoScroll(){
      // 1) é ç±¤åˆ‡æ›åˆ°èŠå¤©é 
      const origSwitchPage = window.switchPage;
      window.switchPage = function(pageName){
        if (typeof origSwitchPage === 'function') origSwitchPage(pageName);
        if (pageName === 'chat') scrollChatToBottom();
      };

      // 2) ç›£è½èŠå¤©å®¹å™¨ç›´æ¥å­ç¯€é»æ–°å¢/ç§»é™¤
      const cm = $('#chatMessages');
      if (cm) {
        const obs = new MutationObserver(()=> scrollChatToBottom());
        obs.observe(cm, { childList:true, subtree:false });
      }

      // 3) è¼¸å…¥æ¡†èšç„¦ï¼ˆè¡Œå‹•è£ç½®éµç›¤å½ˆå‡ºå¯èƒ½å£“ç¸®è¦–å€ï¼‰
      const input = $('#chatInput');
      if (input){
        input.addEventListener('focus', ()=> setTimeout(scrollChatToBottom, 50));
        input.addEventListener('input', ()=> requestAnimationFrame(scrollChatToBottom));
      }

      // 4) è¦–çª—å°ºå¯¸è®ŠåŒ–
      window.addEventListener('resize', ()=> setTimeout(scrollChatToBottom, 50));
    }

    function addChatMessage(content, isUser = false, events = null) {
      const chatMessages = $('#chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user' : 'ai'}`;
      
      const now = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      
      let eventsHtml = '';
      if (events && events.length > 0) {
        eventsHtml = '<div style="margin-top:12px">' + events.map(e => {
          const time = e.start_time ? new Date(e.start_time).toLocaleString('zh-TW') : 'æœªçŸ¥æ™‚é–“';
          const duration = e.duration ? `(${Math.round(e.duration)}ç§’)` : '';
          const objects = e.objects && e.objects.length > 0 ? `<br>ç‰©ä»¶: ${e.objects.join(', ')}` : '';
          return `<div class="event-item">
            <div class="event-time">${time} ${duration}</div>
            <div class="event-summary">${e.summary || 'ç„¡æè¿°'}</div>
            <div class="event-meta">
              ${e.scene ? `åœ°é»: ${e.scene}` : ''}
              ${e.action ? ` | å‹•ä½œ: ${e.action}` : ''}${objects}
            </div>
          </div>`;
        }).join('') + '</div>';
      }
      
      messageDiv.innerHTML = `
        <div class="chat-avatar">${isUser ? 'æˆ‘' : 'AI'}</div>
        <div style="flex:1">
          <div class="chat-bubble">${content.replace(/\n/g, '<br>')}${eventsHtml}</div>
          <div class="chat-time">${now}</div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      // ç¢ºä¿æ¯æ¬¡æ–°å¢è¨Šæ¯å¾Œè‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
      scrollChatToBottom();
    }
    
    async function sendChatMessage() {
      const input = $('#chatInput');
      const query = input.value.trim();
      
      if (!query) {
        toast('è«‹è¼¸å…¥å•é¡Œ');
        return;
      }
      
      if (!state.user) {
        toast('è«‹å…ˆç™»å…¥');
        showLogin();
        return;
      }
      
      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addChatMessage(query, true);
      
      // æ·»åŠ åˆ°å°è©±æ­·å²
      state.chatHistory.push({
        role: 'user',
        content: query,
        timestamp: new Date().toISOString()
      });
      
      // é™åˆ¶æ­·å²é•·åº¦ï¼ˆæœ€å¤šä¿ç•™ 10 æ¢ï¼‰
      if (state.chatHistory.length > 20) {
        state.chatHistory = state.chatHistory.slice(-20);
      }
      
      input.value = '';
      input.style.height = 'auto';
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = Date.now();
      const loadingDiv = document.createElement('div');
      loadingDiv.id = `loading-${loadingId}`;
      loadingDiv.className = 'chat-message ai';
      loadingDiv.innerHTML = `
        <div class="chat-avatar">AI</div>
        <div><div class="chat-bubble"><span class="loading">æ€è€ƒä¸­</span></div></div>
      `;
      $('#chatMessages').appendChild(loadingDiv);
      // æ–°å¢è¼‰å…¥è¨Šæ¯å¾Œï¼Œä¿æŒæ²å‹•åœ¨åº•éƒ¨
      scrollChatToBottom();
      
      try {
        const dateFrom = $('#chatDateFrom').value || undefined;
        const dateTo = $('#chatDateTo').value || undefined;
        const maxResults = parseInt($('#chatLimit').value) || 10;
        
        // æ§‹å»ºè«‹æ±‚ï¼ˆä½¿ç”¨æ–°çš„ /chat ç«¯é»ï¼‰
        const body = {
          message: query,
          history: state.chatHistory.slice(0, -1), // ä¸åŒ…å«å‰›å‰›æ·»åŠ çš„ç”¨æˆ¶è¨Šæ¯
          max_results: maxResults
        };
        
        if (dateFrom) body.date_from = dateFrom;
        if (dateTo) body.date_to = dateTo;
        
        const r = await api('/chat/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if (!r.ok) {
          const j = await r.json().catch(() => ({}));
          throw new Error(j.detail || `æŸ¥è©¢å¤±æ•— (${r.status})`);
        }
        
        const result = await r.json();
        
        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(`loading-${loadingId}`)?.remove();
        scrollChatToBottom();
        
        // é¡¯ç¤º AI å›ç­”
        const answer = result.message || 'æŸ¥è©¢å®Œæˆ';
        const events = result.events || [];
        
        // æ·»åŠ  AI å›è¦†åˆ°å°è©±æ­·å²
        state.chatHistory.push({
          role: 'assistant',
          content: answer,
          timestamp: new Date().toISOString()
        });
        
        addChatMessage(answer, false, events);
        
        // å¦‚æœæœ‰å‡½æ•¸èª¿ç”¨ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è¼¸å‡ºï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
        if (result.function_calls && result.function_calls.length > 0) {
          console.log('[Function Calls]', result.function_calls);
        }
        
      } catch (err) {
        document.getElementById(`loading-${loadingId}`)?.remove();
        scrollChatToBottom();
        
        // å¦‚æœæ˜¯ 401 éŒ¯èª¤ï¼Œæç¤ºç”¨æˆ¶é‡æ–°ç™»å…¥
        if (err.message === '401') {
          addChatMessage(`âŒ æ‚¨çš„ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥å¾Œå†è©¦`, false);
          setTimeout(() => showLogin(), 1500);
        } else {
          addChatMessage(`âŒ ${err.message || 'æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'}`, false);
        }
        
        // ç§»é™¤å¤±æ•—çš„ç”¨æˆ¶è¨Šæ¯ï¼ˆä¿æŒæ­·å²ä¸€è‡´æ€§ï¼‰
        state.chatHistory.pop();
      }
    }

    // ===== å½±ç‰‡ç®¡ç†åŠŸèƒ½ =====
    async function loadVideos(page = 1) {
      try {
        const keywords = $('#videoKeywords').value.trim();
        const dateFrom = $('#videoDateFrom').value;
        const dateTo = $('#videoDateTo').value;
        const sort = $('#videoSort').value;
        
        let url = `/recordings/?page=${page}&size=20`;
        if (keywords) url += `&keywords=${encodeURIComponent(keywords)}`;
        if (dateFrom) url += `&start_time=${dateFrom}`;
        if (dateTo) url += `&end_time=${dateTo}`;
        if (sort) url += `&sort=${sort}`;
        
        const r = await api(url);
        if (!r.ok) throw new Error('è¼‰å…¥å½±ç‰‡å¤±æ•—');
        
        const data = await r.json();
        renderVideos(data.items || []);
        renderPagination(data.total || 0, page, 20, 'videosPagination', loadVideos);
        
      } catch (err) {
        console.error('è¼‰å…¥å½±ç‰‡å¤±æ•—:', err);
        $('#videosList').innerHTML = '<div class="err">è¼‰å…¥å½±ç‰‡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      }
    }

    function renderVideos(videos) {
      const container = $('#videosList');
      if (!videos.length) {
        container.innerHTML = '<div class="err">æ²’æœ‰æ‰¾åˆ°å½±ç‰‡</div>';
        return;
      }
      
      container.innerHTML = videos.map(video => {
        const startTime = video.start_time ? new Date(video.start_time).toLocaleString('zh-TW') : 'æœªçŸ¥æ™‚é–“';
        const duration = video.duration ? `${Math.round(video.duration)}ç§’` : 'æœªçŸ¥é•·åº¦';
        const size = video.size_bytes ? `${(video.size_bytes / 1024 / 1024).toFixed(1)}MB` : 'æœªçŸ¥å¤§å°';
        
        return `
          <div class="video-card">
            <div class="video-thumbnail">
              <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
            <div class="video-info">
              <h3>å½±ç‰‡ ${video.id.slice(0, 8)}...</h3>
              <div class="video-meta">
                <span>ğŸ“… ${startTime}</span>
                <span>â±ï¸ ${duration}</span>
                <span>ğŸ’¾ ${size}</span>
              </div>
              <div class="video-meta">
                <span class="pill ${video.is_processed ? 'success' : 'secondary'}">
                  ${video.is_processed ? 'å·²è™•ç†' : 'è™•ç†ä¸­'}
                </span>
                <span class="pill ${video.upload_status === 'success' ? 'success' : 'danger'}">
                  ${video.upload_status === 'success' ? 'å·²ä¸Šå‚³' : 'ä¸Šå‚³å¤±æ•—'}
                </span>
              </div>
            </div>
            <div class="video-actions">
              <button class="btn secondary" onclick="playVideoModal('${video.id}', '${video.start_time}', '${video.duration}')">æ’­æ”¾</button>
              <button class="btn" onclick="downloadVideo('${video.id}')">ä¸‹è¼‰</button>
              <button class="btn danger" onclick="deleteVideo('${video.id}')">åˆªé™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function playVideoModal(recordingId, startTime, duration) {
      try {
        const r = await api(`/recordings/${recordingId}?ttl=300&disposition=inline`);
        if (!r.ok) throw new Error('å–å¾—æ’­æ”¾é€£çµå¤±æ•—');
        
        const data = await r.json();
        
        // æ›´æ–°æ‡¸æµ®è¦–çª—æ¨™é¡Œå’Œè³‡è¨Š
        $('#videoModalTitle').textContent = `å½±ç‰‡ ${recordingId.slice(0, 8)}...`;
        
        const startTimeStr = startTime ? new Date(startTime).toLocaleString('zh-TW') : 'æœªçŸ¥æ™‚é–“';
        const durationStr = duration ? `${Math.round(duration)}ç§’` : 'æœªçŸ¥é•·åº¦';
        
        $('#videoModalInfo').innerHTML = `
          <div class="video-meta">
            <span>ğŸ“… ${startTimeStr}</span>
            <span>â±ï¸ ${durationStr}</span>
          </div>
        `;
        
        // è¨­å®šå½±ç‰‡ä¾†æº
        const video = $('#modalVideo');
        video.src = data.url;
        video.load();
        
        // é¡¯ç¤ºæ‡¸æµ®è¦–çª—
        $('#videoModal').classList.add('show');
        document.body.style.overflow = 'hidden';
        
      } catch (err) {
        toast('æ’­æ”¾å¤±æ•—: ' + err.message);
      }
    }

    function closeVideoModal() {
      $('#videoModal').classList.remove('show');
      document.body.style.overflow = '';
      const video = $('#modalVideo');
      video.pause();
      video.src = '';
    }

    async function downloadVideo(recordingId) {
      try {
        const r = await api(`/recordings/${recordingId}?ttl=1800&disposition=attachment`);
        if (!r.ok) throw new Error('å–å¾—ä¸‹è¼‰é€£çµå¤±æ•—');
        
        const data = await r.json();
        const link = document.createElement('a');
        link.href = data.url;
        link.download = `video_${recordingId}.mp4`;
        link.click();
      } catch (err) {
        toast('ä¸‹è¼‰å¤±æ•—: ' + err.message);
      }
    }

    async function deleteVideo(recordingId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å½±ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
      
      try {
        const r = await api(`/recordings/${recordingId}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('åˆªé™¤å¤±æ•—');
        
        toast('å½±ç‰‡å·²åˆªé™¤');
        loadVideos(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
      } catch (err) {
        toast('åˆªé™¤å¤±æ•—: ' + err.message);
      }
    }

    // ===== äº‹ä»¶ç®¡ç†åŠŸèƒ½ =====
    async function loadEvents(page = 1) {
      try {
        const keywords = $('#eventKeywords').value.trim();
        const dateFrom = $('#eventDateFrom').value;
        const dateTo = $('#eventDateTo').value;
        const sort = $('#eventSort').value;
        
        let url = `/events/?page=${page}&size=20`;
        if (keywords) url += `&keywords=${encodeURIComponent(keywords)}`;
        if (dateFrom) url += `&start_time=${dateFrom}`;
        if (dateTo) url += `&end_time=${dateTo}`;
        if (sort) url += `&sort=${sort}`;
        
        const r = await api(url);
        if (!r.ok) throw new Error('è¼‰å…¥äº‹ä»¶å¤±æ•—');
        
        const data = await r.json();
        renderEvents(data.items || []);
        renderPagination(data.item_total || 0, page, 20, 'eventsPagination', loadEvents);
        
      } catch (err) {
        console.error('è¼‰å…¥äº‹ä»¶å¤±æ•—:', err);
        $('#eventsList').innerHTML = '<div class="err">è¼‰å…¥äº‹ä»¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      }
    }

    function renderEvents(events) {
      const container = $('#eventsList');
      if (!events.length) {
        container.innerHTML = '<div class="err">æ²’æœ‰æ‰¾åˆ°äº‹ä»¶</div>';
        return;
      }
      
      container.innerHTML = events.map(event => {
        const startTime = event.start_time ? new Date(event.start_time).toLocaleString('zh-TW') : 'æœªçŸ¥æ™‚é–“';
        const duration = event.duration ? `${Math.round(event.duration)}ç§’` : '';
        
        const tags = [];
        if (event.action) tags.push(`å‹•ä½œ: ${event.action}`);
        if (event.scene) tags.push(`å ´æ™¯: ${event.scene}`);
        if (event.objects && event.objects.length) tags.push(`ç‰©ä»¶: ${event.objects.join(', ')}`);
        
        return `
          <div class="event-card">
            <div class="event-header">
              <div class="event-time">${startTime}</div>
              <div class="event-duration">${duration}</div>
            </div>
            <div class="event-summary">${event.summary || 'ç„¡æè¿°'}</div>
            <div class="event-tags">
              ${tags.map(tag => `<span class="event-tag">${tag}</span>`).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== ä»»å‹™ç®¡ç†åŠŸèƒ½ =====
    async function loadJobs(page = 1) {
      try {
        const statusFilter = $('#jobStatusFilter').value;
        
        let url = `/jobs/?page=${page}&size=20`;
        if (statusFilter) url += `&status_filter=${statusFilter}`;
        
        const r = await api(url);
        if (!r.ok) {
          if (r.status === 401) {
            throw new Error('è«‹å…ˆç™»å…¥');
          }
          throw new Error('è¼‰å…¥ä»»å‹™å¤±æ•—');
        }
        
        const data = await r.json();
        renderJobs(data.items || []);
        renderPagination(data.total || 0, page, 20, 'jobsPagination', loadJobs);
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', err);
        if (err.message === 'è«‹å…ˆç™»å…¥') {
          $('#jobsList').innerHTML = '<div class="err">è«‹å…ˆç™»å…¥å¾Œå†æŸ¥çœ‹ä»»å‹™</div>';
        } else {
          $('#jobsList').innerHTML = '<div class="err">è¼‰å…¥ä»»å‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
        }
      }
    }

    function renderJobs(jobs) {
      const container = $('#jobsList');
      if (!jobs.length) {
        container.innerHTML = '<div class="err">æ²’æœ‰æ‰¾åˆ°ä»»å‹™</div>';
        return;
      }
      
      container.innerHTML = jobs.map(job => {
        const createdTime = job.created_at ? new Date(job.created_at).toLocaleString('zh-TW') : 'æœªçŸ¥æ™‚é–“';
        const duration = job.duration ? `${job.duration.toFixed(1)}ç§’` : '';
        
        let progress = 0;
        if (job.status === 'success') progress = 100;
        else if (job.status === 'processing') progress = 50;
        else if (job.status === 'failed') progress = 0;
        
        return `
          <div class="job-card">
            <div class="job-header">
              <div class="job-id">${job.job_id.slice(0, 8)}...</div>
              <div class="job-status ${job.status}">${getJobStatusText(job.status)}</div>
            </div>
            <div class="job-info">
              <div>é¡å‹: ${job.type}</div>
              <div>å»ºç«‹æ™‚é–“: ${createdTime}</div>
              ${duration ? `<div>åŸ·è¡Œæ™‚é–“: ${duration}</div>` : ''}
              ${job.error_message ? `<div style="color: #ef4444">éŒ¯èª¤: ${job.error_message}</div>` : ''}
            </div>
            <div class="job-progress">
              <div class="job-progress-bar">
                <div class="job-progress-fill" style="width: ${progress}%"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getJobStatusText(status) {
      const statusMap = {
        'pending': 'å¾…è™•ç†',
        'processing': 'è™•ç†ä¸­',
        'success': 'æˆåŠŸ',
        'failed': 'å¤±æ•—'
      };
      return statusMap[status] || status;
    }

    // ===== åˆ†é åŠŸèƒ½ =====
    function renderPagination(total, currentPage, pageSize, containerId, loadFunction) {
      const container = $(`#${containerId}`);
      if (!container) return;
      
      const totalPages = Math.ceil(total / pageSize);
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // ä¸Šä¸€é 
      html += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="${loadFunction.name}(${currentPage - 1})">ä¸Šä¸€é </button>`;
      
      // é ç¢¼
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      if (startPage > 1) {
        html += `<button onclick="${loadFunction.name}(1)">1</button>`;
        if (startPage > 2) html += '<span class="pagination-info">...</span>';
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${loadFunction.name}(${i})">${i}</button>`;
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<span class="pagination-info">...</span>';
        html += `<button onclick="${loadFunction.name}(${totalPages})">${totalPages}</button>`;
      }
      
      // ä¸‹ä¸€é 
      html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="${loadFunction.name}(${currentPage + 1})">ä¸‹ä¸€é </button>`;
      
      // é é¢è³‡è¨Š
      html += `<span class="pagination-info">ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é ï¼Œç¸½è¨ˆ ${total} é …</span>`;
      
      container.innerHTML = html;
    }

    // ===== å•Ÿå‹•èˆ‡ç¶å®š =====
    async function boot(){
      updateHeader();
      if (!getToken()){ showLogin(); return; }
      try{ await fetchMe(); await loadCameras(); }catch(e){ if (String(e.message)==='401'){ showLogin(); } }
      setHlsButtonPlaying(false);
      // å•Ÿç”¨èŠå¤©è‡ªå‹•æ²å‹•æ›é‰¤
      hookChatAutoScroll();
    }

    $('#registerBtn').onclick = showRegister;
    $('#closeRegister').onclick = closeRegister;
    $('#registerOverlay').addEventListener('click', (e)=>{ if (e.target === $('#registerOverlay')) closeRegister(); });
    $('#registerForm').addEventListener('submit', doRegister);

    $('#loginBtn').onclick = showLogin;
    $('#closeLogin').onclick = closeLogin;
    $('#overlay').addEventListener('click', (e)=>{ if (e.target === $('#overlay')) closeLogin(); });
    window.addEventListener('keydown', (e)=>{
      if (e.key==='Escape') {
        if ($('#overlay').classList.contains('show')) closeLogin();
        if ($('#registerOverlay').classList.contains('show')) closeRegister();
      }
    });
    $('#loginForm').addEventListener('submit', doLogin);

    $('#logoutBtn').onclick = doLogout;
    
    // é é¢å°èˆª
    document.querySelectorAll('.nav-item').forEach(item => {
      item.onclick = (e) => {
        e.preventDefault();
        switchPage(item.dataset.page);
      };
    });
    
    // èŠå¤©åŠŸèƒ½
    $('#chatSend').onclick = ()=> sendChatMessage();
    $('#chatInput').addEventListener('keydown', (e)=>{ 
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });
    // ç›£è½èŠå¤©å€ DOM è®ŠåŒ–ï¼šä»»ä½•æ–°å¢/ç§»é™¤ç¯€é»éƒ½è‡ªå‹•æ²åˆ°åº•ï¼ˆå·²åœ¨ hookChatAutoScroll è¨»å†Šï¼Œæ­¤è™•å¯çœç•¥ï¼‰

    // ç›£è½è¼¸å…¥å€é«˜åº¦è®ŠåŒ–ï¼Œå‹•æ…‹æ›´æ–° padding èˆ‡ scroll-margin
    try{
      const inputArea = document.querySelector('.chat-input-area');
      const updateInset = () => {
        if (!inputArea) return;
        const h = inputArea.getBoundingClientRect().height || 96;
        document.documentElement.style.setProperty('--chat-input-h', `${Math.round(h)}px`);
      };
      updateInset();
      new ResizeObserver(updateInset).observe(inputArea);
      window.addEventListener('resize', updateInset);
    }catch{}
    // è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
    $('#chatInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // æ¸…é™¤å°è©±
    $('#clearChat').onclick = () => {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
        state.chatHistory = [];
        const chatMessages = $('#chatMessages');
        // åªä¿ç•™æ­¡è¿è¨Šæ¯
        chatMessages.innerHTML = `
          <div class="chat-message ai">
            <div class="chat-avatar">AI</div>
            <div>
              <div class="chat-bubble">
                ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI ç”Ÿæ´»åŠ©æ‰‹ã€‚<br><br>
                æ‚¨å¯ä»¥å•æˆ‘ï¼š<br>
                â€¢ "æˆ‘ä»Šå¤©å¹¾é»åƒæ—©é¤ï¼Ÿ"<br>
                â€¢ "æˆ‘ä»Šå¤©å»äº†å“ªè£¡ï¼Ÿ"<br>
                â€¢ "æˆ‘åœ¨å®¢å»³åšäº†ä»€éº¼ï¼Ÿ"<br>
                â€¢ "æˆ‘ä»Šå¤©æœ‰æ•£æ­¥å—ï¼Ÿ"
              </div>
              <div class="chat-time">AI åŠ©æ‰‹</div>
            </div>
          </div>
        `;
        toast('å°è©±è¨˜éŒ„å·²æ¸…é™¤');
      }
    };
    
    $('#connect').onclick = ()=> connectStream().catch(()=>toast('å»ºç«‹ä¸²æµå¤±æ•—'));
    $('#playWrtc').onclick = ()=> playWebrtc().catch((e)=>{ console.warn(e); toast('WebRTC å¤±æ•—'); });
    $('#stopWrtc').onclick = ()=> stopWebrtc();
    $('#toggleHls').onclick = async ()=>{
      if (state.hls){ stopHls(); }
      else { await playHls().catch((e)=>{ console.warn(e); toast('æ’­æ”¾å¤±æ•—'); setHlsButtonPlaying(false); }); }
    };
    $('#copyRtsp').onclick = ()=>{ const url=$('#rtspUrl').value.trim(); if (url) copyText(url); };

    // ===== è¨­å®šé é¢åŠŸèƒ½ =====
    async function loadSettings() {
      try {
        // è¼‰å…¥ä½¿ç”¨è€…è¨­å®š
        const r = await api('/users/settings');
        if (r.ok) {
          const data = await r.json();
          const settings = data.settings || {};
          
          // å¡«å…¥ä½¿ç”¨è€…è¨­å®š
          $('#userNameInput').value = state.user?.name || '';
          $('#userEmailInput').value = settings.email || '';
          $('#userPhoneInput').value = settings.phone || '';
          $('#userTimezoneSelect').value = settings.timezone || 'Asia/Taipei';
          $('#userLanguageSelect').value = settings.language || 'zh-TW';
          
          // å¡«å…¥å…¶ä»–è¨­å®š
          $('#defaultSegmentTime').value = localStorage.getItem('defaultSegmentTime') || '60';
          $('#defaultTokenTTL').value = localStorage.getItem('defaultTokenTTL') || '300';
          $('#autoRecording').checked = localStorage.getItem('autoRecording') === 'true';
          $('#defaultVideoQuality').value = localStorage.getItem('defaultVideoQuality') || 'auto';
          $('#autoPlayVideos').checked = localStorage.getItem('autoPlayVideos') === 'true';
          $('#downloadFormat').value = localStorage.getItem('downloadFormat') || 'mp4';
          $('#defaultLLMProvider').value = settings.default_llm_provider || 'google';
          $('#defaultLLMModel').value = settings.default_llm_model || 'gemini-2.0-flash-exp';
          $('#eventSensitivity').value = localStorage.getItem('eventSensitivity') || '5';
          $('#autoGenerateSummary').checked = localStorage.getItem('autoGenerateSummary') !== 'false';
        }
      } catch (err) {
        console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', err);
        toast('è¼‰å…¥è¨­å®šå¤±æ•—');
      }
    }

    async function saveUserSettings() {
      try {
        const settings = {
          name: $('#userNameInput').value,
          email: $('#userEmailInput').value,
          phone: $('#userPhoneInput').value,
          timezone: $('#userTimezoneSelect').value,
          language: $('#userLanguageSelect').value,
          default_llm_provider: $('#defaultLLMProvider').value,
          default_llm_model: $('#defaultLLMModel').value
        };
        
        const r = await api('/users/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (r.ok) {
          toast('ä½¿ç”¨è€…è¨­å®šå·²å„²å­˜');
          // æ›´æ–°æœ¬åœ°ç‹€æ…‹
          if (state.user) {
            state.user.name = settings.name;
            updateHeader();
          }
        } else {
          throw new Error('å„²å­˜å¤±æ•—');
        }
      } catch (err) {
        toast('å„²å­˜ä½¿ç”¨è€…è¨­å®šå¤±æ•—: ' + err.message);
      }
    }

    function saveCameraSettings() {
      localStorage.setItem('defaultSegmentTime', $('#defaultSegmentTime').value);
      localStorage.setItem('defaultTokenTTL', $('#defaultTokenTTL').value);
      localStorage.setItem('autoRecording', $('#autoRecording').checked);
      toast('é¡é ­è¨­å®šå·²å„²å­˜');
    }

    function saveVideoSettings() {
      localStorage.setItem('defaultVideoQuality', $('#defaultVideoQuality').value);
      localStorage.setItem('autoPlayVideos', $('#autoPlayVideos').checked);
      localStorage.setItem('downloadFormat', $('#downloadFormat').value);
      toast('å½±ç‰‡è¨­å®šå·²å„²å­˜');
    }

    function saveAISettings() {
      localStorage.setItem('eventSensitivity', $('#eventSensitivity').value);
      localStorage.setItem('autoGenerateSummary', $('#autoGenerateSummary').checked);
      toast('AI è¨­å®šå·²å„²å­˜');
    }

    // æ–°é é¢çš„äº‹ä»¶ç¶å®š
    $('#searchVideos').onclick = () => loadVideos();
    $('#searchEvents').onclick = () => loadEvents();
    $('#refreshJobs').onclick = () => loadJobs();
    
    // è¨­å®šé é¢äº‹ä»¶ç¶å®š
    $('#saveUserSettings').onclick = saveUserSettings;
    $('#saveCameraSettings').onclick = saveCameraSettings;
    $('#saveVideoSettings').onclick = saveVideoSettings;
    $('#saveAISettings').onclick = saveAISettings;
    
    // å½±ç‰‡æ‡¸æµ®è¦–çª—äº‹ä»¶ç¶å®š
    $('#closeVideoModal').onclick = closeVideoModal;
    $('#videoModal').onclick = (e) => {
      if (e.target === $('#videoModal')) closeVideoModal();
    };
    
    // ESC éµé—œé–‰æ‡¸æµ®è¦–çª—
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if ($('#videoModal').classList.contains('show')) closeVideoModal();
      }
    });

    boot();
  </script>
</body>
</html>
