{% extends 'base.html' %}

{% block content %}
  {% include './partials/header.html'%}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/user_profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_tasks.css') }}">
  
  <!-- 訊息提示 -->
  <div id="successMessage" class="messagesuccess hidden"></div>
  <div id="errorMessage" class="messageerror hidden"></div>

  <div class="settings-container">
        <!-- 影片參數設定區塊 -->
        <section class="settings-section">
          <div class="settings-section-header">
            <h2 class="settings-section-title">影片參數設定</h2>
            <p class="settings-section-desc">配置影片處理相關的系統參數（未來會逐步增加）</p>
          </div>

          <div class="info-group">
            <form id="videoParamsForm" onsubmit="return false;">
              <label for="setting_segment_seconds">切片長度（秒）</label>
              <input id="setting_segment_seconds" type="number" min="1" max="600" step="1" placeholder="30">
              <div class="settings-note">
                <p><strong>說明：</strong>錄影時每個影片切片的長度（秒）。預設 30 秒。範圍：1-600 秒。</p>
              </div>
              <div class="button-group">
                <button id="btnLoadVideoParams" type="button" class="edit-btn">載入現有設定</button>
                <button id="btnSaveVideoParams" type="button" class="edit-btn">儲存設定</button>
              </div>
              <span class="form-hint" id="videoParamsMessage" aria-live="polite"></span>
            </form>
          </div>
        </section>

        <!-- AI 模型設定區塊（合併系統預設 Google API Key） -->
        <section class="settings-section">
          <div class="settings-section-header">
            <h2 class="settings-section-title">AI 模型設定</h2>
            <p class="settings-section-desc">配置系統預設的 AI 模型與 Google API Key</p>
          </div>

          <div class="info-group">
            <form id="modelSettingsForm" onsubmit="return false;">
              <label for="setting_llm_provider">預設 LLM 供應商</label>
              <select id="setting_llm_provider">
                <option value="google">Google (Gemini)</option>
              </select>

              <label for="setting_llm_model">預設 LLM 模型</label>
              <input id="setting_llm_model" type="text" placeholder="例如：gemini-2.5-flash-lite">

              <div class="settings-note">
                <p><strong>注意：</strong>模型設定需要 API 金鑰。請在下方配置 Google API 金鑰。</p>
              </div>

              <!-- 系統預設 Google API Key -->
              <div class="provider-config-group">
                <label for="default_google_api_key">系統預設 Google API Key</label>
                <input id="default_google_api_key" type="password" placeholder="輸入 Google API Key（輸入後會遮罩顯示）">
                <div class="settings-note">
                  <p><strong>說明：</strong>此 API Key 將作為系統預設值，供未設定個人 API Key 且未被加入黑名單的使用者使用。</p>
                </div>
              </div>

              <!-- 系統預設 AI API Key 用量限制（RPM/RPD） -->
              <div class="provider-config-group">
                <label>系統預設 API Key 使用量限制（每位使用者）</label>
                <div class="form-grid">
                  <label class="form-field">
                    <span>每分鐘請求上限（RPM）</span>
                    <input id="default_ai_key_rpm" type="number" min="1" max="300" step="1" placeholder="10">
                  </label>
                  <label class="form-field">
                    <span>每日請求上限（RPD）</span>
                    <input id="default_ai_key_rpd" type="number" min="1" max="10000" step="1" placeholder="20">
                  </label>
                </div>
                <div class="settings-note">
                  <p><strong>說明：</strong>僅針對「使用系統預設 API Key」的使用者進行限制（使用者自帶 API Key 不套用）。</p>
                </div>
              </div>

              <div class="button-group">
                <button id="btnLoadDefaultApiKey" type="button" class="edit-btn">載入現有設定</button>
                <button id="btnSaveModelSettings" type="button" class="edit-btn">儲存設定</button>
              </div>
              <span class="form-hint" id="modelSettingsMessage" aria-live="polite"></span>
            </form>

            <!-- API Key 黑名單管理 -->
            <div class="settings-subsection">
              <h3 class="settings-subsection-title">API Key 黑名單管理</h3>
              <p class="settings-section-desc">管理禁止使用預設 API Key 的使用者列表</p>

              <div class="form-grid">
                <label class="form-field">
                  <span>使用者 ID *</span>
                  <input type="number" id="blacklistUserId" placeholder="輸入使用者 ID" min="1">
                </label>
                <label class="form-field">
                  <span>禁止原因（選填）</span>
                  <input type="text" id="blacklistReason" placeholder="輸入禁止原因">
                </label>
              </div>

              <div class="button-group">
                <button id="btnAddToBlacklist" class="edit-btn">添加到黑名單</button>
              </div>
              <span class="form-hint" id="blacklistMessage" aria-live="polite"></span>

              <div id="blacklistTable" class="admin-table-container" aria-live="polite">
                <div class="table-responsive">
                  <table class="table table-striped table-hover table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">使用者 ID</th>
                        <th scope="col">帳號</th>
                        <th scope="col">姓名</th>
                        <th scope="col">禁止原因</th>
                        <th scope="col">加入時間</th>
                        <th scope="col">操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" class="text-center">載入中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- M2M API Key 管理區塊 -->
        <section class="settings-section">
          <div class="settings-section-header">
            <h2 class="settings-section-title">M2M API Key 管理</h2>
            <p class="settings-section-desc">管理機器對機器（M2M）API Key，用於服務間通信</p>
          </div>

          <div class="info-group">
            <!-- 建立新 API Key 表單 -->
            <form id="apiKeyForm" class="admin-form">
              <div class="form-grid">
                <label class="form-field">
                  <span>API Key 名稱 *</span>
                  <input type="text" id="apiKeyName" required placeholder="例如：Compute Server Key">
                </label>
                <label class="form-field">
                  <span>擁有者 ID *</span>
                  <input type="number" id="apiKeyOwner" required placeholder="使用者 ID" min="1">
                </label>
              </div>

              <div class="form-grid">
                <label class="form-field">
                  <span>速率限制（每分鐘）</span>
                  <input type="number" id="apiKeyRate" placeholder="選填，例如：100" min="1">
                </label>
                <label class="form-field">
                  <span>每日配額</span>
                  <input type="number" id="apiKeyQuota" placeholder="選填，例如：10000" min="1">
                </label>
              </div>

              <div class="form-field">
                <span>作用域 (Scopes) *</span>
                <div id="apiKeyScopes" class="scopes-checkbox-group">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="uploader" id="scope-uploader">
                    <label class="form-check-label" for="scope-uploader">
                      uploader - 允許呼叫 /jobs 建任務
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="compute" id="scope-compute">
                    <label class="form-check-label" for="scope-compute">
                      compute - 允許呼叫 /jobs/{id}/complete 回報
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="mediamtx" id="scope-mediamtx">
                    <label class="form-check-label" for="scope-mediamtx">
                      mediamtx - 允許呼叫 /m2m/streams/auth
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="streaming" id="scope-streaming">
                    <label class="form-check-label" for="scope-streaming">
                      streaming - 允許呼叫 /m2m/streams
                    </label>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn primary">建立 API Key</button>
                <span class="form-hint" id="apiKeyTokenMessage" aria-live="polite"></span>
              </div>
            </form>

            <!-- API Key 列表表格 -->
            <div id="apiKeyTable" class="admin-table-container" aria-live="polite">
              <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">名稱</th>
                      <th scope="col">OID</th>
                      <th scope="col">狀態</th>
                      <th scope="col">作用域</th>
                      <th scope="col">速率限制</th>
                      <th scope="col">每日配額</th>
                      <th scope="col">建立時間</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="7" class="text-center">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 編輯 API Key 對話框 -->
        <div class="modal-overlay" id="editApiKeyDialog">
          <div class="modal-container">
            <div class="modal-header">
              <h3>編輯 API Key</h3>
              <span class="modal-close" id="closeEditApiKeyDialog">&times;</span>
            </div>
            <div class="modal-body">
              <form id="editApiKeyForm" class="admin-form">
                <label class="form-field">
                  <span>API Key 名稱 *</span>
                  <input type="text" id="editApiKeyName" required>
                </label>
                <div class="form-grid">
                  <label class="form-field">
                    <span>速率限制（每分鐘）</span>
                    <input type="number" id="editApiKeyRate" placeholder="選填" min="1">
                  </label>
                  <label class="form-field">
                    <span>每日配額</span>
                    <input type="number" id="editApiKeyQuota" placeholder="選填" min="1">
                  </label>
                </div>
                <div class="form-field">
                  <span>作用域 (Scopes) *</span>
                  <div id="editApiKeyScopes" class="scopes-checkbox-group">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="uploader" id="edit-scope-uploader">
                      <label class="form-check-label" for="edit-scope-uploader">
                        uploader - 允許呼叫 /jobs 建任務
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="compute" id="edit-scope-compute">
                      <label class="form-check-label" for="edit-scope-compute">
                        compute - 允許呼叫 /jobs/{id}/complete 回報
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="mediamtx" id="edit-scope-mediamtx">
                      <label class="form-check-label" for="edit-scope-mediamtx">
                        mediamtx - 允許呼叫 /m2m/streams/auth
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="streaming" id="edit-scope-streaming">
                      <label class="form-check-label" for="edit-scope-streaming">
                        streaming - 允許呼叫 /m2m/streams
                      </label>
                    </div>
                  </div>
                </div>
                <div class="form-actions">
                  <button type="submit" id="btnSubmitEditApiKey" class="btn primary">儲存變更</button>
                  <button type="button" id="btnRotateApiKey" class="btn-secondary">旋轉</button>
                  <button type="button" id="btnDeleteApiKey" class="btn-danger">刪除</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- 設定頁面底部：登出按鈕（手機模式方便操作） -->
      <div class="settings-logout">
        <button type="button" class="danger" id="logoutbtn_settings">登出</button>
      </div>

  <script type="module" src="{{ url_for('static', filename='js/admin_settings.js') }}"></script>
{% endblock %}
