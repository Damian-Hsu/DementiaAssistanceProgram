# LifeLog.ai æŠ€è¡“è¦æ ¼æ–‡ä»¶

## 1. ç³»çµ±æ¦‚è¿°

**LifeLog.ai** æ˜¯ä¸€å¥—ä»¥ã€ŒAI è‡ªå‹•ç´€éŒ„ç”Ÿæ´»ç‰‡æ®µä¸¦ç”Ÿæˆå€‹äººåŒ–æ—¥èªŒèˆ‡çŸ­å½±ç‰‡ã€ç‚ºæ ¸å¿ƒçš„æ™ºæ…§ç³»çµ±ã€‚ç³»çµ±é€éæ”å½±é¡é ­è‡ªå‹•æ•æ‰æ—¥å¸¸ç•«é¢ï¼Œåˆ©ç”¨ AI é€²è¡Œäº‹ä»¶åµæ¸¬ã€ç”Ÿæˆæ—¥èªŒæ‘˜è¦ã€å‰ªè¼¯ç²¾è¯çŸ­ç‰‡ï¼Œä¸¦æ”¯æ´è‡ªç„¶èªè¨€æŸ¥è©¢ã€‚

### 1.1 ç”¢å“ç‰¹è‰²

| åŠŸèƒ½é¢ | èªªæ˜ |
| --- | --- |
| **è‡ªå‹•éŒ„å½±èˆ‡äº‹ä»¶åµæ¸¬** | ç³»çµ±å¯é€éæ”å½±é¡é ­ï¼ˆå¦‚ç©¿æˆ´å¼ã€å›ºå®šå¼æˆ– RTSP ä¸²æµä¾†æºï¼‰è‡ªå‹•ç´€éŒ„ç”Ÿæ´»ç‰‡æ®µï¼Œç„¡éœ€æ‰‹æŒæ‰‹æ©Ÿã€‚ |
| **AI åˆ†é¡èˆ‡äº‹ä»¶æ‘˜è¦** | ä»¥ OpenCV / BLIP / Gemini æ¨¡å‹åˆ†æå½±ç‰‡å…§å®¹ï¼Œè‡ªå‹•åˆ‡å‡ºå…·æœ‰æ´»å‹•æ„ç¾©çš„ç‰‡æ®µï¼ˆåƒé£¯ã€å‡ºé–€ã€éŠç©ã€äº¤è«‡ç­‰ï¼‰ã€‚ |
| **AI æ–‡å­—æ—¥èªŒç”Ÿæˆ** | åˆ©ç”¨è‡ªç„¶èªè¨€æ¨¡å‹è‡ªå‹•ç”Ÿæˆç•¶æ—¥ç”Ÿæ´»æ—¥èªŒæ‘˜è¦ï¼Œè¨˜éŒ„ã€Œå¹¾é»å¹¾åˆ†åšäº†ä»€éº¼ã€ã€‚ |
| **Vlog è‡ªå‹•ç”Ÿæˆï¼ˆå›æ†¶çŸ­ç‰‡ï¼‰** | ç³»çµ±æ¯æ—¥è‡ªå‹•ç”Ÿæˆä¸€æ®µ 30 ç§’çš„ã€Œç”Ÿæ´»ç²¾è¯çŸ­ç‰‡ã€ï¼Œå¯é™„å­—å¹•èˆ‡èƒŒæ™¯éŸ³æ¨‚ã€‚ |
| **è‡ªç„¶èªè¨€å½±ç‰‡æŸ¥è©¢** | ä½¿ç”¨è€…å¯é€éèªéŸ³æˆ–æ–‡å­—æŸ¥è©¢ï¼šã€Œæˆ‘ä»Šå¤©å¹¾é»åœ¨æµ·é‚Šï¼Ÿã€â†’ ç³»çµ±å®šä½å°æ‡‰ç‰‡æ®µèˆ‡æ™‚é–“ã€‚ |
| **å½±ç‰‡ä¸‹è¼‰èˆ‡è¼•é‡å‰ªè¼¯** | æä¾›ä¸‹è¼‰å›é¡§çŸ­ç‰‡èˆ‡ç°¡æ˜“ç·¨è¼¯åŠŸèƒ½ï¼ˆè£åˆ‡ã€èª¿é€Ÿã€åŠ éŸ³æ¨‚ï¼‰ã€‚ |
| **é›²ç«¯åª’é«”ç®¡ç†** | ç³»çµ±æ•´åˆ MinIO é€²è¡Œå½±ç‰‡ã€é—œéµå¹€èˆ‡æ—¥èªŒçš„é›²ç«¯å„²å­˜èˆ‡å¿«å–ï¼Œæ”¯æ´å€‹äººå¸³è™Ÿå­˜å–ã€‚ |

### 1.2 å°ˆæ¡ˆç¯„åœ

| ç¯„åœå…§ | ç¯„åœå¤– |
| --- | --- |
| å–®ä¸€ä½¿ç”¨è€…ï¼ˆå€‹äººï¼‰ç”Ÿæ´»ç´€éŒ„ | å¤šäººå…±äº«æˆ–ç¤¾ç¾¤å¹³å°åŠŸèƒ½ |
| å–®é¡é ­ä¾†æºï¼ˆå¯æ¨¡æ“¬ RTSPï¼‰ | å¤šæ”å½±æ©Ÿæ•´åˆèˆ‡é ç«¯ç›£æ§ |
| AI åˆ†é¡èˆ‡æ–‡å­—æ‘˜è¦ | é«˜ç²¾åº¦è¡Œç‚ºè¾¨è­˜ã€é†«ç™‚ç”¨é€” |
| å›æ†¶çŸ­ç‰‡è‡ªå‹•ç”Ÿæˆ | å½±ç‰‡é•·ç¯‡å‰ªè¼¯ã€æ¿¾é¡è¨­è¨ˆ |
| Web ç«¯æ‡‰ç”¨ï¼ˆFastAPIï¼‰ | æ‰‹æ©Ÿ App / ç©¿æˆ´ç¡¬é«”é–‹ç™¼ |
| å€‹äººè³‡æ–™èˆ‡é›²ç«¯å®‰å…¨æ©Ÿåˆ¶ | é†«ç™‚è³‡è¨Šå®‰å…¨æ³•è¦ï¼ˆHIPAAï¼‰ |

## 2. ç³»çµ±æ¶æ§‹

### 2.1 æ•´é«”æ¶æ§‹åœ–

```mermaid
graph TB
    User[ä½¿ç”¨è€…] --> WebUI[Web UI]
    IPCamera[IP Camera/RTSP] --> MediaMTX[MediaMTX]
    
    WebUI --> APIServer[API Server<br/>FastAPI]
    MediaMTX --> StreamingServer[Streaming Server<br/>FFmpeg + Uploader]
    
    APIServer --> PostgreSQL[(PostgreSQL)]
    APIServer --> Redis[(Redis)]
    APIServer --> MinIO[(MinIO S3)]
    
    StreamingServer --> MinIO
    StreamingServer --> APIServer
    
    APIServer --> ComputeServer[Compute Server<br/>Celery Worker]
    ComputeServer --> MinIO
    ComputeServer --> VlogGenerator[Vlog Generator]
    ComputeServer --> NLQueryEngine[NL Query Engine]
    
    style WebUI fill:#e1f5ff
    style APIServer fill:#fff4e1
    style StreamingServer fill:#ffe1f5
    style ComputeServer fill:#e1ffe1
    style VlogGenerator fill:#f5e1ff
    style NLQueryEngine fill:#ffe1e1
```

### 2.2 å¾®æœå‹™æ¶æ§‹

#### 2.2.1 APIServer (FastAPI)
- **è·è²¬**ï¼šä¸»è¦ API æœå‹™ã€ä½¿ç”¨è€…èªè­‰ã€è³‡æ–™åº«æ“ä½œã€ä»»å‹™ç®¡ç†
- **æŠ€è¡“æ£§**ï¼šFastAPI, SQLAlchemy, JWT, Pydantic
- **ç«¯å£**ï¼š30000ï¼ˆå…¬é–‹ï¼‰

#### 2.2.2 StreamingServer (FastAPI)
- **è·è²¬**ï¼šFFmpeg é€²ç¨‹ç®¡ç†ã€å½±ç‰‡åˆ†æ®µéŒ„è£½ã€æª”æ¡ˆä¸Šå‚³ã€ä»»å‹™æ’ç¨‹
- **æŠ€è¡“æ£§**ï¼šFastAPI, FFmpeg, asyncio
- **ç«¯å£**ï¼š30500ï¼ˆå…¬é–‹ï¼‰ï¼Œå…§éƒ¨ä½¿ç”¨ 30500

#### 2.2.3 ComputeServer (Celery)
- **è·è²¬**ï¼šAI æ¨¡å‹æ¨ç†ã€å½±ç‰‡åˆ†æã€äº‹ä»¶ç”Ÿæˆã€Vlog åˆæˆ
- **æŠ€è¡“æ£§**ï¼šCelery, OpenCV, BLIP, Transformers, FFmpeg
- **ä½‡åˆ—**ï¼šRedis
- **ç«¯å£**ï¼šä¸å…¬é–‹å¤–ç¶²ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼Œ30040 ä¿ç•™ï¼‰

#### 2.2.4 VlogGenerator (æ–°å¢æ¨¡çµ„)
- **è·è²¬**ï¼šè‡ªå‹•ç”Ÿæˆå›æ†¶çŸ­ç‰‡ã€å­—å¹•åˆæˆã€éŸ³æ¨‚é…æ¨‚
- **æŠ€è¡“æ£§**ï¼šFFmpeg, MoviePy, Whisper (å¯é¸)
- **æ•´åˆ**ï¼šComputeServer å…§çš„å­æ¨¡çµ„

#### 2.2.5 NLQueryEngine (æ–°å¢æ¨¡çµ„)
- **è·è²¬**ï¼šè‡ªç„¶èªè¨€æŸ¥è©¢ã€èªç¾©ç†è§£ã€äº‹ä»¶æª¢ç´¢
- **æŠ€è¡“æ£§**ï¼šLangChain, Vector DB (å¯é¸), LLM API
- **æ•´åˆ**ï¼šComputeServer æˆ– APIServer

## 3. è³‡æ–™æ¨¡å‹

### 3.1 è³‡æ–™åº« Schema

```mermaid
erDiagram
    users ||--o{ camera : owns
    users ||--o{ recordings : owns
    users ||--o{ events : owns
    users ||--o{ vlogs : owns
    users ||--o{ daily_summaries : owns
    
    camera ||--o{ recordings : records
    recordings ||--o{ events : contains
    recordings ||--o{ vlog_segments : source
    
    vlogs ||--o{ vlog_segments : composed_of
    
    users {
        int id PK
        string account
        string name
        string email
        string role
        datetime created_at
        datetime updated_at
    }
    
    camera {
        uuid id PK
        int user_id FK
        string name
        string rtsp_url
        string status
        jsonb settings
        datetime created_at
    }
    
    recordings {
        uuid id PK
        int user_id FK
        uuid camera_id FK
        string s3_key
        float duration
        bool is_processed
        bool is_embedding
        datetime start_time
        datetime end_time
        jsonb video_metadata
    }
    
    events {
        uuid id PK
        int user_id FK
        uuid recording_id FK
        string action
        string scene
        text summary
        array objects
        datetime start_time
        float duration
        datetime created_at
    }
    
    vlogs {
        uuid id PK
        int user_id FK
        string title
        string s3_key
        float duration
        string status
        jsonb metadata
        datetime target_date
        datetime created_at
    }
    
    vlog_segments {
        uuid id PK
        uuid vlog_id FK
        uuid recording_id FK
        uuid event_id FK
        float start_offset
        float end_offset
        int sequence_order
        jsonb effects
    }
    
    daily_summaries {
        uuid id PK
        int user_id FK
        date summary_date
        text summary_text
        jsonb statistics
        datetime created_at
    }
```

### 3.2 æ–°å¢è³‡æ–™è¡¨èªªæ˜

#### vlogs (Vlog çŸ­ç‰‡)
```sql
CREATE TABLE vlogs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
    user_id INTEGER NOT NULL REFERENCES users(id),
    title VARCHAR(255),
    s3_key TEXT NOT NULL,
    duration FLOAT,
    status VARCHAR(50) DEFAULT 'processing', -- processing, completed, failed
    metadata JSONB,
    target_date DATE, -- ç›®æ¨™æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2025-10-20ï¼‰
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_vlogs_user_date ON vlogs(user_id, target_date);
CREATE INDEX idx_vlogs_status ON vlogs(status);
```

#### vlog_segments (Vlog ç‰‡æ®µ)
```sql
CREATE TABLE vlog_segments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
    vlog_id UUID NOT NULL REFERENCES vlogs(id) ON DELETE CASCADE,
    recording_id UUID REFERENCES recordings(id),
    event_id UUID REFERENCES events(id),
    start_offset FLOAT NOT NULL, -- ç‰‡æ®µèµ·å§‹æ™‚é–“ï¼ˆç§’ï¼‰
    end_offset FLOAT NOT NULL,   -- ç‰‡æ®µçµæŸæ™‚é–“ï¼ˆç§’ï¼‰
    sequence_order INTEGER NOT NULL, -- åœ¨ vlog ä¸­çš„é †åº
    effects JSONB, -- ç‰¹æ•ˆè¨­å®šï¼ˆè½‰å ´ã€æ¿¾é¡ç­‰ï¼‰
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_vlog_segments_vlog ON vlog_segments(vlog_id, sequence_order);
```

#### daily_summaries (æ¯æ—¥ç¸½çµ)
```sql
CREATE TABLE daily_summaries (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v7(),
    user_id INTEGER NOT NULL REFERENCES users(id),
    summary_date DATE NOT NULL,
    summary_text TEXT, -- AI ç”Ÿæˆçš„æ—¥èªŒæ‘˜è¦
    statistics JSONB, -- çµ±è¨ˆè³‡æ–™ï¼ˆäº‹ä»¶æ•¸é‡ã€æ´»å‹•æ™‚é•·ç­‰ï¼‰
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, summary_date)
);
CREATE INDEX idx_daily_summaries_user_date ON daily_summaries(user_id, summary_date DESC);
```

## 4. API è¦æ ¼

### 4.1 ç¾æœ‰ API (å·²å¯¦ä½œ)

åƒè€ƒ `services/README.md` ä¸­çš„å®Œæ•´ API æ¦‚è¦½ã€‚

### 4.2 æ–°å¢ API ç«¯é»

#### 4.2.1 Vlog ç®¡ç† API

**POST /api/v1/vlogs**
```json
// Request
{
  "title": "2025å¹´10æœˆ20æ—¥çš„ç¾å¥½ä¸€å¤©",
  "target_date": "2025-10-20",
  "mode": "auto", // auto: AIé¸æ“‡, manual: æ‰‹å‹•é¸æ“‡
  "segment_selection": [
    {
      "recording_id": "uuid",
      "event_id": "uuid",
      "start_time": 10.5,
      "end_time": 25.3
    }
  ],
  "settings": {
    "target_duration": 30, // ç›®æ¨™ç§’æ•¸
    "music": "default", // éŸ³æ¨‚é¸æ“‡
    "transitions": "fade", // è½‰å ´æ•ˆæœ
    "include_subtitles": true
  }
}

// Response
{
  "vlog_id": "uuid",
  "status": "processing",
  "estimated_time": 60,
  "message": "Vlog ç”Ÿæˆä»»å‹™å·²å»ºç«‹"
}
```

**GET /api/v1/vlogs**
```json
// Query Parameters
// ?user_id=1&page=1&size=20&status=completed&date_from=2025-10-01&date_to=2025-10-31

// Response
{
  "items": [
    {
      "id": "uuid",
      "title": "2025å¹´10æœˆ20æ—¥çš„ç¾å¥½ä¸€å¤©",
      "target_date": "2025-10-20",
      "duration": 30.5,
      "status": "completed",
      "thumbnail_url": "https://...",
      "download_url": "https://...",
      "created_at": "2025-10-20T10:30:00Z"
    }
  ],
  "total": 15,
  "page": 1,
  "size": 20
}
```

**GET /api/v1/vlogs/{vlog_id}**
```json
// Response
{
  "id": "uuid",
  "title": "2025å¹´10æœˆ20æ—¥çš„ç¾å¥½ä¸€å¤©",
  "target_date": "2025-10-20",
  "duration": 30.5,
  "status": "completed",
  "s3_key": "vlogs/user_1/2025-10-20.mp4",
  "download_url": "https://minio.../presigned_url",
  "segments": [
    {
      "id": "uuid",
      "recording_id": "uuid",
      "event_id": "uuid",
      "start_offset": 0,
      "end_offset": 10.2,
      "sequence_order": 1
    }
  ],
  "metadata": {
    "total_segments": 3,
    "music": "default",
    "transitions": "fade"
  },
  "created_at": "2025-10-20T10:30:00Z"
}
```

**DELETE /api/v1/vlogs/{vlog_id}**
```json
// Response
{
  "ok": true,
  "message": "Vlog å·²åˆªé™¤"
}
```

#### 4.2.2 æ¯æ—¥ç¸½çµ API

**POST /api/v1/daily-summaries/generate**
```json
// Request
{
  "user_id": 1,
  "target_date": "2025-10-20"
}

// Response
{
  "summary_id": "uuid",
  "status": "processing",
  "message": "æ—¥èªŒç”Ÿæˆä¸­"
}
```

**GET /api/v1/daily-summaries**
```json
// Query Parameters
// ?user_id=1&date_from=2025-10-01&date_to=2025-10-31&page=1&size=20

// Response
{
  "items": [
    {
      "id": "uuid",
      "summary_date": "2025-10-20",
      "summary_text": "ä»Šå¤©æ—©ä¸Š8é»åœ¨å»šæˆ¿åƒæ—©é¤ï¼Œ9é»å‡ºé–€åˆ°å…¬åœ’æ•£æ­¥ï¼Œä¸­åˆ12é»åœ¨é¤å»³ç”¨é¤...",
      "statistics": {
        "total_events": 12,
        "active_hours": 8.5,
        "scenes": {
          "å»šæˆ¿": 3,
          "å®¢å»³": 5,
          "å®¤å¤–": 4
        },
        "actions": {
          "åƒé£¯": 3,
          "æ•£æ­¥": 2,
          "é–±è®€": 1
        }
      },
      "created_at": "2025-10-20T23:00:00Z"
    }
  ],
  "total": 30,
  "page": 1,
  "size": 20
}
```

**GET /api/v1/daily-summaries/{date}**
```json
// Response
{
  "id": "uuid",
  "user_id": 1,
  "summary_date": "2025-10-20",
  "summary_text": "ä»Šå¤©æ—©ä¸Š8é»åœ¨å»šæˆ¿åƒæ—©é¤...",
  "statistics": { /* è©³ç´°çµ±è¨ˆ */ },
  "events": [
    {
      "time": "08:00",
      "action": "åƒæ—©é¤",
      "scene": "å»šæˆ¿",
      "duration": 15
    }
  ],
  "created_at": "2025-10-20T23:00:00Z"
}
```

#### 4.2.3 è‡ªç„¶èªè¨€æŸ¥è©¢ API

**POST /api/v1/query/natural-language**
```json
// Request
{
  "user_id": 1,
  "query": "æˆ‘ä»Šå¤©å¹¾é»åœ¨æµ·é‚Šï¼Ÿ",
  "context": {
    "date_range": {
      "from": "2025-10-20",
      "to": "2025-10-20"
    }
  }
}

// Response
{
  "query": "æˆ‘ä»Šå¤©å¹¾é»åœ¨æµ·é‚Šï¼Ÿ",
  "interpretation": {
    "intent": "location_time_query",
    "entities": {
      "location": "æµ·é‚Š",
      "time": "ä»Šå¤©"
    }
  },
  "results": [
    {
      "event_id": "uuid",
      "recording_id": "uuid",
      "start_time": "2025-10-20T14:30:00Z",
      "end_time": "2025-10-20T15:45:00Z",
      "summary": "åœ¨æµ·é‚Šæ•£æ­¥ä¸¦æ‹ç…§",
      "scene": "å®¤å¤–",
      "confidence": 0.95,
      "video_url": "https://..."
    }
  ],
  "answer": "æ ¹æ“šè¨˜éŒ„ï¼Œæ‚¨ä»Šå¤©ä¸‹åˆ2é»30åˆ†åˆ°3é»45åˆ†åœ¨æµ·é‚Šæ´»å‹•ã€‚"
}
```

**GET /api/v1/query/suggestions**
```json
// Query Parameters
// ?user_id=1&date=2025-10-20

// Response
{
  "suggestions": [
    "æˆ‘ä»Šå¤©å¹¾é»åƒæ—©é¤ï¼Ÿ",
    "ä»Šå¤©å»äº†å“ªäº›åœ°æ–¹ï¼Ÿ",
    "ä»Šå¤©åšäº†ä»€éº¼æ´»å‹•ï¼Ÿ",
    "æˆ‘ä»Šå¤©åœ¨å®¢å»³å¾…äº†å¤šä¹…ï¼Ÿ"
  ]
}
```

## 5. æ ¸å¿ƒæ¨¡çµ„è¨­è¨ˆ

### 5.1 Vlog Generator (å½±ç‰‡åˆæˆå¼•æ“)

#### 5.1.1 æ¨¡çµ„æ¶æ§‹

```mermaid
graph LR
    A[Vlog Request] --> B[Segment Selector]
    B --> C{Mode?}
    C -->|Auto| D[AI Selection]
    C -->|Manual| E[User Selection]
    D --> F[Segment Collector]
    E --> F
    F --> G[Video Downloader]
    G --> H[Video Merger]
    H --> I[Effects Processor]
    I --> J[Audio Mixer]
    J --> K[Subtitle Generator]
    K --> L[Final Encoder]
    L --> M[Upload to MinIO]
    M --> N[Update DB]
```

#### 5.1.2 AI ç‰‡æ®µé¸æ“‡ç­–ç•¥

```python
class VlogSegmentSelector:
    """
    AI è‡ªå‹•é¸æ“‡ç²¾è¯ç‰‡æ®µ
    """
    def select_highlights(self, events: List[Event], target_duration: int) -> List[Segment]:
        """
        é¸æ“‡ç­–ç•¥ï¼š
        1. å„ªå…ˆé¸æ“‡å¤šæ¨£åŒ–å ´æ™¯ï¼ˆé¿å…é‡è¤‡ï¼‰
        2. å„ªå…ˆé¸æ“‡é¡¯è‘—å‹•ä½œï¼ˆåƒé£¯ã€å‡ºé–€ã€æ´»å‹•ï¼‰
        3. è€ƒæ…®æ™‚é–“åˆ†å¸ƒï¼ˆæ—©ä¸­æ™šå‡å‹»ï¼‰
        4. é¿å…æ¨¡ç³Šæˆ–éœæ…‹ç•«é¢
        5. ç¸½æ™‚é•·æ§åˆ¶åœ¨ç›®æ¨™ç§’æ•¸
        """
        scored_events = []
        for event in events:
            score = self._calculate_score(event)
            scored_events.append((event, score))
        
        # æ’åºä¸¦é¸æ“‡
        sorted_events = sorted(scored_events, key=lambda x: x[1], reverse=True)
        
        # å‹•æ…‹è¦åŠƒé¸æ“‡æœ€ä½³çµ„åˆ
        selected = self._optimize_selection(sorted_events, target_duration)
        return selected
    
    def _calculate_score(self, event: Event) -> float:
        """è¨ˆç®—äº‹ä»¶åˆ†æ•¸"""
        score = 0.0
        
        # å ´æ™¯å¤šæ¨£æ€§ (10åˆ†)
        scene_diversity = self._scene_diversity_score(event.scene)
        score += scene_diversity * 10
        
        # å‹•ä½œé¡¯è‘—æ€§ (15åˆ†)
        action_significance = self._action_significance_score(event.action)
        score += action_significance * 15
        
        # æ™‚é•·é©ç•¶æ€§ (5åˆ†)
        duration_score = self._duration_score(event.duration)
        score += duration_score * 5
        
        # ç•«é¢å“è³ª (10åˆ†)
        if hasattr(event, 'quality_metrics'):
            quality = event.quality_metrics.get('blur_score', 0.5)
            score += (1 - quality) * 10
        
        return score
```

#### 5.1.3 å½±ç‰‡åˆæˆæµç¨‹

```python
class VlogGenerator:
    """
    Vlog å½±ç‰‡åˆæˆå¼•æ“
    """
    
    async def generate_vlog(self, vlog_request: VlogRequest) -> VlogResult:
        """
        å®Œæ•´çš„ Vlog ç”Ÿæˆæµç¨‹
        """
        try:
            # 1. é¸æ“‡ç‰‡æ®µ
            segments = await self._select_segments(vlog_request)
            
            # 2. ä¸‹è¼‰å½±ç‰‡ç‰‡æ®µ
            video_files = await self._download_segments(segments)
            
            # 3. å‰ªè¼¯èˆ‡åˆä½µ
            merged_video = await self._merge_videos(video_files, vlog_request.settings)
            
            # 4. æ·»åŠ è½‰å ´æ•ˆæœ
            if vlog_request.settings.transitions:
                merged_video = await self._add_transitions(merged_video)
            
            # 5. æ·»åŠ éŸ³æ¨‚
            if vlog_request.settings.music:
                merged_video = await self._add_music(merged_video)
            
            # 6. ç”Ÿæˆå­—å¹•
            if vlog_request.settings.include_subtitles:
                merged_video = await self._add_subtitles(merged_video, segments)
            
            # 7. æœ€çµ‚ç·¨ç¢¼
            final_video = await self._encode_final(merged_video)
            
            # 8. ä¸Šå‚³åˆ° MinIO
            s3_key = await self._upload_to_minio(final_video)
            
            # 9. æ›´æ–°è³‡æ–™åº«
            vlog = await self._save_to_db(vlog_request, s3_key, segments)
            
            return VlogResult(success=True, vlog=vlog)
            
        except Exception as e:
            logger.error(f"Vlog generation failed: {e}")
            return VlogResult(success=False, error=str(e))
    
    async def _merge_videos(self, video_files: List[str], settings: dict) -> str:
        """
        ä½¿ç”¨ FFmpeg åˆä½µå½±ç‰‡
        """
        concat_file = self._create_concat_file(video_files)
        output_file = f"/tmp/vlog_{uuid.uuid4()}.mp4"
        
        cmd = [
            "ffmpeg",
            "-f", "concat",
            "-safe", "0",
            "-i", concat_file,
            "-c:v", "libx264",
            "-preset", "medium",
            "-crf", "23",
            "-c:a", "aac",
            "-b:a", "128k",
            output_file
        ]
        
        await self._run_ffmpeg(cmd)
        return output_file
    
    async def _add_music(self, video_file: str, music_key: str = "default") -> str:
        """
        æ·»åŠ èƒŒæ™¯éŸ³æ¨‚
        """
        music_file = await self._get_music_file(music_key)
        output_file = f"/tmp/vlog_music_{uuid.uuid4()}.mp4"
        
        cmd = [
            "ffmpeg",
            "-i", video_file,
            "-i", music_file,
            "-filter_complex",
            "[1:a]volume=0.3[music];[0:a][music]amix=inputs=2:duration=shortest",
            "-c:v", "copy",
            "-c:a", "aac",
            output_file
        ]
        
        await self._run_ffmpeg(cmd)
        return output_file
```

### 5.2 Natural Language Query Engine (è‡ªç„¶èªè¨€æŸ¥è©¢å¼•æ“)

#### 5.2.1 æŸ¥è©¢æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant API
    participant NLEngine
    participant LLM
    participant VectorDB
    participant PostgreSQL
    
    User->>API: POST /query/natural-language
    API->>NLEngine: process_query(query, user_id)
    
    NLEngine->>LLM: è§£ææ„åœ–èˆ‡å¯¦é«”
    LLM-->>NLEngine: {intent, entities, filters}
    
    NLEngine->>VectorDB: èªç¾©æœå°‹ (å¯é¸)
    VectorDB-->>NLEngine: ç›¸é—œäº‹ä»¶
    
    NLEngine->>PostgreSQL: ç²¾ç¢ºæŸ¥è©¢
    PostgreSQL-->>NLEngine: äº‹ä»¶åˆ—è¡¨
    
    NLEngine->>LLM: ç”Ÿæˆè‡ªç„¶èªè¨€å›ç­”
    LLM-->>NLEngine: answer_text
    
    NLEngine-->>API: QueryResult
    API-->>User: JSON Response
```

#### 5.2.2 æŸ¥è©¢å¼•æ“å¯¦ä½œ

```python
class NaturalLanguageQueryEngine:
    """
    è‡ªç„¶èªè¨€æŸ¥è©¢å¼•æ“
    """
    
    def __init__(self, llm_client, db_session):
        self.llm = llm_client
        self.db = db_session
        self.intent_classifier = IntentClassifier()
    
    async def process_query(self, query: str, user_id: int, context: dict) -> QueryResult:
        """
        è™•ç†è‡ªç„¶èªè¨€æŸ¥è©¢
        """
        # 1. æ„åœ–è­˜åˆ¥èˆ‡å¯¦é«”æŠ½å–
        interpretation = await self._parse_query(query, context)
        
        # 2. æ§‹å»ºè³‡æ–™åº«æŸ¥è©¢
        db_filters = self._build_filters(interpretation, user_id)
        
        # 3. åŸ·è¡ŒæŸ¥è©¢
        events = await self._search_events(db_filters)
        
        # 4. ç”Ÿæˆè‡ªç„¶èªè¨€å›ç­”
        answer = await self._generate_answer(query, events, interpretation)
        
        return QueryResult(
            query=query,
            interpretation=interpretation,
            results=events,
            answer=answer
        )
    
    async def _parse_query(self, query: str, context: dict) -> dict:
        """
        ä½¿ç”¨ LLM è§£ææŸ¥è©¢æ„åœ–
        """
        prompt = f"""
è§£æä»¥ä¸‹è‡ªç„¶èªè¨€æŸ¥è©¢ï¼Œæå–é—œéµè³‡è¨Šï¼š

æŸ¥è©¢ï¼š"{query}"
ä¸Šä¸‹æ–‡ï¼š{json.dumps(context, ensure_ascii=False)}

è«‹ä»¥ JSON æ ¼å¼å›ç­”ï¼ŒåŒ…å«ï¼š
1. intent: æŸ¥è©¢æ„åœ–ï¼ˆtime_query, location_query, activity_query, duration_query ç­‰ï¼‰
2. entities: å¯¦é«”ï¼ˆæ™‚é–“ã€åœ°é»ã€å‹•ä½œã€å ´æ™¯ç­‰ï¼‰
3. filters: è³‡æ–™åº«æŸ¥è©¢æ¢ä»¶

ç¯„ä¾‹è¼¸å‡ºï¼š
{{
  "intent": "location_time_query",
  "entities": {{
    "location": "æµ·é‚Š",
    "time": "ä»Šå¤©",
    "date": "2025-10-20"
  }},
  "filters": {{
    "scene_keywords": ["å®¤å¤–", "æµ·é‚Š"],
    "date_range": {{"from": "2025-10-20", "to": "2025-10-20"}}
  }}
}}
"""
        
        response = await self.llm.invoke(prompt)
        return self._clean_llm_output(response)
    
    def _build_filters(self, interpretation: dict, user_id: int) -> dict:
        """
        æ ¹æ“šè§£æçµæœæ§‹å»ºè³‡æ–™åº«æŸ¥è©¢æ¢ä»¶
        """
        filters = {"user_id": user_id}
        
        entities = interpretation.get("entities", {})
        llm_filters = interpretation.get("filters", {})
        
        # æ™‚é–“ç¯„åœ
        if "date_range" in llm_filters:
            filters["start_time__gte"] = llm_filters["date_range"]["from"]
            filters["start_time__lte"] = llm_filters["date_range"]["to"]
        
        # å ´æ™¯é—œéµå­—
        if "scene_keywords" in llm_filters:
            filters["scene__in"] = llm_filters["scene_keywords"]
        
        # å‹•ä½œé—œéµå­—
        if "action_keywords" in llm_filters:
            filters["action__in"] = llm_filters["action_keywords"]
        
        # ç‰©ä»¶æœå°‹
        if "objects" in llm_filters:
            filters["objects__overlap"] = llm_filters["objects"]
        
        return filters
    
    async def _search_events(self, filters: dict) -> List[Event]:
        """
        åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢
        """
        query = self.db.query(EventsTable).filter_by(user_id=filters["user_id"])
        
        if "start_time__gte" in filters:
            query = query.filter(EventsTable.start_time >= filters["start_time__gte"])
        
        if "start_time__lte" in filters:
            query = query.filter(EventsTable.start_time <= filters["start_time__lte"])
        
        if "scene__in" in filters:
            query = query.filter(EventsTable.scene.in_(filters["scene__in"]))
        
        if "action__in" in filters:
            query = query.filter(EventsTable.action.in_(filters["action__in"]))
        
        events = query.order_by(EventsTable.start_time).all()
        return events
    
    async def _generate_answer(self, query: str, events: List[Event], interpretation: dict) -> str:
        """
        ç”Ÿæˆè‡ªç„¶èªè¨€å›ç­”
        """
        if not events:
            return "æŠ±æ­‰ï¼Œæ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„æ´»å‹•è¨˜éŒ„ã€‚"
        
        events_summary = "\n".join([
            f"- {e.start_time.strftime('%H:%M')}: {e.summary} (åœ°é»: {e.scene})"
            for e in events
        ])
        
        prompt = f"""
æ ¹æ“šä»¥ä¸‹æŸ¥è©¢å’Œæœå°‹çµæœï¼Œç”Ÿæˆè‡ªç„¶ä¸”å‹å–„çš„å›ç­”ï¼š

ä½¿ç”¨è€…æŸ¥è©¢ï¼š"{query}"
æœå°‹çµæœï¼š
{events_summary}

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦ªåˆ‡è‡ªç„¶ã€‚
"""
        
        answer = await self.llm.invoke(prompt)
        return answer.strip()
```

### 5.3 Daily Summary Generator (æ¯æ—¥ç¸½çµç”Ÿæˆå™¨)

```python
class DailySummaryGenerator:
    """
    æ¯æ—¥ç”Ÿæ´»æ—¥èªŒç”Ÿæˆå™¨
    """
    
    async def generate_daily_summary(self, user_id: int, target_date: date) -> DailySummary:
        """
        ç”ŸæˆæŒ‡å®šæ—¥æœŸçš„æ¯æ—¥ç¸½çµ
        """
        # 1. å–å¾—ç•¶æ—¥æ‰€æœ‰äº‹ä»¶
        events = await self._get_events_by_date(user_id, target_date)
        
        if not events:
            return DailySummary(
                user_id=user_id,
                summary_date=target_date,
                summary_text="ä»Šå¤©æ²’æœ‰è¨˜éŒ„åˆ°ä»»ä½•æ´»å‹•ã€‚",
                statistics={}
            )
        
        # 2. çµ±è¨ˆè³‡æ–™
        statistics = self._calculate_statistics(events)
        
        # 3. ç”Ÿæˆæ‘˜è¦æ–‡å­—
        summary_text = await self._generate_summary_text(events, statistics)
        
        # 4. å„²å­˜åˆ°è³‡æ–™åº«
        summary = await self._save_summary(user_id, target_date, summary_text, statistics)
        
        return summary
    
    def _calculate_statistics(self, events: List[Event]) -> dict:
        """
        è¨ˆç®—çµ±è¨ˆè³‡æ–™
        """
        scenes = {}
        actions = {}
        total_duration = 0
        
        for event in events:
            # å ´æ™¯çµ±è¨ˆ
            if event.scene:
                scenes[event.scene] = scenes.get(event.scene, 0) + 1
            
            # å‹•ä½œçµ±è¨ˆ
            if event.action:
                actions[event.action] = actions.get(event.action, 0) + 1
            
            # ç¸½æ™‚é•·
            if event.duration:
                total_duration += event.duration
        
        return {
            "total_events": len(events),
            "active_hours": total_duration / 3600,
            "scenes": scenes,
            "actions": actions,
            "first_activity": events[0].start_time.strftime("%H:%M") if events else None,
            "last_activity": events[-1].start_time.strftime("%H:%M") if events else None
        }
    
    async def _generate_summary_text(self, events: List[Event], statistics: dict) -> str:
        """
        ä½¿ç”¨ LLM ç”Ÿæˆæµæš¢çš„æ—¥èªŒæ‘˜è¦
        """
        events_list = [
            {
                "time": e.start_time.strftime("%H:%M"),
                "action": e.action,
                "scene": e.scene,
                "summary": e.summary
            }
            for e in events
        ]
        
        prompt = f"""
è«‹æ ¹æ“šä»¥ä¸‹æ´»å‹•è¨˜éŒ„ï¼Œç”Ÿæˆä¸€ç¯‡æµæš¢çš„ç”Ÿæ´»æ—¥èªŒæ‘˜è¦ï¼š

çµ±è¨ˆè³‡æ–™ï¼š
- ç¸½äº‹ä»¶æ•¸ï¼š{statistics['total_events']}
- æ´»å‹•æ™‚é•·ï¼š{statistics['active_hours']:.1f} å°æ™‚
- ç¬¬ä¸€å€‹æ´»å‹•ï¼š{statistics['first_activity']}
- æœ€å¾Œä¸€å€‹æ´»å‹•ï¼š{statistics['last_activity']}

è©³ç´°æ´»å‹•ï¼š
{json.dumps(events_list, ensure_ascii=False, indent=2)}

è«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«ï¼Œèªæ°£æº«æš–è¦ªåˆ‡ï¼Œåƒæ˜¯åœ¨å¯«æ—¥è¨˜ã€‚
æ‘˜è¦æ‡‰è©²åŒ…å«ï¼š
1. ä¸€å¤©çš„æ•´é«”æ¦‚æ³
2. ä¸»è¦æ´»å‹•èˆ‡æ™‚é–“
3. æ´»å‹•å ´æ‰€
4. ç°¡çŸ­çš„ç¸½çµæˆ–æ„Ÿæƒ³

ç¯„ä¾‹æ ¼å¼ï¼š
ä»Šå¤©æ—©ä¸Š8é»åœ¨å»šæˆ¿åƒæ—©é¤ï¼Œäº«å—äº†ä¸€é “è±ç››çš„æ—©é¤æ™‚å…‰ã€‚ä¸Šåˆ9é»å‡ºé–€åˆ°å…¬åœ’æ•£æ­¥ï¼Œå‘¼å¸æ–°é®®ç©ºæ°£ã€‚ä¸­åˆ12é»åœ¨é¤å»³ç”¨é¤...
"""
        
        summary = await self.llm.invoke(prompt)
        return summary.strip()
```

## 6. ä»»å‹™ä½‡åˆ—è¨­è¨ˆ

### 6.1 Celery ä»»å‹™å®šç¾©

```python
# services/ComputeServer/app/tasks/vlog_processing.py

@app.task(name="tasks.generate_vlog", bind=True)
def generate_vlog(self, vlog_request: dict):
    """
    Vlog ç”Ÿæˆä»»å‹™
    """
    generator = VlogGenerator()
    result = generator.generate_vlog(vlog_request)
    
    # å›å ±çµæœ
    response = requests.post(
        f"{API_SERVER_URL}/vlogs/{vlog_request['vlog_id']}/complete",
        headers=headers,
        json=result,
        timeout=30
    )
    return response.json()

@app.task(name="tasks.generate_daily_summary", bind=True)
def generate_daily_summary(self, request: dict):
    """
    æ¯æ—¥ç¸½çµç”Ÿæˆä»»å‹™
    """
    generator = DailySummaryGenerator()
    summary = generator.generate_daily_summary(
        user_id=request['user_id'],
        target_date=request['target_date']
    )
    
    # å„²å­˜çµæœ
    response = requests.post(
        f"{API_SERVER_URL}/daily-summaries/{request['summary_id']}/complete",
        headers=headers,
        json=summary,
        timeout=30
    )
    return response.json()
```

## 7. å‰ç«¯è¨­è¨ˆ

### 7.1 é é¢çµæ§‹

```
Web UI
â”œâ”€â”€ ç™»å…¥/è¨»å†Šé é¢
â”œâ”€â”€ å„€è¡¨æ¿ (Dashboard)
â”‚   â”œâ”€â”€ ä»Šæ—¥æ´»å‹•ç¸½è¦½
â”‚   â”œâ”€â”€ æœ€æ–°éŒ„å½±
â”‚   â””â”€â”€ æœ€æ–° Vlog
â”œâ”€â”€ æ”å½±æ©Ÿç®¡ç†
â”‚   â”œâ”€â”€ æ”å½±æ©Ÿåˆ—è¡¨
â”‚   â”œâ”€â”€ æ–°å¢æ”å½±æ©Ÿ
â”‚   â””â”€â”€ ä¸²æµæ¸¬è©¦
â”œâ”€â”€ éŒ„å½±èˆ‡äº‹ä»¶
â”‚   â”œâ”€â”€ éŒ„å½±åˆ—è¡¨ï¼ˆæ™‚é–“è»¸ï¼‰
â”‚   â”œâ”€â”€ äº‹ä»¶åˆ—è¡¨
â”‚   â””â”€â”€ å½±ç‰‡æ’­æ”¾å™¨
â”œâ”€â”€ Vlog ç®¡ç†
â”‚   â”œâ”€â”€ Vlog åˆ—è¡¨
â”‚   â”œâ”€â”€ å»ºç«‹ Vlogï¼ˆAI/æ‰‹å‹•ï¼‰
â”‚   â””â”€â”€ Vlog æ’­æ”¾èˆ‡ä¸‹è¼‰
â”œâ”€â”€ æ¯æ—¥æ—¥èªŒ
â”‚   â”œâ”€â”€ æ—¥æ›†æª¢è¦–
â”‚   â”œâ”€â”€ æ—¥èªŒè©³æƒ…
â”‚   â””â”€â”€ çµ±è¨ˆåœ–è¡¨
â””â”€â”€ è‡ªç„¶èªè¨€æŸ¥è©¢
    â”œâ”€â”€ æŸ¥è©¢ä»‹é¢
    â”œâ”€â”€ æŸ¥è©¢å»ºè­°
    â””â”€â”€ çµæœå±•ç¤º
```

### 7.2 é—œéµé é¢ Wireframe

#### 7.2.1 Vlog å»ºç«‹é é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å»ºç«‹å›æ†¶çŸ­ç‰‡                                  [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  æ—¥æœŸé¸æ“‡: [2025-10-20 â–¼]                          â”‚
â”‚                                                      â”‚
â”‚  ç‰‡æ®µé¸æ“‡æ¨¡å¼:                                       â”‚
â”‚    â—‹ AI è‡ªå‹•é¸æ“‡    â— æ‰‹å‹•é¸æ“‡                      â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å¯ç”¨ç‰‡æ®µ (å…± 12 æ®µ)               [å…¨é¸]    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â˜‘ 08:15 - 08:30  åœ¨å»šæˆ¿åƒæ—©é¤      [é è¦½]  â”‚   â”‚
â”‚  â”‚ â˜‘ 09:00 - 09:45  åœ¨å…¬åœ’æ•£æ­¥        [é è¦½]  â”‚   â”‚
â”‚  â”‚ â˜ 12:00 - 12:30  åœ¨é¤å»³ç”¨é¤        [é è¦½]  â”‚   â”‚
â”‚  â”‚ ...                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  Vlog è¨­å®š:                                          â”‚
â”‚    ç›®æ¨™æ™‚é•·: [30] ç§’                                â”‚
â”‚    èƒŒæ™¯éŸ³æ¨‚: [è¼•å¿«çš„ä¸€å¤© â–¼]                         â”‚
â”‚    è½‰å ´æ•ˆæœ: [æ·¡å…¥æ·¡å‡º â–¼]                           â”‚
â”‚    â˜‘ åŒ…å«å­—å¹•                                       â”‚
â”‚                                                      â”‚
â”‚  [å–æ¶ˆ]                           [é–‹å§‹ç”Ÿæˆ Vlog]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.2.2 è‡ªç„¶èªè¨€æŸ¥è©¢é é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ™ºæ…§æœå°‹                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æˆ‘ä»Šå¤©å¹¾é»åœ¨æµ·é‚Šï¼Ÿ                     [æœå°‹] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  å»ºè­°æŸ¥è©¢:                                           â”‚
â”‚    â€¢ æˆ‘ä»Šå¤©å¹¾é»åƒæ—©é¤ï¼Ÿ                             â”‚
â”‚    â€¢ ä»Šå¤©å»äº†å“ªäº›åœ°æ–¹ï¼Ÿ                             â”‚
â”‚    â€¢ ä»Šå¤©åœ¨å®¢å»³å¾…äº†å¤šä¹…ï¼Ÿ                           â”‚
â”‚                                                      â”‚
â”‚  æœå°‹çµæœ:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ ¹æ“šè¨˜éŒ„ï¼Œæ‚¨ä»Šå¤©ä¸‹åˆ 2:30 åˆ° 3:45 åœ¨æµ·é‚Šæ´»å‹•ã€‚â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚  ç›¸é—œç‰‡æ®µ:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“¹ 14:30 - 15:45  åœ¨æµ·é‚Šæ•£æ­¥ä¸¦æ‹ç…§          â”‚   â”‚
â”‚  â”‚    åœ°é»: å®¤å¤– | ç½®ä¿¡åº¦: 95%      [è§€çœ‹å½±ç‰‡]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 8. éƒ¨ç½²æ¶æ§‹

### 8.1 Docker Compose æœå‹™æ¸…å–®

```yaml
services:
  postgres:      # PostgreSQL è³‡æ–™åº«
  redis:         # Redis å¿«å–èˆ‡ä»»å‹™ä½‡åˆ—
  minio:         # MinIO ç‰©ä»¶å„²å­˜
  mediamtx:      # RTSP ä¸²æµè·¯ç”±å™¨
  api:           # API Server (FastAPI)
  compute:       # Compute Server (Celery)
  streaming:     # Streaming Server (FastAPI)
  webui:         # Web UI Server (æ–°å¢)
```

### 8.1.1 æœå‹™ç«¯å£é…ç½®

| æœå‹™åç¨± | å¤–éƒ¨ç«¯å£ | å…§éƒ¨ç«¯å£ | èªªæ˜ |
| --- | --- | --- | --- |
| **API Server** | 30000 | 30000 | ä¸»è¦ API æœå‹™ |
| **WebUI Server** | 30100 | 30100 | Web å‰ç«¯æœå‹™ |
| **MediaMTX** | | | |
| â””â”€ RTSP | 30201 | 8554 | RTSP ä¸²æµå”è­° |
| â””â”€ HLS | 30202 | 8888 | HLS ä¸²æµå”è­° |
| â””â”€ WebRTC | 30204 | 8889 | WebRTC ä¸²æµå”è­° |
| **MinIO** | | | |
| â””â”€ API | 30300 | 9000 | MinIO API ç«¯é» |
| â””â”€ Console | 30301 | 9001 | MinIO ç®¡ç†ä»‹é¢ |
| **Compute Server** | - | - | ä¸å…¬é–‹å¤–ç¶²ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼Œ30040 ä¿ç•™ï¼‰ |
| **Streaming Server** | 30500 | 30500 | ä¸²æµéŒ„è£½æœå‹™ |
| **Redis** | 30600 | 6379 | å¿«å–èˆ‡ä»»å‹™ä½‡åˆ—ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼‰ |
| **PostgreSQL** | 30700 | 5432 | è³‡æ–™åº«æœå‹™ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼‰ |

**æ³¨æ„äº‹é …**:
- æ‰€æœ‰æœå‹™å‡åœ¨ Docker å…§éƒ¨ç¶²çµ¡ `demo-network` ä¸­é€šä¿¡
- å¤–éƒ¨ç«¯å£æ˜ å°„åƒ…ç”¨æ–¼é–‹ç™¼å’Œæ¸¬è©¦ç’°å¢ƒ
- ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚ Nginxï¼‰çµ±ä¸€ç®¡ç†ç«¯å£

### 8.2 ç’°å¢ƒè®Šæ•¸é…ç½®

åƒè€ƒç¾æœ‰ `.env` æª”æ¡ˆï¼Œæ–°å¢ï¼š

```bash
# Vlog ç”Ÿæˆè¨­å®š
VLOG_DEFAULT_DURATION=30
VLOG_DEFAULT_MUSIC=default
VLOG_TEMP_DIR=/tmp/vlog_processing

# LLM è¨­å®š (ç”¨æ–¼è‡ªç„¶èªè¨€æŸ¥è©¢)
GOOGLE_API_KEY=your_google_api_key
LLM_MODEL=gemini-2.0-flash
LLM_TEMPERATURE=0.7

# æ¯æ—¥ç¸½çµè¨­å®š
DAILY_SUMMARY_AUTO_GENERATE=true
DAILY_SUMMARY_TIME=23:00
```

## 9. æ•ˆèƒ½æŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬é‡æ–¹æ³• |
| --- | --- | --- |
| API å›æ‡‰æ™‚é–“ | < 2 ç§’ | 95th percentile |
| å½±ç‰‡è™•ç†æˆåŠŸç‡ | â‰¥ 95% | æˆåŠŸä»»å‹™ / ç¸½ä»»å‹™ |
| Vlog ç”Ÿæˆæ™‚é–“ | < 60 ç§’ (30ç§’ç‰‡æ®µ) | å¹³å‡è™•ç†æ™‚é–“ |
| æŸ¥è©¢æº–ç¢ºç‡ | â‰¥ 85% | äººå·¥è©•ä¼° |
| ç³»çµ±å¯ç”¨æ€§ | â‰¥ 99% | Uptime monitoring |
| æ—¥èªŒå®Œæ•´æ€§ | 100% | æ‰€æœ‰æ“ä½œæœ‰æ—¥èªŒ |

## 10. å®‰å…¨æ€§è¨­è¨ˆ

### 10.1 èªè­‰èˆ‡æˆæ¬Š

- **JWT Token**ï¼šæœ‰æ•ˆæœŸ 1 å°æ™‚ï¼Œæ”¯æ´ refresh token
- **API Key**ï¼šæ”¯æ´å¤šç¨® scopeï¼ˆuploader, compute, admin ç­‰ï¼‰
- **CORS**ï¼šé™åˆ¶ä¾†æºç¶²åŸŸ
- **Rate Limiting**ï¼šé˜²æ­¢ API æ¿«ç”¨

### 10.2 è³‡æ–™å®‰å…¨

- **MinIO åŠ å¯†**ï¼šå‚³è¼¸å±¤ TLSï¼Œå¯é¸å„²å­˜å±¤åŠ å¯†
- **å¯†ç¢¼é›œæ¹Š**ï¼šbcrypt with salt
- **æ•æ„Ÿè³‡æ–™é®ç½©**ï¼šæ—¥èªŒä¸­ä¸é¡¯ç¤ºå¯†ç¢¼ã€token
- **è³‡æ–™éš”é›¢**ï¼šä½¿ç”¨è€…è³‡æ–™å®Œå…¨éš”é›¢

## 11. ç›£æ§èˆ‡æ—¥èªŒ

### 11.1 æ—¥èªŒç­–ç•¥

- **çµæ§‹åŒ–æ—¥èªŒ**ï¼šJSON æ ¼å¼ï¼ŒåŒ…å« trace_id
- **æ—¥èªŒå±¤ç´š**ï¼šDEBUG, INFO, WARNING, ERROR, CRITICAL
- **æ—¥èªŒè¼ªè½‰**ï¼šæ¯æ—¥è¼ªè½‰ï¼Œä¿ç•™ 30 å¤©
- **é›†ä¸­ç®¡ç†**ï¼šå¯é¸ Fluent-bit æ”¶é›†

### 11.2 ç›£æ§æŒ‡æ¨™

- **ç³»çµ±æŒ‡æ¨™**ï¼šCPUã€è¨˜æ†¶é«”ã€ç£ç¢Ÿä½¿ç”¨ç‡
- **æœå‹™æŒ‡æ¨™**ï¼šè«‹æ±‚æ•¸ã€éŒ¯èª¤ç‡ã€å»¶é²
- **æ¥­å‹™æŒ‡æ¨™**ï¼šå½±ç‰‡è™•ç†æ•¸ã€Vlog ç”Ÿæˆæ•¸ã€æŸ¥è©¢æ•¸
- **å¥åº·æª¢æŸ¥**ï¼šæ‰€æœ‰æœå‹™æä¾› `/healthz` ç«¯é»

## 12. æ¸¬è©¦ç­–ç•¥

### 12.1 å–®å…ƒæ¸¬è©¦

- API ç«¯é»æ¸¬è©¦
- è³‡æ–™æ¨¡å‹é©—è­‰
- æ¥­å‹™é‚è¼¯æ¸¬è©¦
- è¦†è“‹ç‡ç›®æ¨™ï¼šâ‰¥ 70%

### 12.2 æ•´åˆæ¸¬è©¦

- æœå‹™é–“é€šè¨Šæ¸¬è©¦
- è³‡æ–™åº«æ“ä½œæ¸¬è©¦
- MinIO ä¸Šå‚³ä¸‹è¼‰æ¸¬è©¦
- Celery ä»»å‹™åŸ·è¡Œæ¸¬è©¦

### 12.3 ç«¯åˆ°ç«¯æ¸¬è©¦

- å®Œæ•´æµç¨‹æ¸¬è©¦ï¼ˆéŒ„å½± â†’ åˆ†æ â†’ Vlog â†’ æŸ¥è©¢ï¼‰
- Demo å ´æ™¯æ¨¡æ“¬
- å£“åŠ›æ¸¬è©¦

## 13. æœªä¾†æ“´å……æ–¹å‘

| åŠŸèƒ½ | å„ªå…ˆç´š | èªªæ˜ |
| --- | --- | --- |
| å¤šæ”å½±æ©Ÿæ”¯æ´ | ä¸­ | æ”¯æ´å¤šå€‹ RTSP ä¾†æºæ•´åˆ |
| ç¤¾ç¾¤åˆ†äº«åŠŸèƒ½ | ä½ | Vlog åˆ†äº«åˆ°ç¤¾ç¾¤å¹³å° |
| é€²éšå½±ç‰‡ç·¨è¼¯ | ä¸­ | æ›´å¤šæ¿¾é¡ã€ç‰¹æ•ˆã€è½‰å ´ |
| èªéŸ³æŸ¥è©¢ | é«˜ | æ•´åˆèªéŸ³è¾¨è­˜ (Whisper) |
| è¡Œå‹• App | ä½ | iOS/Android æ‡‰ç”¨ |
| Vector Database | é«˜ | æ›´ç²¾ç¢ºçš„èªç¾©æœå°‹ |
| å³æ™‚æé†’ | ä¸­ | ç•°å¸¸è¡Œç‚ºå³æ™‚é€šçŸ¥ |
| å¤šèªè¨€æ”¯æ´ | ä½ | è‹±æ–‡ã€æ—¥æ–‡ç­‰ |

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-20  
**ç¶­è­·è€…**: LifeLog.ai é–‹ç™¼åœ˜éšŠ
