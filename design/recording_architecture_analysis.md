# 錄影架構問題分析

## 當前架構

### 1. 錄影流程
- **FFmpeg 切分**：每 30 秒切分成一個獨立的 MP4 檔案
  - 檔案命名：`YYYYMMDDTHHMMSSZ.mp4`（例如 `20251027T194024Z.mp4`）
  - 每個檔案都是獨立的 `recording` 記錄
  - 檔案上傳到 MinIO，s3_key 格式：`{user_id}/videos/{camera_id}/{Y}/{m}/{d}/{filename}.mp4`

### 2. 事件辨識流程
- 每個 30 秒片段被送到 ComputeServer 進行事件辨識
- 事件被存儲到 `events` 表，關聯到對應的 `recording_id`（30秒片段）
- 事件的 `start_time` 是相對於該 30 秒片段的時間（0-30秒），然後轉換為絕對時間

### 3. 資料庫結構
- `recordings` 表：每個 30 秒片段一條記錄
- `events` 表：事件關聯到 `recording_id`（30秒片段）

## 問題分析

### 核心問題
**用戶期望**：
- 看到一個「完整錄影」（例如 1 小時的連續錄影）
- 事件標示在這個完整錄影的時間軸上
- 可以播放完整錄影，並在時間軸上看到事件標記

**當前實現**：
- 每個 30 秒片段都是獨立的 recording
- 用戶看到的是很多個 30 秒的影片
- 事件雖然有絕對時間，但關聯到的是 30 秒片段，而不是完整錄影

### 邏輯紕漏

1. **缺少「錄影會話」概念**
   - 沒有將同一串流會話的多個片段組合成一個邏輯上的「完整錄影」
   - 無法知道哪些片段屬於同一個錄影會話

2. **事件關聯錯誤**
   - 事件關聯到 30 秒片段（`recording_id`）
   - 應該關聯到「錄影會話」，而不是單個片段

3. **前端展示問題**
   - 影片列表顯示的是 30 秒片段，而不是完整錄影
   - 無法播放完整錄影並在時間軸上看到事件

## 解決方案建議

### 方案 1：引入「錄影會話」概念（推薦）

**架構調整**：
1. 新增 `recording_sessions` 表：
   - `id`: UUID（主鍵）
   - `user_id`: 使用者 ID
   - `camera_id`: 攝影機 ID
   - `start_time`: 會話開始時間
   - `end_time`: 會話結束時間
   - `status`: 狀態（active, completed）

2. 修改 `recordings` 表：
   - 新增 `session_id`: UUID（外鍵，關聯到 `recording_sessions`）
   - 保留現有欄位

3. 修改 `events` 表：
   - 新增 `session_id`: UUID（外鍵，關聯到 `recording_sessions`）
   - 保留 `recording_id`（用於追蹤事件來源片段）
   - 事件的 `start_time` 相對於會話開始時間

**流程調整**：
1. 當串流開始時，創建一個新的 `recording_session`
2. 每個 30 秒片段關聯到該 `session_id`
3. 事件關聯到 `session_id`，而不是單個片段
4. 前端顯示「錄影會話」，而不是單個片段
5. 播放時，可以按順序播放該會話的所有片段

### 方案 2：改變錄影策略

**架構調整**：
1. 改變 FFmpeg 切分策略：
   - 改為按小時或更長時間段錄製
   - 減少片段數量

2. 保持現有資料庫結構

**優點**：
- 實現簡單
- 不需要修改資料庫結構

**缺點**：
- 檔案較大，上傳和處理時間長
- 如果串流中斷，可能丟失較多內容
- 不靈活

### 方案 3：後處理合併

**架構調整**：
1. 保持現有切分邏輯
2. 新增後處理任務：
   - 定期將同一會話的片段合併成完整錄影
   - 創建新的 `recording` 記錄（完整錄影）
   - 將事件重新關聯到完整錄影

**優點**：
- 保持現有切分邏輯的優點
- 可以同時保留片段和完整錄影

**缺點**：
- 需要額外的存儲空間
- 需要額外的處理時間
- 邏輯複雜

## 推薦方案

**推薦使用方案 1**，因為：
1. 符合用戶期望：看到完整錄影，事件標示在時間軸上
2. 保持現有切分邏輯的優點（上傳和處理效率）
3. 邏輯清晰，易於理解和維護
4. 可以靈活處理串流中斷和恢復的情況

## 實施步驟

1. **資料庫遷移**：
   - 創建 `recording_sessions` 表
   - 修改 `recordings` 表，新增 `session_id` 欄位
   - 修改 `events` 表，新增 `session_id` 欄位

2. **後端邏輯調整**：
   - 串流開始時創建 `recording_session`
   - 片段上傳時關聯到 `session_id`
   - 事件處理時關聯到 `session_id`

3. **前端調整**：
   - 顯示「錄影會話」列表，而不是片段列表
   - 播放時按順序播放該會話的所有片段
   - 在時間軸上顯示事件標記

