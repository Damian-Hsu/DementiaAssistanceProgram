# 2-6 使用者設定

- **功能編號**：2-6
- **功能名稱**：使用者設定
- **功能說明**：使用者設定頁提供個人資料維護（姓名/性別/生日/電話/信箱）、變更密碼，以及應用程式偏好（時區、日記自動刷新間隔、串流連結 TTL）與 AI 模型設定（是否使用系統預設 API Key、預設 LLM provider/model、Google API Key）。所有偏好設定統一存放於 users.settings（JSONB），後端會在更新 LLM 設定時清理 Chat 的模型快取，並在使用者被列入預設 key 黑名單時禁止啟用 use_default_api_key。
- **程式名稱**：services/WebUIServer/app/template/user_profile.html; services/WebUIServer/app/static/js/user_profile.js; services/WebUIServer/app/static/css/user_profile.css; services/WebUIServer/app/static/js/APIClient.js; services/WebUIServer/app/static/js/AuthService.js; services/APIServer/app/router/User/service.py; services/APIServer/app/router/User/settings.py; services/APIServer/app/router/User/DTO.py; services/APIServer/app/DataAccess/tables/users.py; services/APIServer/app/DataAccess/tables/api_key_blacklist.py; services/APIServer/app/DataAccess/tables/settings.py
- **輸入**：系統、鍵盤、滑鼠；使用者設定介面、users資料表
- **輸出**：螢幕、資料庫；使用者設定介面、users資料表

## INPUT / PROCESS / OUTPUT

| INPUT | PROCESS | OUTPUT |
|---|---|---|
| ❶ 系統載入使用者設定介面 | ❶ 載入使用者資料與設定值並填入表單。 | ❶ 顯示使用者資料與設定 |
| ❷ 滑鼠點選【儲存個人資料】 | ❷ 更新 users 資料表的個人資料欄位。 | ❷ 更新個人資料 |
| ❸ 滑鼠點選【儲存應用程式設定】 | ❸ 更新 users.settings 的應用程式設定。 | ❸ 更新使用者偏好設定 |

## 資料表

### users; api_key_blacklist; settings

| 欄位 | 中文 | 型態 | 長度 | 空值 | 預設值 | 備註 |
|---|---|---|---:|---|---|---|
| id | 使用者ID | INTEGER |  | 否 | autoincrement | users.id；Primary Key |
| account | 帳號 | VARCHAR | 50 | 否 |  | users.account（unique/index） |
| name | 姓名 | VARCHAR | 100 | 否 |  | users.name |
| gender | 性別 | ENUM |  | 否 |  | users.gender（GenderEnum） |
| birthday | 生日 | DATE |  | 否 |  | users.birthday |
| phone | 電話 | VARCHAR | 20 | 否 |  | users.phone（unique/index） |
| email | 信箱 | VARCHAR | 100 | 否 |  | users.email（unique/index） |
| password_hash | 密碼雜湊 | VARCHAR | 256 | 否 |  | users.password_hash |
| settings | 使用者設定(JSON) | JSONB |  | 是 |  | users.settings（timezone/diary_auto_refresh_interval_minutes/default_stream_ttl/default_llm_* / llm_model_api / use_default_api_key） |
| user_id | 黑名單使用者ID | INTEGER |  | 否 |  | api_key_blacklist.user_id；Primary Key；ForeignKey(users.id) |
| key | 系統設定鍵 | VARCHAR | 100 | 否 |  | settings.key（default_llm_provider/default_llm_model/default_google_api_key 等） |
| value | 系統設定值 | TEXT |  | 否 |  | settings.value（JSON 字串） |
| created_at | 建立時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 否 | timezone('UTC', now()) | TimestampMixin |
| updated_at | 更新時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 是 |  | TimestampMixin；更新時由資料庫 onupdate |
