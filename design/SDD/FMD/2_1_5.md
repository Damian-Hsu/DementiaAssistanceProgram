# 2-1-5 生成 Vlog

- **功能編號**：2-1-5
- **功能名稱**：生成 Vlog
- **功能說明**：使用者於首頁點擊「生成 Vlog」後，先在事件選擇視窗載入該日事件（可用 AI 推薦自動勾選），達到最少選取數量後進入 Vlog 設定視窗，選擇音樂片段與解析度並送出；後端驗證事件屬於使用者與日期一致後建立 vlogs 與 vlog_segments，建立 inference_jobs（vlog_generation）追蹤並派送 ComputeServer 生成任務，前端再輪詢顯示生成進度。
- **程式名稱**：services/WebUIServer/app/template/home.html; services/WebUIServer/app/static/js/vlog.js; services/WebUIServer/app/static/js/APIClient.js; services/APIServer/app/router/Vlogs/service.py; services/APIServer/app/DataAccess/tables/events.py; services/APIServer/app/DataAccess/tables/diary.py; services/APIServer/app/DataAccess/tables/vlogs.py; services/APIServer/app/DataAccess/tables/inference_jobs.py; services/APIServer/app/DataAccess/tables/music.py
- **輸入**：滑鼠、系統；Vlog介面、events資料表、music資料表
- **輸出**：螢幕、資料庫；事件選擇介面、Vlog設定介面、vlogs資料表、vlog_segments資料表

## INPUT / PROCESS / OUTPUT

| INPUT | PROCESS | OUTPUT |
|---|---|---|
| ❶ 滑鼠點選【生成Vlog】 |  | ❶ 跳出事件選擇介面 |
| ❷ 滑鼠勾選事件<br>&nbsp;&nbsp;① 【手動勾選】<br>&nbsp;&nbsp;② 【AI推薦】<br>&nbsp;&nbsp;③ 【下一步】 | ❷ 載入當日事件與音樂清單，檢查已選事件數量達門檻後進入設定流程。 | ❷ 切換至Vlog設定介面 |
| ❸ 滑鼠點選【送出生成】 | ❸ 送出生成請求，後端建立 vlogs 與 vlog_segments，並建立任務追蹤與派送生成流程。 | ❸ 建立Vlog任務資料 |

## 資料表

### events; diary; vlogs; vlog_segments; music; inference_jobs

| 欄位 | 中文 | 型態 | 長度 | 空值 | 預設值 | 備註 |
|---|---|---|---:|---|---|---|
| id | 事件ID | UUID |  | 否 | uuid7 | events.id；用於 event_ids |
| user_id | 使用者ID | INTEGER |  | 否 |  | events.user_id（權限驗證） |
| start_time | 事件開始時間 | TIMESTAMP WITH TIME ZONE |  | 是 |  | events.start_time（排序/跨日檢查） |
| duration | 事件持續秒數 | FLOAT |  | 是 |  | events.duration |
| id | VlogID | UUID |  | 否 | uuid7 | vlogs.id |
| target_date | 目標日期 | DATE |  | 否 |  | vlogs.target_date |
| status | 狀態 | VARCHAR | 50 | 否 | pending | vlogs.status |
| settings | 設定 | JSONB |  | 是 |  | vlogs.settings（max_duration/resolution/music/job_id） |
| vlog_id | VlogID | UUID |  | 否 |  | vlog_segments.vlog_id；ForeignKey(vlogs.id) |
| event_id | 事件ID | UUID |  | 是 |  | vlog_segments.event_id；ForeignKey(events.id) |
| recording_id | 錄影ID | UUID |  | 否 |  | vlog_segments.recording_id；ForeignKey(recordings.id) |
| sequence_order | 排序 | INTEGER |  | 否 |  | vlog_segments.sequence_order |
| id | 音樂ID | UUID |  | 否 | uuid7 | music.id |
| s3_key | 音樂S3路徑 | TEXT |  | 否 |  | music.s3_key |
| duration | 音樂長度 | FLOAT |  | 是 |  | music.duration |
| id | 任務ID | UUID |  | 否 | uuid7 | inference_jobs.id（vlog_generation job） |
| type | 任務類型 | VARCHAR | 128 | 否 |  | inference_jobs.type（vlog_generation） |
| status | 任務狀態 | ENUM |  | 否 | pending | inference_jobs.status |
| params | 任務參數 | JSONB |  | 是 |  | inference_jobs.params（vlog_id/user_id/event_ids/progress） |
