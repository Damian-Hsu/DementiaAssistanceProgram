# 2-1-3 生成/刷新日記

- **功能編號**：2-1-3
- **功能名稱**：生成/刷新日記
- **功能說明**：使用者於首頁點擊日記刷新按鈕後，前端以 force_refresh=true 呼叫後端日記摘要生成端點；後端依日期查詢事件、計算 events_hash，必要時呼叫 LLM 生成摘要並寫入 diary，同時建立/更新 inference_jobs（diary_generation）供管理端追蹤，並記錄 llm_usage_logs 使用量。
- **程式名稱**：services/WebUIServer/app/template/home.html; services/WebUIServer/app/static/js/diary.js; services/WebUIServer/app/static/js/APIClient.js; services/APIServer/app/router/Chat/service.py; services/APIServer/app/utils/llm_usage.py; services/APIServer/app/DataAccess/tables/diary.py; services/APIServer/app/DataAccess/tables/events.py; services/APIServer/app/DataAccess/tables/inference_jobs.py; services/APIServer/app/DataAccess/tables/llm_usage_logs.py
- **輸入**：滑鼠；日記介面、diary資料表、events資料表
- **輸出**：螢幕、資料庫；日記介面、diary資料表
- **備註**：可能受 LLM 配額影響。

## INPUT / PROCESS / OUTPUT

| INPUT | PROCESS | OUTPUT |
|---|---|---|
| ❶ 滑鼠點選【刷新日記】 | ❶ 送出日記生成/刷新請求，後端查詢 events 並生成摘要後寫入 diary 資料表。<br>&nbsp;&nbsp;① 成功：更新/新增 diary 記錄<br>&nbsp;&nbsp;② 失敗：回傳錯誤（含配額限制） | ❶ 更新日記內容 |

## 資料表

### diary; events; inference_jobs; llm_usage_logs

| 欄位 | 中文 | 型態 | 長度 | 空值 | 預設值 | 備註 |
|---|---|---|---:|---|---|---|
| id | 日記ID | UUID |  | 否 | uuid7 | diary.id；Primary Key |
| user_id | 使用者ID | INTEGER |  | 否 |  | diary.user_id；ForeignKey(users.id)；索引 |
| diary_date | 日記日期 | DATE |  | 否 |  | diary.diary_date；索引 |
| content | 日記內容 | TEXT |  | 是 |  | diary.content |
| events_hash | 事件列表雜湊 | VARCHAR | 64 | 是 |  | diary.events_hash；索引 |
| created_at | 建立時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 否 | timezone('UTC', now()) | diary.created_at；TimestampMixin |
| updated_at | 更新時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 是 |  | diary.updated_at；TimestampMixin；更新時由資料庫 onupdate |
| id | 事件ID | UUID |  | 否 | uuid7 | events.id；Primary Key |
| start_time | 事件開始時間 | TIMESTAMP WITH TIME ZONE |  | 是 |  | events.start_time（用於日期範圍查詢） |
| summary | 摘要 | TEXT |  | 是 |  | events.summary（生成日記摘要的來源之一） |
| id | 任務ID | UUID |  | 否 | uuid7 | inference_jobs.id；Primary Key |
| type | 任務類型 | VARCHAR | 128 | 否 |  | inference_jobs.type（diary_generation） |
| status | 任務狀態 | ENUM |  | 否 | pending | inference_jobs.status（JobStatusEnum） |
| input_type | 輸入類型 | VARCHAR | 128 | 否 |  | inference_jobs.input_type（diary） |
| input_url | 輸入位置 | TEXT |  | 是 |  | inference_jobs.input_url（日期字串） |
| trace_id | 追蹤ID | VARCHAR | 64 | 是 |  | inference_jobs.trace_id |
| error_message | 錯誤訊息 | TEXT |  | 是 |  | inference_jobs.error_message |
| params | 任務參數 | JSONB |  | 是 |  | inference_jobs.params（包含 user_id/diary_date/progress） |
| metrics | 任務量測 | JSONB |  | 是 |  | inference_jobs.metrics |
| created_at | 建立時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 否 | timezone('UTC', now()) | inference_jobs.created_at；TimestampMixin |
| updated_at | 更新時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 是 |  | inference_jobs.updated_at；TimestampMixin；更新時由資料庫 onupdate |
| id | 用量紀錄ID | UUID |  | 否 | uuid7 | llm_usage_logs.id；Primary Key |
| user_id | 使用者ID | INTEGER |  | 否 |  | llm_usage_logs.user_id；ForeignKey(users.id)；索引 |
| source | 來源 | VARCHAR | 32 | 否 |  | llm_usage_logs.source（diary） |
| provider | 供應商 | VARCHAR | 32 | 是 |  | llm_usage_logs.provider |
| model_name | 模型名稱 | VARCHAR | 128 | 是 |  | llm_usage_logs.model_name |
| prompt_tokens | 提示詞Token數 | INTEGER |  | 否 | 0 | llm_usage_logs.prompt_tokens |
| completion_tokens | 回覆Token數 | INTEGER |  | 否 | 0 | llm_usage_logs.completion_tokens |
| total_tokens | 總Token數 | INTEGER |  | 否 | 0 | llm_usage_logs.total_tokens |
| assistant_replies | 助手回覆次數 | INTEGER |  | 否 | 0 | llm_usage_logs.assistant_replies（日記生成不計回覆，為 0） |
| trace_id | 追蹤ID | VARCHAR | 64 | 是 |  | llm_usage_logs.trace_id |
| meta | 附加資訊 | JSONB |  | 是 |  | llm_usage_logs.meta |
| created_at | 建立時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 否 | timezone('UTC', now()) | llm_usage_logs.created_at；TimestampMixin |
| updated_at | 更新時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 是 |  | llm_usage_logs.updated_at；TimestampMixin；更新時由資料庫 onupdate |
