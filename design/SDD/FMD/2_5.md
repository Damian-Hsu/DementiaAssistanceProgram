# 2-5 AI 助手

- **功能編號**：2-5
- **功能名稱**：AI 助手
- **功能說明**：AI 助手提供聊天式介面，使用者可送出訊息並保留對話歷史（瀏覽器本機持久化），可指定查詢日期範圍；後端會依使用者時區與對話上下文呼叫 LLM，並透過 Function Calling 查詢事件/影片/日記/Vlog 等關聯資料後回傳給前端呈現；若使用系統預設 AI Key 則套用速率/日配額限制並提示用量。
- **程式名稱**：services/WebUIServer/app/template/chat.html; services/WebUIServer/app/static/js/chat.js; services/WebUIServer/app/static/css/chat.css; services/WebUIServer/app/static/js/APIClient.js; services/APIServer/app/router/Chat/service.py; services/APIServer/app/router/Chat/DTO.py; services/APIServer/app/router/Chat/llm_tools.py; services/APIServer/app/router/Chat/tools_schema.py; services/APIServer/app/router/Chat/rate_limiter.py; services/APIServer/app/DataAccess/tables/events.py; services/APIServer/app/DataAccess/tables/recordings.py; services/APIServer/app/DataAccess/tables/diary.py; services/APIServer/app/DataAccess/tables/vlogs.py; services/APIServer/app/DataAccess/tables/llm_usage_logs.py; services/APIServer/app/DataAccess/tables/settings.py; services/APIServer/app/DataAccess/tables/api_key_blacklist.py; services/APIServer/app/DataAccess/tables/users.py
- **輸入**：系統、鍵盤、滑鼠；AI助手介面、events資料表、recordings資料表、diary資料表、vlogs資料表
- **輸出**：螢幕、資料庫；AI助手介面、llm_usage_logs資料表
- **備註**：若未設定個人 key，會套用系統預設 key 的限流/配額限制。

## INPUT / PROCESS / OUTPUT

| INPUT | PROCESS | OUTPUT |
|---|---|---|
| ❶ 系統載入AI助手介面 | ❶ 載入本機對話歷史並初始化工具設定（日期範圍）。 | ❶ 顯示對話歷史 |
| ❷ 鍵盤輸入【訊息】 |  |  |
| ❸ 滑鼠點選【送出】 | ❸ 送出聊天請求並取得 AI 回覆，必要時查詢關聯資料；若觸發限制則回傳錯誤訊息。<br>&nbsp;&nbsp;① 成功：回覆文字與關聯資料<br>&nbsp;&nbsp;② 失敗：登入過期/額度限制/系統錯誤 | ❸ 顯示AI回覆與關聯資料 |

## 資料表

### events; recordings; diary; vlogs; llm_usage_logs; settings; api_key_blacklist; users

| 欄位 | 中文 | 型態 | 長度 | 空值 | 預設值 | 備註 |
|---|---|---|---:|---|---|---|
| id | 事件ID | UUID |  | 否 | uuid7 | events.id；Primary Key |
| user_id | 使用者ID | INTEGER |  | 否 |  | events.user_id / recordings.user_id / diary.user_id / vlogs.user_id / llm_usage_logs.user_id |
| recording_id | 錄影ID | UUID |  | 是 |  | events.recording_id（關聯 recordings.id） |
| action | 行為 | VARCHAR | 128 | 是 |  | events.action |
| scene | 地點 | VARCHAR | 128 | 是 |  | events.scene |
| summary | 摘要 | TEXT |  | 是 |  | events.summary（關聯資料顯示/關鍵字查詢） |
| objects | 物件清單 | ARRAY(VARCHAR) |  | 是 |  | events.objects |
| start_time | 開始時間 | TIMESTAMP WITH TIME ZONE |  | 是 |  | events.start_time / recordings.start_time（會轉換為使用者時區顯示） |
| duration | 持續秒數 | FLOAT |  | 是 |  | events.duration / recordings.duration / vlogs.duration |
| s3_key | S3 路徑 | TEXT |  | 是 |  | recordings.s3_key（必填）/ vlogs.s3_key（可選） |
| thumbnail_s3_key | 縮圖S3路徑 | TEXT |  | 是 |  | recordings.thumbnail_s3_key / vlogs.thumbnail_s3_key |
| diary_date | 日記日期 | DATE |  | 否 |  | diary.diary_date |
| content | 內容 | TEXT |  | 是 |  | diary.content |
| status | 狀態 | VARCHAR | 50 | 否 | pending | vlogs.status（pending/processing/completed/failed） |
| target_date | 目標日期 | DATE |  | 否 |  | vlogs.target_date |
| assistant_replies | AI 助手回覆次數 | INTEGER |  | 否 | 0 | llm_usage_logs.assistant_replies |
| key | 設定鍵 | VARCHAR | 100 | 否 |  | settings.key（例如 default_ai_key_limits） |
| value | 設定值 | TEXT |  | 否 |  | settings.value（JSON 字串） |
| user_id | 黑名單使用者ID | INTEGER |  | 否 |  | api_key_blacklist.user_id（Primary Key；ForeignKey(users.id)） |
| account | 帳號 | VARCHAR | 50 | 否 |  | users.account（unique/index） |
| settings | 使用者設定(JSON) | JSONB |  | 是 |  | users.settings（含時區/LLM 設定等） |
| created_at | 建立時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 否 | timezone('UTC', now()) | TimestampMixin |
| updated_at | 更新時間(UTC) | TIMESTAMP WITH TIME ZONE |  | 是 |  | TimestampMixin；更新時由資料庫 onupdate |
