# 3-2 使用者管理

- **功能編號**：3-2
- **功能名稱**：使用者管理
- **功能說明**：管理員可查看一般使用者的統計資訊（Token 使用量、聊天訊息數、是否使用系統預設 API Key、黑名單狀態），並可點擊查看單一使用者詳情、啟用/停用帳號，以及管理「預設 API Key 黑名單」（禁止該使用者使用系統預設 Google API Key；加入黑名單時會同步把 users.settings.use_default_api_key 設為 false）。
- **程式名稱**：services/WebUIServer/app/template/admin_users.html; services/WebUIServer/app/static/js/admin_users.js; services/WebUIServer/app/static/js/APIClient.js; services/APIServer/app/router/Admin/service.py; services/APIServer/app/router/Admin/DTO.py; services/APIServer/app/DataAccess/tables/users.py; services/APIServer/app/DataAccess/tables/llm_usage_logs.py; services/APIServer/app/DataAccess/tables/api_key_blacklist.py
- **輸入**：系統、滑鼠、鍵盤；管理員使用者管理介面、users資料表、api_key_blacklist資料表
- **輸出**：螢幕、資料庫；管理員使用者管理介面、users資料表、api_key_blacklist資料表
- **備註**：僅管理員可使用。

## INPUT / PROCESS / OUTPUT

| INPUT | PROCESS | OUTPUT |
|---|---|---|
| ❶ 系統載入管理員使用者管理介面 | ❶ 查詢使用者統計並顯示列表。 | ❶ 顯示使用者統計列表 |
| ❷ 滑鼠點選使用者列 | ❷ 查詢單一使用者詳情並開啟詳情視窗。 | ❷ 跳出使用者詳情視窗 |
| ❸ 滑鼠點選【儲存】 | ❸ 更新 users.active 或黑名單狀態，必要時同步停用 use_default_api_key。 | ❸ 更新使用者狀態與黑名單 |

## 資料表

### users; llm_usage_logs; api_key_blacklist

| 欄位 | 中文 | 型態 | 長度 | 空值 | 預設值 | 備註 |
|---|---|---|---:|---|---|---|
| id | 使用者ID | INTEGER |  | 否 | autoincrement | users.id |
| active | 帳號啟用 | BOOLEAN |  | 否 | True | users.active（啟用/停用） |
| settings | 使用者設定(JSON) | JSONB |  | 是 |  | users.settings.use_default_api_key |
| total_tokens | 總 Token 數 | INTEGER |  | 否 | 0 | llm_usage_logs.total_tokens（聚合 sum） |
| assistant_replies | AI 助手回覆次數 | INTEGER |  | 否 | 0 | llm_usage_logs.assistant_replies（聚合；聊天訊息數取 chat source） |
| user_id | 黑名單使用者ID | INTEGER |  | 否 |  | api_key_blacklist.user_id（Primary Key） |
| reason | 黑名單原因 | VARCHAR | 500 | 是 |  | api_key_blacklist.reason |
