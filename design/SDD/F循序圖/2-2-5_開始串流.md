# 2-2-5 開始串流

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant StreamingServer
  participant Mediamtx

  User ->> Browser: 點選【開始串流】
  Browser ->> WebUIServer: POST /bff/v1/camera/{id}/stream/connect\n{ttl}\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: POST /api/v1/camera/{id}/stream/connect

  APIServer ->> Postgres: SELECT camera WHERE id
  Postgres -->> APIServer: camera row

  alt 權限不足/鏡頭狀態非 active
    APIServer -->> WebUIServer: 403
    WebUIServer -->> Browser: 403
    Browser ->> Browser: 顯示錯誤
  else 可建立連線
    APIServer ->> APIServer: issue internal read token\n(aud=rtsp, action=read, ttl)
    APIServer ->> APIServer: build internal_rtsp_url\nrtsp://mediamtx:8554/{path}?token=...

    APIServer ->> Postgres: SELECT settings(key=video_segment_seconds)\n(若無則 fallback 30s)
    Postgres -->> APIServer: segment_seconds

    APIServer ->> StreamingServer: POST /streams/start\n{user_id,camera_id,rtsp_url,segment_seconds,...}\n(X-Internal-Token)
    StreamingServer ->> StreamingServer: 啟動 FFmpeg 拉流切片\nrecord_root/{user_id}/{camera_id}
    StreamingServer -->> APIServer: 200 {status:starting/running,...}
    APIServer -->> WebUIServer: 200 {ttl, info}
    WebUIServer -->> Browser: 200 {ttl, info}

    opt 同步取得推流 URL 供使用者複製（見 2-2-4）
      Browser ->> WebUIServer: GET /bff/v1/camera/{id}/publish_rtsp_url?ttl=...
      WebUIServer ->> APIServer: GET /api/v1/camera/{id}/publish_rtsp_url
      APIServer -->> WebUIServer: 200 {publish_rtsp_url}
      WebUIServer -->> Browser: 200 ...
      Browser ->> Browser: 顯示/複製推流連結
    end

    opt 等待狀態 running 後啟動預覽（見 2-2-7/2-2-8）
      note over Browser: 前端輪詢 stream/status\nstatus=running 時開始 WebRTC 播放
    end
  end

  opt MediaMTX 進行 read token 驗證（播放端）
    Mediamtx ->> APIServer: HTTP auth 回打 /api/v1/m2m/check-stream-pwd\n(action=read, protocol=rtsp/webrtc, path, token)
    APIServer -->> Mediamtx: 200/401
  end
```

## Mermaid 備註
- 開始串流使用 `POST /camera/{id}/stream/connect`：後端簽 internal RTSP token，並呼叫 `StreamingServer /streams/start` 啟動拉流與切片錄影。\n- 推流 URL（給外部推流端）由 `GET /camera/{id}/publish_rtsp_url` 另外取得。\n- 缺少的關鍵資訊：使用者「推流端」行為不在 participant 清單，故不畫成 lifeline；僅以 note 表示。\n+

