# 3-2-1 使用者統計

# Mermaid
```mermaid
sequenceDiagram
  actor Admin
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  Admin ->> Browser: 進入【使用者管理】頁
  Browser ->> WebUIServer: GET /admin/users
  WebUIServer -->> Browser: 200 admin_users.html + admin_users.js

  Browser ->> WebUIServer: GET /bff/v1/admin/users/stats?page={page}&size={size}
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/admin/users/stats?page={page}&size={size}

  alt 權限不足（非 admin）
    APIServer -->> WebUIServer: 403 {detail:"Admin only"}
    WebUIServer -->> Browser: 403
    Browser ->> Browser: 顯示提示並導回 /home
  else 允許
    APIServer ->> Postgres: SELECT users WHERE role=user
    Postgres -->> APIServer: users[]

    APIServer ->> Postgres: 聚合 llm_usage_logs（sum total_tokens, chat assistant replies）
    Postgres -->> APIServer: usage_map

    APIServer ->> Postgres: SELECT api_key_blacklist
    Postgres -->> APIServer: blacklisted_user_ids

    APIServer ->> APIServer: 解析 users.settings.use_default_api_key
    APIServer -->> WebUIServer: 200 [UserStatsDTO...]
    WebUIServer -->> Browser: 200
    Browser ->> Browser: 渲染使用者統計表格
  end
```

## Mermaid 備註
- API：`GET /bff/v1/admin/users/stats`。
- 聊天訊息數：後端只統計 `llm_usage_logs.source == "chat"` 的 `assistant_replies`。
- 分頁：前端目前帶 `page/size` 參數，但後端 `GET /admin/users/stats` **未實作分頁**（回傳 list）。
