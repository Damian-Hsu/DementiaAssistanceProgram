# 2-6-6 LLM 設定

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟【設定】頁（AI 模型設定區塊）
  Browser ->> WebUIServer: GET /settings
  WebUIServer -->> Browser: 200 user_profile.html + user_profile.js

  Browser ->> WebUIServer: GET /bff/v1/users/settings
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/users/settings
  APIServer ->> Postgres: 讀取 users.settings(JSONB)
  APIServer -->> WebUIServer: 200 {settings, message}
  WebUIServer -->> Browser: 200

  Browser ->> WebUIServer: GET /bff/v1/users/settings/system-default-llm
  WebUIServer ->> APIServer: GET /api/v1/users/settings/system-default-llm
  APIServer ->> Postgres: SELECT settings.key in (default_llm_provider, default_llm_model)
  APIServer -->> WebUIServer: 200 {default_llm_provider, default_llm_model}
  WebUIServer -->> Browser: 200

  User ->> Browser: 切換【使用系統預設 API Key】
  Browser ->> Browser: use_default_api_key==true 時禁用 provider/model 欄位

  opt 不使用預設 API Key（使用者自帶）
    User ->> Browser: 輸入【Provider/Model/Google API Key】
  end

  User ->> Browser: 點選【儲存模型設定】
  Browser ->> WebUIServer: PATCH /bff/v1/users/settings
  Note over Browser,WebUIServer: body: {use_default_api_key, default_llm_provider?, default_llm_model?, llm_providers?}
  WebUIServer ->> APIServer: PATCH /api/v1/users/settings

  APIServer ->> Postgres: SELECT api_key_blacklist WHERE user_id=current_user
  alt 使用者在黑名單且嘗試啟用 use_default_api_key=true
    APIServer -->> WebUIServer: 400 {detail:"您已被禁止使用預設 API Key..."}
    WebUIServer -->> Browser: 400
    Browser ->> Browser: 顯示錯誤提示（需改用自帶 Key）
  else 允許更新
    APIServer ->> Postgres: UPDATE users.settings(JSONB)
    Note over APIServer: 同步更新 llm_model_api.providers / default_llm_* / use_default_api_key
    Postgres -->> APIServer: commit

    opt LLM 配置有變更（provider/model/api_key）
      APIServer ->> APIServer: user_llm_manager.force_cleanup_user(user_id)
      Note over APIServer: 清除快取失敗不影響設定更新
    end

    APIServer -->> WebUIServer: 200 {settings, message:"設定已成功更新"}
    WebUIServer -->> Browser: 200
    Browser ->> Browser: 顯示「模型設定已更新」
  end
```

## Mermaid 備註
- 讀取/更新使用者設定：`GET/PATCH /bff/v1/users/settings`。
- 顯示系統預設 LLM：`GET /bff/v1/users/settings/system-default-llm`（讀 `settings` 表）。
- 黑名單限制：`PATCH /api/v1/users/settings` 在 `use_default_api_key=true` 時會檢查 `api_key_blacklist`，若在黑名單則回 400。
- 模型快取清理：當 `default_llm_provider/default_llm_model/llm_providers` 變更時，後端會呼叫 `user_llm_manager.force_cleanup_user()`（in-memory）。
