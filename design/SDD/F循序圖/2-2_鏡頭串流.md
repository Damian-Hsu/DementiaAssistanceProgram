# 2-2 鏡頭串流

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant StreamingServer
  participant Mediamtx

  User ->> Browser: 開啟鏡頭頁
  Browser ->> WebUIServer: GET /camera
  WebUIServer -->> Browser: 200 camera.html + camera.js

  Browser ->> WebUIServer: GET /bff/v1/camera/?page=1&size=20\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/camera/?...
  APIServer ->> Postgres: SELECT camera list by user_id
  Postgres -->> APIServer: cameras[]
  APIServer -->> WebUIServer: 200 {items:[...], total}
  WebUIServer -->> Browser: 200 ...
  Browser ->> Browser: 顯示鏡頭清單

  loop 定期輪詢串流狀態（每 N 秒，假設）
    Browser ->> WebUIServer: GET /bff/v1/camera/{id}/stream/status\nAuthorization: Bearer jwt
    WebUIServer ->> APIServer: GET /api/v1/camera/{id}/stream/status
    APIServer ->> StreamingServer: GET /streams\n(X-Internal-Token)
    StreamingServer -->> APIServer: 200 streams[]
    APIServer -->> WebUIServer: 200 {status,is_streaming,...}
    WebUIServer -->> Browser: 200 ...
    Browser ->> Browser: 更新狀態指示器
  end

  opt 開始串流（見 2-2-5）
    User ->> Browser: 點選【開始串流】
  end

  opt 停止串流（見 2-2-6）
    User ->> Browser: 點選【停止串流】
  end

  opt 取得推流連結（見 2-2-4）
    User ->> Browser: 點選【串流連結】
  end

  opt 播放即時串流（見 2-2-8）
    note over Browser,Mediamtx: running 時，Browser 以 WebRTC/WHEP 連 Mediamtx 播放
  end
```

## Mermaid 備註
- 鏡頭 CRUD：使用 `/camera` 相關 API（`APIServer` 的 `Camera` router）。\n- 串流狀態：`APIServer` 會反查 `StreamingServer /streams` 彙整狀態回給前端。\n- 即時預覽：使用 `Mediamtx` 的 WebRTC（WHEP）播放，並由 `Mediamtx` 透過 HTTP auth 回打 `APIServer` 驗證 token。\n- 缺少的關鍵資訊：前端輪詢間隔 N 秒、以及是否只輪詢「目前選取鏡頭」未在描述固定；本圖以「每 N 秒」與「camera/{id}」抽象表示。\n+

