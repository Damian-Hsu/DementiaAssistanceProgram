# 2-1-5-2 AI 推薦事件

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant Redis
  participant ComputeServer

  User ->> Browser: 點選【AI推薦】
  Browser ->> WebUIServer: POST /bff/v1/vlogs/ai-select\n{date, limit, summary_text?}\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: POST /api/v1/vlogs/ai-select

  APIServer ->> Postgres: SELECT events (target_date 範圍)
  APIServer ->> Postgres: SELECT diary (同日)\n(若 summary_text 未提供)
  Postgres -->> APIServer: events[] + diary(optional)
  APIServer ->> APIServer: 建立 query\n(優先 summary_text，其次 diary.content，否則通用描述)

  APIServer ->> Postgres: INSERT inference_jobs(type=rag_highlights,status=pending)
  Postgres -->> APIServer: job id

  APIServer ->> Redis: enqueue tasks.suggest_vlog_highlights\n{query,candidates,limit,job_id} (async)

  alt Celery 結果後端可用 → 同步等待（最多 120 秒）
    Redis -->> ComputeServer: deliver task (async)
    ComputeServer ->> Postgres: UPDATE inference_jobs progress/status (async)
    ComputeServer -->> Redis: store result (async)
    APIServer ->> Redis: get(task_result)\n(blocking wait)
    Redis -->> APIServer: selected_event_ids
  else 結果後端不可用/等待逾時 → 後端本地 fallback
    APIServer ->> APIServer: BM25/簡易 RAG 計算\n(_perform_rag_selection)
  end

  APIServer -->> WebUIServer: 200 {selected_event_ids:[...]}
  WebUIServer -->> Browser: 200 ...
  Browser ->> Browser: 勾選推薦事件\n並更新已選數量
```

## Mermaid 備註
- API：`POST /bff/v1/vlogs/ai-select`。\n- 後端實作特性：會建立 `inference_jobs`（`rag_highlights`），並嘗試以 Celery 同步等待結果；若無結果後端或逾時，則在 APIServer 端以 BM25 fallback 計算。\n- 缺少的關鍵資訊：ComputeServer 任務 `tasks.suggest_vlog_highlights` 的具體 scoring/embedding 行為不在本圖細化；以「回傳 selected_event_ids」抽象表示。\n+

