# 2-1-2 顯示日記內容

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟首頁或切換到指定日期
  Browser ->> WebUIServer: GET /bff/v1/chat/diary/{date}\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/chat/diary/{date}

  APIServer ->> Postgres: SELECT diary WHERE (user_id, diary_date)
  APIServer ->> Postgres: SELECT events in date range\n(用於 events_count)
  Postgres -->> APIServer: diary row / null + events_count
  APIServer -->> WebUIServer: 200 {content, events_count}
  WebUIServer -->> Browser: 200 {content, events_count}

  Browser ->> WebUIServer: GET /bff/v1/events/?start_time={date}&end_time={date}&size=100\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/events/?...
  APIServer ->> Postgres: SELECT events WHERE user_id=current_user\nAND start_time in range
  Postgres -->> APIServer: events[]
  APIServer -->> WebUIServer: 200 {items:[...]}
  WebUIServer -->> Browser: 200 {items:[...]}
  Browser ->> Browser: 計算 events_hash（SHA-256）\n存入 lastEventsHash[date]

  alt events_count == 0
    Browser ->> Browser: 顯示「本日無事件」提示
  else 有事件
    alt diary.content 存在
      Browser ->> Browser: 顯示日記內容（換行轉段落）
    else diary.content 為空
      Browser ->> Browser: 顯示「這一天還沒有日記內容」
    end
  end
```

## Mermaid 備註
- 前端會額外查詢事件列表並在瀏覽器端計算 `events_hash`，用於後續自動刷新判斷（參考 `services/WebUIServer/app/static/js/diary.js`）。\n- 後端日記查詢：`GET /api/v1/chat/diary/{diary_date}`（不會強制刷新）。\n- 缺少的關鍵資訊：事件列表 `events` 查詢參數命名與排序規則由 `Events` router 決定；本圖以 `start_time/end_time/size` 抽象表示。\n+

