# 3-4-1 系統預設 LLM

# Mermaid
```mermaid
sequenceDiagram
  actor Admin
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  Admin ->> Browser: 開啟【管理員設定】頁
  Browser ->> WebUIServer: GET /admin/settings
  WebUIServer -->> Browser: 200 admin_settings.html + admin_settings.js

  Browser ->> WebUIServer: GET /bff/v1/admin/settings/default-llm
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/admin/settings/default-llm
  APIServer ->> Postgres: SELECT settings(default_llm_provider/default_llm_model)
  APIServer -->> WebUIServer: 200 {default_llm_provider, default_llm_model}
  WebUIServer -->> Browser: 200
  Browser ->> Browser: 填入預設 provider/model

  Admin ->> Browser: 選擇【預設 LLM 供應商】並輸入【預設 LLM 模型】
  Admin ->> Browser: 點選【儲存設定】
  Browser ->> WebUIServer: POST /bff/v1/admin/settings/default-llm
  Note over Browser,WebUIServer: body: {default_llm_provider, default_llm_model}
  WebUIServer ->> APIServer: POST /api/v1/admin/settings/default-llm

  alt 權限不足/參數缺漏
    APIServer -->> WebUIServer: 401/403/422
    WebUIServer -->> Browser: 401/403/422
    Browser ->> Browser: 顯示錯誤提示
  else 更新成功
    APIServer ->> Postgres: UPSERT settings.key=default_llm_provider
    APIServer ->> Postgres: UPSERT settings.key=default_llm_model
    Postgres -->> APIServer: commit
    APIServer -->> WebUIServer: 200 {default_llm_provider, default_llm_model}
    WebUIServer -->> Browser: 200
    Browser ->> Browser: 顯示成功提示
  end
```

## Mermaid 備註
- API：`GET/POST /bff/v1/admin/settings/default-llm`。
- 寫入位置：`settings` 表的 `default_llm_provider`、`default_llm_model`（value 以 JSON 字串保存）。
- 影響範圍：使用者勾選「使用系統預設 API Key」時，其 Chat 會強制使用此系統預設 provider/model（見 `UserService.get_user_llm_config()`）。
