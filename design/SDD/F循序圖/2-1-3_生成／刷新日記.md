# 2-1-3 生成／刷新日記

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant GoogleAI

  User ->> Browser: 點選【刷新日記】
  Browser ->> WebUIServer: POST /bff/v1/chat/diary/summary\n{diary_date, force_refresh=true}\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: POST /api/v1/chat/diary/summary

  APIServer ->> Postgres: 查詢當日 events（含時區轉換）
  APIServer ->> APIServer: 計算 events_hash\n與既有 diary.events_hash 比對

  alt 不需要刷新（hash 相同且未 force）
    APIServer ->> Postgres: SELECT existing diary
    Postgres -->> APIServer: diary row
    APIServer -->> WebUIServer: 200 {content, is_refreshed=false}
    WebUIServer -->> Browser: 200 ...
  else 需要刷新（force 或 hash 變更或 diary 不存在）
    APIServer ->> Postgres: INSERT inference_jobs(type=diary_generation,status=processing)
    Postgres -->> APIServer: job id

    alt events_count == 0
      APIServer ->> APIServer: summary_content = "今天沒有記錄到任何事件。"
    else 有事件
      APIServer ->> GoogleAI: 生成日記摘要（LLM）

      alt 配額/節流（429）
        GoogleAI -->> APIServer: quota exceeded
        APIServer ->> Postgres: UPDATE inference_jobs status=failed + error_message
        Postgres -->> APIServer: ok
        APIServer -->> WebUIServer: 429 {detail: "...請稍後再試..."}
        WebUIServer -->> Browser: 429 ...
        Browser ->> Browser: 顯示配額限制提示
      else 成功或可降級
        GoogleAI -->> APIServer: summary text (+ usage)
        APIServer ->> Postgres: INSERT/UPDATE diary(content, events_hash)
        APIServer ->> Postgres: INSERT llm_usage_logs(source=diary,...)\n(best-effort)
        APIServer ->> Postgres: UPDATE inference_jobs status=success\nparams.progress=100
        Postgres -->> APIServer: commit ok
        APIServer -->> WebUIServer: 200 {content, is_refreshed=true}
        WebUIServer -->> Browser: 200 ...
        Browser ->> Browser: 更新日記區塊顯示
      end
    end
  end
```

## Mermaid 備註
- API：前端使用 `ApiClient.chat.generateDiarySummary(diaryDate, true)` → `POST /bff/v1/chat/diary/summary`。\n- 後端行為（依程式碼）：會建立 `inference_jobs` 追蹤（`diary_generation`），並在成功時寫入 `diary`；LLM 配額錯誤會回 `429`。\n- 缺少的關鍵資訊：GoogleAI 供應商/模型的選擇邏輯受「使用者設定/系統預設」影響；本圖以 `GoogleAI` 抽象代表外部 LLM（假設：使用 Gemini）。\n+

