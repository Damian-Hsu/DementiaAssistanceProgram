# 3-4 系統設定

# Mermaid
```mermaid
sequenceDiagram
  actor Admin
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  Admin ->> Browser: 開啟【管理員設定】頁
  Browser ->> WebUIServer: GET /admin/settings
  WebUIServer -->> Browser: 200 admin_settings.html + admin_settings.js

  Browser ->> WebUIServer: GET /bff/v1/users/me
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/users/me
  alt JWT 無效/非 admin
    APIServer -->> WebUIServer: 401/403
    WebUIServer -->> Browser: 401/403
    Browser ->> Browser: 導回 /auth 或 /home
  else admin
    par 載入系統預設 LLM
      Browser ->> WebUIServer: GET /bff/v1/admin/settings/default-llm
      WebUIServer ->> APIServer: GET /api/v1/admin/settings/default-llm
      APIServer ->> Postgres: SELECT settings(default_llm_provider/default_llm_model)
      APIServer -->> Browser: 200 {default_llm_provider, default_llm_model}
    and 載入預設 Google API Key（遮罩）
      Browser ->> WebUIServer: GET /bff/v1/admin/settings/default-google-api-key
      WebUIServer ->> APIServer: GET /api/v1/admin/settings/default-google-api-key
      APIServer ->> Postgres: SELECT settings(default_google_api_key)
      APIServer -->> Browser: 200 {api_key:"********"}
    and 載入預設 AI key 限制（RPM/RPD）
      Browser ->> WebUIServer: GET /bff/v1/admin/settings/default-ai-key-limits
      WebUIServer ->> APIServer: GET /api/v1/admin/settings/default-ai-key-limits
      APIServer ->> Postgres: SELECT settings(default_ai_key_limits)
      APIServer -->> Browser: 200 {rpm, rpd}
    and 載入影片參數
      Browser ->> WebUIServer: GET /bff/v1/admin/settings/video-params
      WebUIServer ->> APIServer: GET /api/v1/admin/settings/video-params
      APIServer ->> Postgres: SELECT settings(video_segment_seconds)
      APIServer -->> Browser: 200 {segment_seconds}
    and 載入 M2M API Key 列表
      Browser ->> WebUIServer: GET /bff/v1/admin/api-keys
      WebUIServer ->> APIServer: GET /api/v1/admin/api-keys
      APIServer ->> Postgres: SELECT api_keys
      APIServer -->> Browser: 200 [ApiKeyOut...]
    end

    opt 點選【儲存設定】（模型/Key/限制）
      Admin ->> Browser: 點選【儲存設定】
      Browser ->> WebUIServer: POST /bff/v1/admin/settings/default-llm
      Browser ->> WebUIServer: POST /bff/v1/admin/settings/default-google-api-key (可選)
      Browser ->> WebUIServer: POST /bff/v1/admin/settings/default-ai-key-limits (可選)
      WebUIServer ->> APIServer: 轉發上述請求
      APIServer ->> Postgres: UPSERT settings
      APIServer -->> Browser: 200
      Browser ->> Browser: 顯示成功/失敗訊息
    end

    opt 影片參數設定（見 3-4-4）
      Admin ->> Browser: 點選【儲存設定】(影片參數)
      Browser ->> WebUIServer: POST /bff/v1/admin/settings/video-params
      WebUIServer ->> APIServer: POST /api/v1/admin/settings/video-params
      APIServer ->> Postgres: UPSERT settings(video_segment_seconds)
      APIServer -->> Browser: 200
    end

    opt M2M API Key 管理（見 3-4-5）
      Admin ->> Browser: 建立/更新/旋轉/停用 API Key
      Browser ->> WebUIServer: 呼叫 /bff/v1/admin/api-keys...
      WebUIServer ->> APIServer: 呼叫 /api/v1/admin/api-keys...
      APIServer ->> Postgres: INSERT/UPDATE api_keys
      APIServer -->> Browser: 200/201
    end
  end
```

## Mermaid 備註
- 此頁面實作在 `admin_settings.html/js`，會在 `boot()` 時並行載入：預設 LLM、預設 Google API Key（遮罩）、預設 AI key 限制、影片參數、M2M API Key 列表。
- 「儲存設定」按鈕會一次處理：預設 LLM +（若輸入才更新）預設 Google API Key +（若有值才更新）RPM/RPD。
