# 1-1-2 註冊

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟註冊頁
  Browser ->> WebUIServer: GET /auth.html
  WebUIServer -->> Browser: 200 auth.html + static js/css

  loop 使用者重試註冊（假設：可多次送出表單）
    User ->> Browser: 輸入註冊資料並點選「Next」
    Browser ->> Browser: 前端格式驗證\n(帳號/密碼/Email/手機/確認密碼...)

    alt 前端驗證失敗
      Browser ->> Browser: 顯示錯誤訊息並標示欄位
    else 前端驗證通過
      Browser ->> WebUIServer: POST /bff/v1/auth/signup\nContent-Type: application/json
      WebUIServer ->> APIServer: POST /api/v1/auth/signup\nSignupRequestDTO

      alt 後端欄位驗證失敗（Pydantic）
        APIServer -->> WebUIServer: 422 {detail: validation errors}
        WebUIServer -->> Browser: 422 ...
        Browser ->> Browser: 顯示欄位驗證錯誤
      else 後端欄位驗證通過
        APIServer ->> Postgres: SELECT users WHERE account = :account
        Postgres -->> APIServer: row / null
        APIServer ->> Postgres: SELECT users WHERE email = :email
        Postgres -->> APIServer: row / null
        APIServer ->> Postgres: SELECT users WHERE phone = :phone
        Postgres -->> APIServer: row / null

        alt 帳號/Email/手機已存在
          APIServer -->> WebUIServer: 400 {detail: "帳號已存在"/"Email 已被使用"/"phone 已被使用"}
          WebUIServer -->> Browser: 400 ...
          Browser ->> Browser: 顯示錯誤訊息
        else 資料庫暫時不可用
          APIServer -->> WebUIServer: 503 {detail: "資料庫服務暫時無法使用，請稍後再試"}
          WebUIServer -->> Browser: 503 ...
          Browser ->> Browser: 顯示稍後再試
        else 註冊成功
          APIServer ->> APIServer: hash_password + get_default_user_settings
          APIServer ->> Postgres: INSERT users\n(role=user, active=true, settings=default)
          Postgres -->> APIServer: commit ok + user id

          APIServer ->> APIServer: create_token(sub=user.id, extra={account, role})
          APIServer -->> WebUIServer: 201 {access_token, token_type=bearer}
          WebUIServer -->> Browser: 201 {access_token, token_type=bearer}
          Browser ->> Browser: localStorage["jwt"] = access_token

          opt 取得使用者角色並導向
            Browser ->> WebUIServer: GET /bff/v1/users/me\nAuthorization: Bearer jwt
            WebUIServer ->> APIServer: GET /api/v1/users/me
            APIServer ->> Postgres: SELECT users WHERE id = sub
            Postgres -->> APIServer: user row
            APIServer -->> WebUIServer: 200 {user:{..., role}}
            WebUIServer -->> Browser: 200 {user:{..., role}}

            alt role == admin
              Browser ->> Browser: redirect /admin/tasks
            else role == user
              Browser ->> Browser: redirect /home
            end
          end
        end
      end
    end
  end
```

## Mermaid 備註
- 資料庫表：`users`
- API：Browser 呼叫 `WebUIServer` 的 `/bff/v1/auth/signup`（BFF proxy），由 `WebUIServer` 轉送至 `APIServer` 的 `/api/v1/auth/signup`。
- 建立資料：後端檢查 account/email/phone 唯一性、bcrypt 雜湊密碼、寫入預設 `settings`、role=user、active=true。
- Token：註冊成功即回傳 `access_token`（JWT）；前端儲存後會再呼叫 `/bff/v1/users/me` 以決定導向。
- 錯誤處理：
  - 400：帳號已存在 / Email 已被使用 / phone 已被使用（或 DB 唯一鍵衝突）
  - 422：欄位驗證失敗（Pydantic 驗證）
  - 503：資料庫服務暫時無法使用
  - 500：其他未預期錯誤
- 缺少的關鍵資訊（以合理假設補齊）：
  - UI 入口網址：系統同時提供 `/`、`/auth`、`/auth.html`；本圖假設使用者由 `/auth.html` 進入。
  - Email/手機驗證流程：程式未見 OTP/Email 驗證；本圖假設不需要驗證即可直接登入。
  - 重試/鎖定/節流：程式未見註冊節流或鎖定；本圖假設可無限次重試。
- 假設：
  - 使用者可重複送出表單（重試）。
