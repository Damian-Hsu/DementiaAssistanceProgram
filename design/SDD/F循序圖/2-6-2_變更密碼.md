# 2-6-2 變更密碼

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟【變更密碼】對話框
  User ->> Browser: 輸入【舊密碼/新密碼】
  User ->> Browser: 點選【確認變更】

  Browser ->> WebUIServer: PUT /bff/v1/users/me/password
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: PUT /api/v1/users/me/password

  alt JWT 無效/過期/權限不足
    APIServer -->> WebUIServer: 401/403 {detail}
    WebUIServer -->> Browser: 401/403
    Browser ->> Browser: 清除 jwt 並導回 /auth.html
  else JWT 有效
    APIServer ->> Postgres: SELECT users.password_hash by current_user
    alt 舊密碼驗證失敗
      APIServer -->> WebUIServer: 422 {detail:"舊密碼不正確"}
      WebUIServer -->> Browser: 422
      Browser ->> Browser: 關閉 dialog 並顯示錯誤提示
    else 舊密碼正確
      APIServer ->> APIServer: hash(new_password)
      APIServer ->> Postgres: UPDATE users.password_hash
      Postgres -->> APIServer: commit
      APIServer -->> WebUIServer: 200 {msg:"密碼已成功更新"}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 清空輸入、關閉 dialog、顯示成功提示
    end
  end
```

## Mermaid 備註
- 前端：`ApiClient.changePassword()` → `PUT /bff/v1/users/me/password`（body: `{old_password,new_password}`）。
- 後端：`PUT /api/v1/users/me/password` 會先 `verify_password(old_password)`，成功才更新 `users.password_hash`。
- `user_profile.html` 的 input pattern 限制為 6 位數字，但 `user_profile.js` 已註記「不再做格式驗證，交由後端檢查」。
