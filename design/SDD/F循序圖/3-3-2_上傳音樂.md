# 3-3-2 上傳音樂

# Mermaid
```mermaid
sequenceDiagram
  actor Admin
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant Minio

  Admin ->> Browser: 點選【新增音樂】
  Browser ->> Browser: 開啟新增音樂視窗
  Admin ->> Browser: 選擇音樂檔 + 輸入名稱/製作者/描述/metadata(JSON)
  Admin ->> Browser: 點選【上傳音樂】

  Browser ->> Browser: 組 FormData(file,name,composer?,description?,metadata?)
  Browser ->> WebUIServer: POST /bff/v1/admin/music (multipart/form-data)
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: POST /api/v1/admin/music

  alt 檔案非 audio/* 或內容為空 或 metadata JSON 不合法
    APIServer -->> WebUIServer: 400 {detail}
    WebUIServer -->> Browser: 400
    Browser ->> Browser: 顯示錯誤提示
  else 上傳成功
    APIServer ->> Minio: upload_fileobj(object_name, content_type)
    Minio -->> APIServer: 200

    APIServer ->> Postgres: INSERT music (name, composer, description, meta_data, s3_key, uploader_user_id)
    Postgres -->> APIServer: commit

    APIServer -->> WebUIServer: 201 MusicAdminRead
    WebUIServer -->> Browser: 201
    Browser ->> Browser: 顯示「上傳成功」並重新載入清單
  end
```

## Mermaid 備註
- API：`POST /bff/v1/admin/music`（`UploadFile` + `Form` 欄位）。
- 物件命名：`{admin_user_id}/music/{uuid}.{ext}`，並存入 `music.s3_key`。
- `metadata`：前端會先 `JSON.parse()` 驗證；後端也會再 `json.loads()` 驗證並合併 `original_filename/content_length`。
