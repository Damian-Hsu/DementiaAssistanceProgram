# 2-5 AI 助手

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant GoogleAI

  User ->> Browser: 開啟 AI 助手頁
  Browser ->> WebUIServer: GET /chat
  WebUIServer -->> Browser: 200 chat.html + chat.js

  Browser ->> Browser: 從 localStorage 載入對話歷史\n渲染訊息泡泡

  User ->> Browser: 輸入訊息 + 點選【發送】
  Browser ->> WebUIServer: POST /bff/v1/chat/\n{message, history?, date_from?, date_to?}\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: POST /api/v1/chat/

  APIServer ->> Postgres: 讀取 user 設定\n(LLM provider/model/api_key)
  alt 使用系統預設 API Key
    APIServer ->> Postgres: 檢查 api_key_blacklist\n(是否禁用預設 key)
    APIServer ->> Postgres: 讀取 settings.default_ai_key_limits\n(rpm/rpd)
    APIServer ->> APIServer: 內存 rate limiter check\n(超標則拒絕)
  end

  alt 黑名單/未配置預設 key/超出限制
    APIServer -->> WebUIServer: 400/500/429 {detail: "..."}
    WebUIServer -->> Browser: 400/500/429 ...
    Browser ->> Browser: 在對話中顯示提示訊息\n（見 2-5-4）
  else 允許呼叫 LLM
    APIServer ->> GoogleAI: LLM 生成回覆\n(含 function calling)
    opt 工具查詢關聯資料（可能多次迭代）
      APIServer ->> Postgres: 查 events/recordings/diary/vlogs\n(依 date_from/date_to 與問題)
      Postgres -->> APIServer: datasets
      APIServer ->> GoogleAI: 提供工具結果\n生成最終回覆
    end
    GoogleAI -->> APIServer: final_message + usage
    APIServer ->> Postgres: INSERT llm_usage_logs (source=chat)\n(best-effort commit)
    APIServer -->> WebUIServer: 200 {message, related_data...}
    WebUIServer -->> Browser: 200 ...
    Browser ->> Browser: 顯示 AI 回覆\n更新 localStorage 對話歷史
  end
```

## Mermaid 備註
- Chat API：`POST /bff/v1/chat/`（可帶 `history`、`date_from/date_to`）。\n- 對話歷史：存於瀏覽器 `localStorage`（非 DB）。\n- 系統預設 key 限制：僅在「未提供個人 key」時套用黑名單與 in-memory rate limiter（`rpm/rpd` 由 settings 決定）。\n+

