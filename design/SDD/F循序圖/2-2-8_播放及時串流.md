# 2-2-8 播放及時串流

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Mediamtx

  User ->> Browser: 在鏡頭頁啟動「即時預覽」
  Browser ->> WebUIServer: GET /bff/v1/camera/{id}/play-webrtc-url?ttl=180\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/camera/{id}/play-webrtc-url?ttl=180

  alt 權限不足/鏡頭非 active
    APIServer -->> WebUIServer: 403
    WebUIServer -->> Browser: 403
    Browser ->> Browser: 顯示錯誤\n停止預覽
  else 成功簽發 WebRTC token
    APIServer ->> APIServer: issue JWT\n(aud=webrtc, action=read, ttl)
    APIServer -->> WebUIServer: 200 {play_webrtc_url, expires_at}
    WebUIServer -->> Browser: 200 {play_webrtc_url,...}

    loop 建立 WebRTC 連線（失敗則重試）
      Browser ->> Mediamtx: 建立 WebRTC/WHEP 連線\n使用 play_webrtc_url（含 token）
      Mediamtx ->> APIServer: HTTP auth 回打 /api/v1/m2m/check-stream-pwd\n(protocol=webrtc, action=read, path, query.token)

      alt token 驗證成功
        APIServer -->> Mediamtx: 200 OK
        Mediamtx -->> Browser: WebRTC connected
        Browser ->> Browser: 顯示即時畫面
      else token 無效/過期
        APIServer -->> Mediamtx: 401
        Mediamtx -->> Browser: connection failed
        Browser ->> Browser: 等待一段時間後重試（假設）
      end
    end
  end

  opt 需要延長 token（假設：預覽時間很長）
    Browser ->> WebUIServer: GET /bff/v1/camera/{id}/token/refresh/webrtc?token=old\nAuthorization: Bearer jwt
    WebUIServer ->> APIServer: GET /api/v1/camera/{id}/token/refresh/webrtc?token=old
    APIServer -->> WebUIServer: 200 {token, expires_at}
    WebUIServer -->> Browser: 200 ...
  end
```

## Mermaid 備註
- WebRTC 播放 URL：`GET /camera/{id}/play-webrtc-url` 會簽發 `aud=webrtc` 的短效 JWT，並組成 public WebRTC 播放 URL。\n- MediaMTX 驗證：同 RTSP，透過 `authHTTPAddress` 回打 `APIServer /m2m/check-stream-pwd`。\n- 缺少的關鍵資訊：前端重連策略（退避時間、最大重試次數）未固定；本圖以「等待後重試」（假設）表示。\n+

