# 3-2 使用者管理

# Mermaid
```mermaid
sequenceDiagram
  actor Admin
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  Admin ->> Browser: 開啟【使用者管理】頁
  Browser ->> WebUIServer: GET /admin/users
  WebUIServer -->> Browser: 200 admin_users.html + admin_users.js

  Browser ->> WebUIServer: GET /bff/v1/users/me
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/users/me
  alt JWT 無效/過期
    APIServer -->> WebUIServer: 401/403
    WebUIServer -->> Browser: 401/403
    Browser ->> Browser: 清除 jwt 並導回 /auth.html
  else JWT 有效
    APIServer -->> WebUIServer: 200 {user:{role}}
    WebUIServer -->> Browser: 200
    alt role != admin
      Browser ->> Browser: 顯示提示並導回 /home
    else role == admin
      Browser ->> Browser: 載入使用者統計（見 3-2-1）
      Browser ->> WebUIServer: GET /bff/v1/admin/users/stats
      WebUIServer ->> APIServer: GET /api/v1/admin/users/stats
      APIServer ->> Postgres: 查 users + 聚合 llm_usage_logs + 查 api_key_blacklist
      APIServer -->> WebUIServer: 200 [UserStats...]
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 渲染統計表

      opt 點擊使用者列（見 3-2-2）
        Admin ->> Browser: 點選使用者列
        Browser ->> WebUIServer: GET /bff/v1/admin/users/{user_id}
        WebUIServer ->> APIServer: GET /api/v1/admin/users/{user_id}
        APIServer ->> Postgres: SELECT users + api_key_blacklist
        APIServer -->> WebUIServer: 200 UserDetail
        WebUIServer -->> Browser: 200
        Browser ->> Browser: 開啟詳情視窗
      end

      opt 在詳情視窗點選【儲存】（見 3-2-3/3-2-4）
        Browser ->> APIServer: PATCH /api/v1/admin/users/{user_id} (active)
        Browser ->> APIServer: POST/DELETE /api/v1/admin/blacklist ...
        APIServer ->> Postgres: UPDATE users.active / UPSERT api_key_blacklist
        APIServer -->> Browser: 200
        Browser ->> Browser: 更新列表狀態並關閉視窗
      end
    end
  end
```

## Mermaid 備註
- 使用者統計：`GET /bff/v1/admin/users/stats`（後端目前回傳 **整個列表**；前端雖帶 `page/size` 但後端未實作分頁）。
- 使用者詳情：`GET /bff/v1/admin/users/{user_id}`（包含 `password_hash`、黑名單狀態與原因）。
- 啟用/停用：`PATCH /bff/v1/admin/users/{user_id}`（body: `{active}`）。
- 黑名單：`POST /bff/v1/admin/blacklist`、`DELETE /bff/v1/admin/blacklist/{user_id}`（加入時會同步把 `users.settings.use_default_api_key=false`）。
