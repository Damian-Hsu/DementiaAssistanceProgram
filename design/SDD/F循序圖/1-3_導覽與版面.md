# 1-3 導覽與版面

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟任一功能頁（例如 /home）
  Browser ->> WebUIServer: GET /home
  WebUIServer -->> Browser: 200 HTML + 共用 base.html\n+ sidebar/mobile_nav partials\n+ init_user.js

  Browser ->> Browser: DOMContentLoaded\n讀取 localStorage['jwt']

  alt 未登入（沒有 jwt）
    Browser ->> Browser: window.location.href = /auth
  else 已登入（有 jwt）
    Browser ->> WebUIServer: GET /bff/v1/users/me\nAuthorization: Bearer jwt
    WebUIServer ->> APIServer: GET /api/v1/users/me\nAuthorization: Bearer jwt
    APIServer ->> Postgres: SELECT users WHERE id = sub
    Postgres -->> APIServer: user row
    APIServer -->> WebUIServer: 200 {user:{role,...}}
    WebUIServer -->> Browser: 200 {user:{role,...}}

    Browser ->> Browser: 設定 localStorage['user_role']\n切換 sidebar/mobile_nav 顯示\n高亮目前頁面(active_page)

    alt 在 /admin* 但不是 admin
      Browser ->> Browser: 導向 /home
    else 允許繼續
      Browser ->> Browser: 初始化 UI 互動（捲軸效果等）
    end

    loop 每 10 分鐘（且 10 分鐘內有活動）
      Browser ->> Browser: 判斷 userActivityStatus（是否有活動）
      alt 有活動 → 刷新 JWT
        Browser ->> WebUIServer: GET /bff/v1/users/token/refresh\nAuthorization: Bearer jwt
        WebUIServer ->> APIServer: GET /api/v1/users/token/refresh\nAuthorization: Bearer jwt
        APIServer -->> WebUIServer: 200 {access_token}
        WebUIServer -->> Browser: 200 {access_token}
        Browser ->> Browser: 更新 localStorage['jwt']
      else 無活動 → 不刷新
        Browser ->> Browser: 跳過刷新
      end
    end
  end
```

## Mermaid 備註
- 使用者資訊：由前端呼叫 `/bff/v1/users/me`（BFF）取得 role，並依 `role===admin` 切換 `sidebar_admin`/`mobile_nav_admin`（參考 `services/WebUIServer/app/static/js/init_user.js`）。\n- JWT 刷新：前端每 10 分鐘檢查活動狀態，若有活動則呼叫 `/bff/v1/users/token/refresh` 取得新 token（參考 `services/APIServer/app/router/User/service.py` 的 `/token/refresh`）。\n- 缺少的關鍵資訊：\n  - 後端 JWT 刷新是否會延長過期時間、以及是否有 refresh token/blacklist 機制（目前未見）（假設：單純重新簽發 access_token）。\n  - 導覽高亮的具體實作依賴 template 的 `active_page` 與 CSS（本圖抽象為「高亮目前頁面」）。\n+

