# 2-6-1 使用者設定

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟【設定】頁
  Browser ->> WebUIServer: GET /settings
  WebUIServer -->> Browser: 200 user_profile.html + user_profile.js

  Browser ->> WebUIServer: GET /bff/v1/users/me
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/users/me
  alt JWT 無效/過期/權限不足
    APIServer -->> WebUIServer: 401/403 {detail}
    WebUIServer -->> Browser: 401/403
    Browser ->> Browser: 清除 jwt 並導回 /auth.html
  else 成功
    APIServer -->> WebUIServer: 200 {user:{...}}
    WebUIServer -->> Browser: 200
    Browser ->> Browser: 填入個人資料表單
  end

  User ->> Browser: 編輯個人資料欄位
  User ->> Browser: 點選【儲存個人資料】
  Browser ->> Browser: 前端組合 updateData
  Browser ->> WebUIServer: PATCH /bff/v1/users/me
  WebUIServer ->> APIServer: PATCH /api/v1/users/me

  alt Email/電話重複或資料格式不合法
    APIServer -->> WebUIServer: 400/422 {detail}
    WebUIServer -->> Browser: 400/422
    Browser ->> Browser: 顯示錯誤訊息
  else 更新成功
    APIServer ->> Postgres: UPDATE users (name/gender/birthday/phone/email/headshot_url)
    Postgres -->> APIServer: commit
    APIServer -->> WebUIServer: 200 {msg:"資料已更新", user:{...}}
    WebUIServer -->> Browser: 200

    Browser ->> WebUIServer: GET /bff/v1/users/me
    WebUIServer ->> APIServer: GET /api/v1/users/me
    APIServer -->> WebUIServer: 200 {user:{...}}
    WebUIServer -->> Browser: 200
    Browser ->> Browser: 重新填入表單並顯示成功提示
  end
```

## Mermaid 備註
- 前端：`ApiClient.getCurrentUser()` → `GET /bff/v1/users/me`；`ApiClient.updateUserProfile()` → `PATCH /bff/v1/users/me`（參考 `services/WebUIServer/app/static/js/APIClient.js`）。
- 後端：`PATCH /api/v1/users/me` 會檢查 `email` 唯一性，並更新 `users` 資料表。
