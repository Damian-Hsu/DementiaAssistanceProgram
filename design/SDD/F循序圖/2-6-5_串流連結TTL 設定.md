# 2-6-5 串流連結TTL 設定

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟【設定】頁
  Browser ->> WebUIServer: GET /settings
  WebUIServer -->> Browser: 200 user_profile.html + user_profile.js

  Browser ->> WebUIServer: GET /bff/v1/users/settings
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/users/settings
  APIServer ->> Postgres: 讀取 users.settings(JSONB)
  APIServer -->> WebUIServer: 200 {settings, message}
  WebUIServer -->> Browser: 200
  Browser ->> Browser: 顯示目前 default_stream_ttl(秒)

  User ->> Browser: 輸入【TTL(秒)】
  User ->> Browser: 點選【儲存應用程式設定】
  Browser ->> WebUIServer: PATCH /bff/v1/users/settings
  Note over Browser,WebUIServer: body: {default_stream_ttl}
  WebUIServer ->> APIServer: PATCH /api/v1/users/settings

  alt 數值超出範圍（300~21600）或格式錯誤
    APIServer -->> WebUIServer: 422 {detail}
    WebUIServer -->> Browser: 422
    Browser ->> Browser: 顯示錯誤訊息
  else 更新成功
    APIServer ->> Postgres: UPDATE users.settings.default_stream_ttl
    Postgres -->> APIServer: commit
    APIServer -->> WebUIServer: 200 {settings, message}
    WebUIServer -->> Browser: 200
    Browser ->> Browser: 顯示成功提示
  end

  opt 後續：鏡頭串流頁使用此 TTL
    Browser ->> WebUIServer: GET /bff/v1/users/settings
    WebUIServer ->> APIServer: GET /api/v1/users/settings
    APIServer -->> WebUIServer: 200 {settings,...}
    WebUIServer -->> Browser: 200
    Browser ->> Browser: camera.js 設定 userStreamTTL=settings.default_stream_ttl
    Browser ->> WebUIServer: GET /bff/v1/camera/{id}/publish_rtsp_url?ttl=userStreamTTL
    WebUIServer ->> APIServer: GET /api/v1/camera/{id}/publish_rtsp_url?ttl=...
  end
```

## Mermaid 備註
- 設定儲存：`PATCH /bff/v1/users/settings`（欄位：`default_stream_ttl`，範圍 300~21600 秒）。
- 前端實際使用：`services/WebUIServer/app/static/js/camera.js` 載入 `users/settings` 後會用 `default_stream_ttl` 作為串流相關 API 的預設 TTL。
