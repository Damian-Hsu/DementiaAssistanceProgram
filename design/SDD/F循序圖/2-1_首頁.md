# 2-1 首頁

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant Minio

  User ->> Browser: 開啟首頁
  Browser ->> WebUIServer: GET /home
  WebUIServer -->> Browser: 200 home.html + diary.js + vlog.js

  Browser ->> Browser: 取得目標日期（URL query 或今日）

  par 載入日記
    Browser ->> WebUIServer: GET /bff/v1/chat/diary/{date}\nAuthorization: Bearer jwt
    WebUIServer ->> APIServer: GET /api/v1/chat/diary/{date}
    APIServer ->> Postgres: SELECT diary by (user_id, diary_date)\n+ 查詢當日 events 數量
    Postgres -->> APIServer: diary row + events_count
    APIServer -->> WebUIServer: 200 {content, events_count, ...}
    WebUIServer -->> Browser: 200 ...
    Browser ->> Browser: 顯示日記內容/提示\n並以 events 列表計算 hash（供自動刷新）
  and 載入當日 Vlog
    Browser ->> WebUIServer: GET /bff/v1/vlogs/date/{date}\nAuthorization: Bearer jwt
    WebUIServer ->> APIServer: GET /api/v1/vlogs/date/{date}
    APIServer ->> Postgres: SELECT latest vlog by (user_id, target_date)
    Postgres -->> APIServer: vlog row / null
    alt 該日無 Vlog
      APIServer -->> WebUIServer: 404
      WebUIServer -->> Browser: 404
      Browser ->> Browser: 顯示「尚未生成」狀態\n可點選【生成Vlog】
    else 該日有 Vlog
      APIServer -->> WebUIServer: 200 {status, progress, ...}
      WebUIServer -->> Browser: 200 ...
      alt vlog.status == completed
        Browser ->> WebUIServer: GET /bff/v1/vlogs/{vlogId}/thumbnail-url?ttl=3600
        WebUIServer ->> APIServer: GET /api/v1/vlogs/{vlogId}/thumbnail-url
        APIServer ->> Minio: 產生縮圖 presigned URL
        Minio -->> APIServer: presigned URL
        APIServer -->> WebUIServer: 200 {url}
        WebUIServer -->> Browser: 200 {url}
        Browser ->> Browser: 顯示縮圖
      else vlog.status == pending/processing
        Browser ->> Browser: 顯示 spinner/進度條\n並定期輪詢狀態（見 2-1-4）
      end
    end
  end

  opt 手動刷新日記（見 2-1-3）
    User ->> Browser: 點選【刷新日記】
  end

  opt 生成/刪除 Vlog（見 2-1-5 / 2-1-6）
    User ->> Browser: 點選【生成Vlog】或【刪除Vlog】
  end
```

## Mermaid 備註
- 首頁主要由 `home.html` 搭配 `diary.js`/`vlog.js` 載入「指定日期」的日記與 Vlog。\n- 日記 API：`GET /bff/v1/chat/diary/{date}`；刷新 API：`POST /bff/v1/chat/diary/summary`。\n- Vlog API：`GET /bff/v1/vlogs/date/{date}`，完成後用 `/vlogs/{id}/thumbnail-url`、`/vlogs/{id}/url` 取得預簽名 URL。\n- 缺少的關鍵資訊：首頁 `home.js` 與 `vlog.js` 的輪詢間隔/停止條件未在功能描述中固定；本圖以「定期輪詢」（假設）表示。\n+

