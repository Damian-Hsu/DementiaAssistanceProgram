# 1-1-1 登入

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟登入頁
  Browser ->> WebUIServer: GET /auth.html
  WebUIServer -->> Browser: 200 auth.html + static js/css

  loop 使用者重試登入（假設：可多次送出表單）
    User ->> Browser: 輸入帳號/密碼並點選「Log in」
    Browser ->> Browser: 前端格式驗證（帳號/密碼）

    alt 前端驗證失敗（格式不符）
      Browser ->> Browser: 顯示欄位錯誤/紅框
    else 前端驗證通過
      Browser ->> WebUIServer: POST /bff/v1/auth/login\nContent-Type: application/x-www-form-urlencoded
      WebUIServer ->> APIServer: POST /api/v1/auth/login\nOAuth2PasswordRequestForm

      APIServer ->> Postgres: SELECT users WHERE account = :username
      Postgres -->> APIServer: user row / null

      alt 帳號不存在或密碼錯誤
        APIServer -->> WebUIServer: 401 {detail: "帳號或密碼錯誤"}
        WebUIServer -->> Browser: 401 ...
        Browser ->> Browser: 顯示錯誤訊息
      else 帳號已停用
        APIServer -->> WebUIServer: 401 {detail: "帳號已停用"}
        WebUIServer -->> Browser: 401 ...
        Browser ->> Browser: 顯示錯誤訊息
      else 登入成功
        APIServer ->> APIServer: verify_password + create_token\n(sub=user.id, extra={account, role})
        APIServer -->> WebUIServer: 200 {access_token, token_type=bearer}
        WebUIServer -->> Browser: 200 {access_token, token_type=bearer}
        Browser ->> Browser: localStorage["jwt"] = access_token

        opt 取得使用者角色並導向
          Browser ->> WebUIServer: GET /bff/v1/users/me\nAuthorization: Bearer jwt
          WebUIServer ->> APIServer: GET /api/v1/users/me\nAuthorization: Bearer jwt

          APIServer ->> APIServer: decode_token(jwt) + parse sub
          APIServer ->> Postgres: SELECT users WHERE id = sub
          Postgres -->> APIServer: user row / null

          alt 權限不足 / 權杖無效或過期
            APIServer -->> WebUIServer: 401/403 {detail: "..."}
            WebUIServer -->> Browser: 401/403 ...
            Browser ->> Browser: 清除 jwt 並導回 /auth.html
          else 成功取得使用者
            APIServer -->> WebUIServer: 200 {user: {id, account, role, ...}}
            WebUIServer -->> Browser: 200 {user: {...}}

            alt role == admin
              Browser ->> Browser: redirect /admin/tasks
            else role == user
              Browser ->> Browser: redirect /home
            end
          end
        end
      end
    end
  end
```

## Mermaid 備註
- 資料庫表：`users`
- API：Browser 呼叫 `WebUIServer` 的 `/bff/v1/auth/login`（BFF proxy），由 `WebUIServer` 轉送至 `APIServer` 的 `/api/v1/auth/login`；登入成功後前端會再呼叫 `/bff/v1/users/me` 取得 role 以決定導向頁面。
- Token：`access_token`（JWT；預設 60 分鐘；payload 含 `sub`(user.id)、`account`、`role`）
- 錯誤處理：
  - 401：帳號或密碼錯誤、帳號已停用、token 無效/過期
  - 403：帳號未啟用（`/users/me`）
  - 404：使用者不存在（`/users/me`；依後端目前實作）
- 缺少的關鍵資訊（以合理假設補齊）：
  - UI 入口網址：系統同時提供 `/`、`/auth`、`/auth.html`；本圖假設使用者由 `/auth.html` 進入。
  - 重試/鎖定/節流：程式未見登入失敗鎖定或節流；本圖假設可無限次重試。
- 假設：
  - 使用者可重複送出表單（重試）。
