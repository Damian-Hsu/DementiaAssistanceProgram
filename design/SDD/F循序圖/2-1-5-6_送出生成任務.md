# 2-1-5-6 送出生成任務

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant Redis
  participant ComputeServer
  participant Minio

  User ->> Browser: 點選【送出生成】
  Browser ->> WebUIServer: POST /bff/v1/vlogs\n{target_date,event_ids,title,max_duration,resolution,music_*}\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: POST /api/v1/vlogs

  APIServer ->> Postgres: 驗證 events 都屬於 current_user
  Postgres -->> APIServer: valid_events / invalid

  alt 驗證失敗（事件不存在/不屬於使用者）
    APIServer -->> WebUIServer: 400 {detail: "..."}
    WebUIServer -->> Browser: 400 ...
    Browser ->> Browser: 顯示錯誤並停留在設定視窗
  else 驗證成功
    APIServer ->> Postgres: INSERT vlogs(status=pending, progress=0)\n+ INSERT vlog_segments
    APIServer ->> Postgres: INSERT inference_jobs(type=vlog_generation,status=pending)
    Postgres -->> APIServer: vlog_id + job_id

    APIServer ->> Redis: enqueue tasks.generate_vlog\n{vlog_id,user_id,event_ids,settings,job_id} (async)
    APIServer -->> WebUIServer: 201 {vlog_id, job_id, status=pending}
    WebUIServer -->> Browser: 201 ...
    Browser ->> Browser: 顯示生成中\n開始輪詢狀態
  end

  rect rgba(200,200,200,0.2)
    note over Redis,ComputeServer: 背景處理 (async)
    Redis -->> ComputeServer: tasks.generate_vlog
    ComputeServer ->> APIServer: PATCH /api/v1/vlogs/internal/{vlog_id}/status\nstatus=processing,progress=...\n(X-API-Key)
    APIServer ->> Postgres: UPDATE vlogs/inference_jobs
    Postgres -->> APIServer: ok
    APIServer -->> ComputeServer: 200 ok

    ComputeServer ->> APIServer: POST /api/v1/vlogs/internal/segments\n(X-API-Key)\n取得分鏡/錄影來源
    APIServer ->> Postgres: SELECT vlog_segments + recordings
    Postgres -->> APIServer: segments info
    APIServer -->> ComputeServer: 200 segments info

    ComputeServer ->> Minio: 下載錄影片段/音樂\n上傳完成影片/縮圖
    ComputeServer ->> APIServer: PATCH /api/v1/vlogs/internal/{vlog_id}/status\nstatus=completed,s3_key,thumbnail_s3_key,progress=100\n(X-API-Key)
    APIServer ->> Postgres: UPDATE vlogs(status/progress/keys)\n+ UPDATE inference_jobs(status=success)
    Postgres -->> APIServer: ok
    APIServer -->> ComputeServer: 200 ok
  end
```

## Mermaid 備註
- 建立任務：`POST /vlogs` 會先建立 `vlogs/vlog_segments/inference_jobs`，再 enqueue `tasks.generate_vlog` 到 Redis。\n- 背景更新：ComputeServer 透過 M2M（`X-API-Key`）回打 `/vlogs/internal/{id}/status` 更新進度與結果。\n- 缺少的關鍵資訊：前端輪詢使用哪個端點（`/vlogs/date/{date}` 或 `/vlogs/{id}`）與間隔未固定；本圖以「輪詢狀態」抽象表示。\n+

