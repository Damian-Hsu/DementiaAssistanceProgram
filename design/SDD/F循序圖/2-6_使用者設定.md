# 2-6 使用者設定

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres

  User ->> Browser: 開啟【設定】頁
  Browser ->> WebUIServer: GET /settings
  WebUIServer -->> Browser: 200 user_profile.html + user_profile.js

  Browser ->> Browser: boot()
  alt localStorage 無 JWT
    Browser ->> Browser: 顯示提示並導回登入頁
  else JWT 存在
    Browser ->> WebUIServer: GET /bff/v1/users/me
    Note over Browser,WebUIServer: Authorization: Bearer jwt
    WebUIServer ->> APIServer: GET /api/v1/users/me
    alt JWT 無效/過期/權限不足
      APIServer -->> WebUIServer: 401/403 {detail}
      WebUIServer -->> Browser: 401/403
      Browser ->> Browser: 清除 jwt 並導回 /auth.html
    else 成功
      APIServer -->> WebUIServer: 200 {user:{...}}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 填入個人資料表單
    end

    opt 載入應用程式設定（時區/日記刷新/串流 TTL）
      Browser ->> WebUIServer: GET /bff/v1/users/settings
      WebUIServer ->> APIServer: GET /api/v1/users/settings
      APIServer ->> Postgres: 讀取 users.settings(JSONB)
      Postgres -->> APIServer: settings / null
      APIServer -->> WebUIServer: 200 {settings, message}
      WebUIServer -->> Browser: 200

      Browser ->> WebUIServer: GET /bff/v1/users/settings/timezones
      WebUIServer ->> APIServer: GET /api/v1/users/settings/timezones
      APIServer -->> WebUIServer: 200 {timezones:[{value,label}...]}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 載入時區下拉選單並套用 settings.timezone
    end

    opt 載入 AI 模型設定（含系統預設 LLM 顯示）
      Browser ->> WebUIServer: GET /bff/v1/users/settings
      WebUIServer ->> APIServer: GET /api/v1/users/settings
      APIServer ->> Postgres: 讀取 users.settings(JSONB)
      APIServer -->> WebUIServer: 200 {settings, message}
      WebUIServer -->> Browser: 200

      Browser ->> WebUIServer: GET /bff/v1/users/settings/system-default-llm
      WebUIServer ->> APIServer: GET /api/v1/users/settings/system-default-llm
      APIServer ->> Postgres: SELECT settings.key in (default_llm_provider, default_llm_model)
      Postgres -->> APIServer: rows
      APIServer -->> WebUIServer: 200 {default_llm_provider, default_llm_model}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 依 use_default_api_key 決定 UI 可編輯欄位
    end

    opt 儲存個人資料（見 2-6-1）
      User ->> Browser: 點選【儲存個人資料】
      Browser ->> WebUIServer: PATCH /bff/v1/users/me
      WebUIServer ->> APIServer: PATCH /api/v1/users/me
      APIServer ->> Postgres: UPDATE users (name/gender/birthday/phone/email/headshot_url)
      APIServer -->> WebUIServer: 200 {msg, user}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 顯示「已更新使用者資料」
    end

    opt 儲存應用程式設定（見 2-6-3~2-6-5）
      User ->> Browser: 點選【儲存應用程式設定】
      Browser ->> WebUIServer: PATCH /bff/v1/users/settings
      WebUIServer ->> APIServer: PATCH /api/v1/users/settings
      APIServer ->> Postgres: UPDATE users.settings(JSONB)
      APIServer -->> WebUIServer: 200 {settings, message}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 顯示「應用程式設定已更新」
    end

    opt 儲存模型設定（見 2-6-6）
      User ->> Browser: 點選【儲存模型設定】
      Browser ->> WebUIServer: PATCH /bff/v1/users/settings
      WebUIServer ->> APIServer: PATCH /api/v1/users/settings
      APIServer ->> Postgres: UPDATE users.settings(JSONB)
      APIServer -->> WebUIServer: 200 {settings, message}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 顯示「模型設定已更新」
    end
  end
```

## Mermaid 備註
- 設定頁面：`GET /settings`（WebUIServer 回傳 `user_profile.html` + `user_profile.js`）。
- 使用者資料：`GET/PATCH /bff/v1/users/me` → `GET/PATCH /api/v1/users/me`。
- 使用者設定：`GET/PATCH /bff/v1/users/settings` → `GET/PATCH /api/v1/users/settings`（存放於 `users.settings` JSONB）。
- 時區清單：`GET /bff/v1/users/settings/timezones`。
- 系統預設 LLM：`GET /bff/v1/users/settings/system-default-llm`（讀 `settings` 表的 `default_llm_provider/default_llm_model`）。
