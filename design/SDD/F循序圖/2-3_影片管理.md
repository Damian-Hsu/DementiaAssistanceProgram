# 2-3 影片管理

# Mermaid
```mermaid
sequenceDiagram
  actor User
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant Minio

  User ->> Browser: 開啟影片管理頁
  Browser ->> WebUIServer: GET /recordings
  WebUIServer -->> Browser: 200 recordings.html + recordings.js

  Browser ->> WebUIServer: GET /bff/v1/recordings/?page=1&size=20\nAuthorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/recordings/?...
  APIServer ->> Postgres: SELECT recordings list\n(可含 events exists 條件)
  Postgres -->> APIServer: recordings[]
  APIServer -->> WebUIServer: 200 {items:[...], total}
  WebUIServer -->> Browser: 200 ...
  Browser ->> Browser: 渲染錄影清單

  opt 搜尋（見 2-3-2）
    User ->> Browser: 輸入關鍵字
  end

  opt 點選錄影播放（見 2-3-3）
    User ->> Browser: 點選錄影項目
    Browser ->> WebUIServer: GET /bff/v1/recordings/{id}?ttl=900&disposition=inline
    WebUIServer ->> APIServer: GET /api/v1/recordings/{id}?...
    APIServer ->> Minio: 產生 presigned URL (video/thumbnail)
    Minio -->> APIServer: presigned URL
    APIServer -->> WebUIServer: 200 {url, thumbnail_url?}
    WebUIServer -->> Browser: 200 ...
    Browser ->> Browser: HTML5 video 播放
  end

  opt 下載（見 2-3-4）
    User ->> Browser: 點選【下載】
  end

  opt 顯示影片事件列表（見 2-3-5）
    Browser ->> WebUIServer: GET /bff/v1/recordings/{id}/events
    WebUIServer ->> APIServer: GET /api/v1/recordings/{id}/events
    APIServer ->> Postgres: SELECT events by recording_id
    Postgres -->> APIServer: events[]
    APIServer -->> WebUIServer: 200 events[]
    WebUIServer -->> Browser: 200 events[]
  end

  opt 刪除錄影（見 2-3-6）
    User ->> Browser: 點選【刪除影片】
  end
```

## Mermaid 備註
- 錄影 URL：由 `APIServer /recordings/{id}` 產生 **MinIO presigned GET URL**，支援 `inline/attachment`。\n- 關鍵字搜尋：後端以 `exists` 子查詢在 `events` 上過濾（預設查 `events.summary`）。\n+

