# 3-1 任務管理

# Mermaid
```mermaid
sequenceDiagram
  actor Admin
  participant Browser
  participant WebUIServer
  participant APIServer
  participant Postgres
  participant StreamingServer

  Admin ->> Browser: 開啟【任務管理】頁
  Browser ->> WebUIServer: GET /admin/tasks
  WebUIServer -->> Browser: 200 admin_tasks.html + admin_tasks.js

  Browser ->> WebUIServer: GET /bff/v1/users/me
  Note over Browser,WebUIServer: Authorization: Bearer jwt
  WebUIServer ->> APIServer: GET /api/v1/users/me
  alt JWT 無效/過期
    APIServer -->> WebUIServer: 401/403
    WebUIServer -->> Browser: 401/403
    Browser ->> Browser: 清除 jwt 並導回 /auth.html
  else JWT 有效
    APIServer -->> WebUIServer: 200 {user:{role}}
    WebUIServer -->> Browser: 200
    alt role != admin
      Browser ->> Browser: 顯示提示並導回 /home
    else role == admin
      Browser ->> Browser: 觸發 loadTasks()

      Browser ->> WebUIServer: GET /bff/v1/admin/tasks?page=1&size=20&task_type?&status_filter?
      WebUIServer ->> APIServer: GET /api/v1/admin/tasks?... 
      APIServer ->> Postgres: SELECT inference_jobs (依條件過濾)
      Postgres -->> APIServer: compute_jobs[]
      APIServer ->> StreamingServer: GET /streams
      Note over APIServer,StreamingServer: X-Internal-Token（M2M）
      StreamingServer -->> APIServer: 200 streams[]
      APIServer ->> APIServer: 整合 compute + streaming 並排序/分頁
      APIServer -->> WebUIServer: 200 {items, item_total, page_now, page_total}
      WebUIServer -->> Browser: 200
      Browser ->> Browser: 渲染表格/分頁/篩選器

      loop 每 10 秒自動刷新（頁面可見時）
        Browser ->> Browser: 保存 scrollPosition
        Browser ->> WebUIServer: GET /bff/v1/admin/tasks?...(同條件)
        WebUIServer ->> APIServer: GET /api/v1/admin/tasks?... 
        APIServer ->> Postgres: 查 inference_jobs
        APIServer ->> StreamingServer: GET /streams
        APIServer -->> WebUIServer: 200 tasks
        WebUIServer -->> Browser: 200
        Browser ->> Browser: 更新表格並恢復 scrollPosition
      end
    end
  end
```

## Mermaid 備註
- 前端頁面：`GET /admin/tasks`（WebUIServer 回傳 `admin_tasks.html` + `admin_tasks.js`）。
- 任務列表 API：`GET /bff/v1/admin/tasks` → `GET /api/v1/admin/tasks`（僅管理員；後端 `ensure_admin()`）。
- 任務來源：
  - Compute 任務：Postgres `inference_jobs`。
  - 串流任務：`StreamingServer GET /streams`（需 `X-Internal-Token`）。
- 詳情：前端以 `items[].details` 直接顯示，不會再額外呼叫 detail API（見 3-1-3）。
