{
  "功能編號": "2-6",
  "功能名稱": "使用者設定",
  "功能說明": "使用者設定頁提供個人資料維護（姓名/性別/生日/電話/信箱）、變更密碼，以及應用程式偏好（時區、日記自動刷新間隔、串流連結 TTL）與 AI 模型設定（是否使用系統預設 API Key、預設 LLM provider/model、Google API Key）。所有偏好設定統一存放於 users.settings（JSONB），後端會在更新 LLM 設定時清理 Chat 的模型快取，並在使用者被列入預設 key 黑名單時禁止啟用 use_default_api_key。",
  "程式名稱": "services/WebUIServer/app/template/user_profile.html; services/WebUIServer/app/static/js/user_profile.js; services/WebUIServer/app/static/css/user_profile.css; services/WebUIServer/app/static/js/APIClient.js; services/WebUIServer/app/static/js/AuthService.js; services/APIServer/app/router/User/service.py; services/APIServer/app/router/User/settings.py; services/APIServer/app/router/User/DTO.py; services/APIServer/app/DataAccess/tables/users.py; services/APIServer/app/DataAccess/tables/api_key_blacklist.py; services/APIServer/app/DataAccess/tables/settings.py",
  "輸入摘要": {
    "觸發名詞": [
      "系統",
      "鍵盤",
      "滑鼠"
    ],
    "資源名詞": [
      "使用者設定介面",
      "users資料表"
    ]
  },
  "輸出摘要": {
    "觸發名詞": [
      "螢幕",
      "資料庫"
    ],
    "資源名詞": [
      "使用者設定介面",
      "users資料表"
    ]
  },
  "步驟表": [
    {
      "step_no": "❶",
      "INPUT": {
        "required": true,
        "trigger": "系統",
        "verb": "載入",
        "objects": [
          "使用者設定介面"
        ],
        "text": "系統載入使用者設定介面",
        "sub_steps": []
      },
      "PROCESS": {
        "present": true,
        "text": "載入使用者資料與設定值並填入表單。",
        "sub_steps": []
      },
      "OUTPUT": {
        "present": true,
        "trigger": "螢幕",
        "verb": "顯示",
        "objects": [
          "使用者設定介面"
        ],
        "text": "顯示使用者資料與設定",
        "sub_steps": []
      }
    },
    {
      "step_no": "❷",
      "INPUT": {
        "required": true,
        "trigger": "滑鼠",
        "verb": "點選",
        "objects": [
          "【儲存個人資料】"
        ],
        "text": "滑鼠點選【儲存個人資料】",
        "sub_steps": []
      },
      "PROCESS": {
        "present": true,
        "text": "更新 users 資料表的個人資料欄位。",
        "sub_steps": []
      },
      "OUTPUT": {
        "present": true,
        "trigger": "資料庫",
        "verb": "更新",
        "objects": [
          "users資料表"
        ],
        "text": "更新個人資料",
        "sub_steps": []
      }
    },
    {
      "step_no": "❸",
      "INPUT": {
        "required": true,
        "trigger": "滑鼠",
        "verb": "點選",
        "objects": [
          "【儲存應用程式設定】"
        ],
        "text": "滑鼠點選【儲存應用程式設定】",
        "sub_steps": []
      },
      "PROCESS": {
        "present": true,
        "text": "更新 users.settings 的應用程式設定。",
        "sub_steps": []
      },
      "OUTPUT": {
        "present": true,
        "trigger": "資料庫",
        "verb": "更新",
        "objects": [
          "users資料表"
        ],
        "text": "更新使用者偏好設定",
        "sub_steps": []
      }
    }
  ],
  "資料表": {
    "table_name": "users; api_key_blacklist; settings",
    "columns": [
      {
        "欄位": "id",
        "中文": "使用者ID",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": "autoincrement",
        "備註": "users.id；Primary Key"
      },
      {
        "欄位": "account",
        "中文": "帳號",
        "型態": "VARCHAR",
        "長度": 50,
        "空值": "否",
        "預設值": null,
        "備註": "users.account（unique/index）"
      },
      {
        "欄位": "name",
        "中文": "姓名",
        "型態": "VARCHAR",
        "長度": 100,
        "空值": "否",
        "預設值": null,
        "備註": "users.name"
      },
      {
        "欄位": "gender",
        "中文": "性別",
        "型態": "ENUM",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "users.gender（GenderEnum）"
      },
      {
        "欄位": "birthday",
        "中文": "生日",
        "型態": "DATE",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "users.birthday"
      },
      {
        "欄位": "phone",
        "中文": "電話",
        "型態": "VARCHAR",
        "長度": 20,
        "空值": "否",
        "預設值": null,
        "備註": "users.phone（unique/index）"
      },
      {
        "欄位": "email",
        "中文": "信箱",
        "型態": "VARCHAR",
        "長度": 100,
        "空值": "否",
        "預設值": null,
        "備註": "users.email（unique/index）"
      },
      {
        "欄位": "password_hash",
        "中文": "密碼雜湊",
        "型態": "VARCHAR",
        "長度": 256,
        "空值": "否",
        "預設值": null,
        "備註": "users.password_hash"
      },
      {
        "欄位": "settings",
        "中文": "使用者設定(JSON)",
        "型態": "JSONB",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "users.settings（timezone/diary_auto_refresh_interval_minutes/default_stream_ttl/default_llm_* / llm_model_api / use_default_api_key）"
      },
      {
        "欄位": "user_id",
        "中文": "黑名單使用者ID",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "api_key_blacklist.user_id；Primary Key；ForeignKey(users.id)"
      },
      {
        "欄位": "key",
        "中文": "系統設定鍵",
        "型態": "VARCHAR",
        "長度": 100,
        "空值": "否",
        "預設值": null,
        "備註": "settings.key（default_llm_provider/default_llm_model/default_google_api_key 等）"
      },
      {
        "欄位": "value",
        "中文": "系統設定值",
        "型態": "TEXT",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "settings.value（JSON 字串）"
      },
      {
        "欄位": "created_at",
        "中文": "建立時間(UTC)",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "否",
        "預設值": "timezone('UTC', now())",
        "備註": "TimestampMixin"
      },
      {
        "欄位": "updated_at",
        "中文": "更新時間(UTC)",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "TimestampMixin；更新時由資料庫 onupdate"
      }
    ]
  },
  "備註": ""
}
