{
  "功能編號": "2-2",
  "功能名稱": "鏡頭串流",
  "功能說明": "使用者可在鏡頭頁面新增/編輯/刪除鏡頭，並取得 RTSP 推流 URL 供外部攝影機/OBS 推流；啟動串流時後端會呼叫 StreamingServer 開始錄影切片並回傳狀態，前端會輪詢串流狀態並以 WebRTC（WHEP）播放即時畫面，停止串流需經確認對話框。",
  "程式名稱": "services/WebUIServer/app/template/camera.html; services/WebUIServer/app/static/js/camera.js; services/WebUIServer/app/static/js/services/CameraService.js; services/WebUIServer/app/static/js/APIClient.js; services/WebUIServer/app/template/partials/stop_stream_confirm_dialog.html; services/APIServer/app/router/Camera/service.py; services/APIServer/app/router/Camera/DTO.py; services/APIServer/app/DataAccess/tables/camera.py; services/StreamingServer/app/main.py",
  "輸入": [
    "鏡頭資料（name、status、max_publishers）",
    "ttl（串流連結有效時間秒數）",
    "segment_seconds（切片秒數；未提供則使用系統設定或預設 30）",
    "Bearer JWT（localStorage.jwt）"
  ],
  "輸出": [
    "鏡頭清單與鏡頭資訊",
    "RTSP 推流 URL（含 token）",
    "串流狀態（starting/running/reconnecting/stopped/error）",
    "WebRTC 播放 URL（含 token）",
    "停止串流結果（ok）"
  ],
  "INPUT_PROCESS_OUTPUT": {
    "INPUT": [
      {
        "step_no": 1,
        "title": "頁面載入",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "使用者進入鏡頭頁（/camera）"
          }
        ]
      },
      {
        "step_no": 2,
        "title": "使用者操作",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "新增鏡頭（輸入鏡頭名稱並提交）"
          },
          {
            "sub_no": "②",
            "item": "編輯鏡頭（修改名稱/狀態並儲存）"
          },
          {
            "sub_no": "③",
            "item": "取得串流連結（RTSP 推流 URL）"
          },
          {
            "sub_no": "④",
            "item": "開始串流（connect）或停止串流（stop）"
          },
          {
            "sub_no": "⑤",
            "item": "觀看即時串流（WebRTC 播放）"
          }
        ]
      }
    ],
    "PROCESS": [
      {
        "step_no": 1,
        "title": "權限檢查",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "前端檢查 localStorage.jwt；不存在或 GET /users/me 失敗則導向 /auth"
          }
        ]
      },
      {
        "step_no": 2,
        "title": "資料查詢",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "載入鏡頭清單：GET /api/v1/camera/，前端選擇第一個非 deleted 的鏡頭作為 currentCamera"
          },
          {
            "sub_no": "②",
            "item": "開始輪詢串流狀態：GET /api/v1/camera/{id}/stream/status（每 3 秒）"
          }
        ]
      },
      {
        "step_no": 3,
        "title": "串流控制",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "開始串流：POST /api/v1/camera/{id}/stream/connect（ttl/segment_seconds）"
          },
          {
            "sub_no": "②",
            "item": "停止串流：顯示確認對話框後，POST /api/v1/camera/{id}/stream/stop"
          }
        ]
      },
      {
        "step_no": 4,
        "title": "播放處理",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "取得 WebRTC 播放 URL：GET /api/v1/camera/{id}/play-webrtc-url"
          },
          {
            "sub_no": "②",
            "item": "前端以 WHEP（POST SDP offer 到 play-webrtc-url）建立 RTCPeerConnection 並播放"
          }
        ]
      }
    ],
    "OUTPUT": [
      {
        "step_no": 1,
        "title": "顯示結果",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "顯示鏡頭資訊卡、操作按鈕、串流狀態指示器與即時預覽畫面"
          },
          {
            "sub_no": "②",
            "item": "若無鏡頭：顯示新增鏡頭表單"
          }
        ]
      }
    ]
  },
  "資料表": {
    "table_name": "camera; settings; users",
    "columns": [
      {
        "欄位": "id",
        "中文": "鏡頭ID",
        "型態": "UUID",
        "長度": null,
        "空值": "否",
        "預設值": "uuid7",
        "備註": "camera.id；Primary Key"
      },
      {
        "欄位": "user_id",
        "中文": "使用者ID",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "camera.user_id；ForeignKey(users.id)；索引"
      },
      {
        "欄位": "name",
        "中文": "鏡頭名稱",
        "型態": "VARCHAR",
        "長度": 128,
        "空值": "否",
        "預設值": null,
        "備註": "camera.name"
      },
      {
        "欄位": "status",
        "中文": "鏡頭狀態",
        "型態": "ENUM",
        "長度": null,
        "空值": "否",
        "預設值": "inactive",
        "備註": "camera.status（active/inactive/deleted）"
      },
      {
        "欄位": "path",
        "中文": "串流路徑",
        "型態": "VARCHAR",
        "長度": 64,
        "空值": "是",
        "預設值": null,
        "備註": "camera.path（公開串流 path）"
      },
      {
        "欄位": "token_version",
        "中文": "Token版本",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": 0,
        "備註": "camera.token_version"
      },
      {
        "欄位": "last_seen_at",
        "中文": "最後上線時間",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "camera.last_seen_at"
      },
      {
        "欄位": "max_publishers",
        "中文": "最大推流者數量",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": 1,
        "備註": "camera.max_publishers"
      },
      {
        "欄位": "created_at",
        "中文": "建立時間(UTC)",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "否",
        "預設值": "timezone('UTC', now())",
        "備註": "camera.created_at；TimestampMixin"
      },
      {
        "欄位": "updated_at",
        "中文": "更新時間(UTC)",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "camera.updated_at；TimestampMixin；更新時由資料庫 onupdate"
      }
    ]
  }
}
