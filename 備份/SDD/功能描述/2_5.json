{
  "功能編號": "2-5",
  "功能名稱": "AI 助手",
  "功能說明": "AI 助手提供聊天式介面，使用者可送出訊息並保留對話歷史（瀏覽器本機持久化），可指定查詢日期範圍；後端會依使用者時區與對話上下文呼叫 LLM，並透過 Function Calling 查詢事件/影片/日記/Vlog 等關聯資料後回傳給前端呈現；若使用系統預設 AI Key 則套用速率/日配額限制並提示用量。",
  "程式名稱": "services/WebUIServer/app/template/chat.html; services/WebUIServer/app/static/js/chat.js; services/WebUIServer/app/static/css/chat.css; services/WebUIServer/app/static/js/APIClient.js; services/APIServer/app/router/Chat/service.py; services/APIServer/app/router/Chat/DTO.py; services/APIServer/app/router/Chat/llm_tools.py; services/APIServer/app/router/Chat/tools_schema.py; services/APIServer/app/router/Chat/rate_limiter.py; services/APIServer/app/DataAccess/tables/events.py; services/APIServer/app/DataAccess/tables/recordings.py; services/APIServer/app/DataAccess/tables/diary.py; services/APIServer/app/DataAccess/tables/vlogs.py; services/APIServer/app/DataAccess/tables/llm_usage_logs.py; services/APIServer/app/DataAccess/tables/settings.py; services/APIServer/app/DataAccess/tables/api_key_blacklist.py; services/APIServer/app/DataAccess/tables/users.py",
  "輸入": [
    "message（使用者訊息）",
    "history（對話歷史，最多 10 條送後端）",
    "date_from/date_to（可選，YYYY-MM-DD）",
    "max_results（每次工具查詢上限）",
    "Bearer JWT"
  ],
  "輸出": [
    "ChatResponse（message/events/recordings/diaries/vlogs/function_calls/total_*）",
    "聊天訊息 UI（含事件/影片/Vlog 按鈕或預覽清單）",
    "錯誤提示（401/429/500/503 等）"
  ],
  "INPUT_PROCESS_OUTPUT": {
    "INPUT": [
      {
        "step_no": 1,
        "title": "頁面載入",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "使用者進入 AI 助手頁（/chat），載入聊天介面與工具面板（日期範圍/清除對話）"
          },
          {
            "sub_no": "②",
            "item": "前端從 localStorage 以 user_id 為 key 讀取既有對話並渲染（若無則顯示歡迎訊息）"
          }
        ]
      },
      {
        "step_no": 2,
        "title": "使用者操作",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "輸入訊息並按下【送出】或 Enter 發送"
          },
          {
            "sub_no": "②",
            "item": "展開工具面板並設定開始/結束日期（可不填）"
          },
          {
            "sub_no": "③",
            "item": "點擊【清除對話】並確認"
          },
          {
            "sub_no": "④",
            "item": "點擊 AI 回覆中的【顯示事件/顯示影片/顯示 Vlog】或直接點擊預覽項目"
          }
        ]
      }
    ],
    "PROCESS": [
      {
        "step_no": 1,
        "title": "權限檢查",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "前端檢查登入狀態（localStorage.jwt），並呼叫 GET /users/me 驗證；失敗則導向 /auth"
          }
        ]
      },
      {
        "step_no": 2,
        "title": "呼叫聊天 API",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "前端組合請求（message/date_from/date_to/history）呼叫 POST /api/v1/chat"
          },
          {
            "sub_no": "②",
            "item": "送出前先將使用者訊息寫入畫面與 localStorage，並顯示 AI 載入中訊息"
          }
        ]
      },
      {
        "step_no": 3,
        "title": "後端對話處理",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "後端取得使用者設定（時區/LLM provider/model/api_key）；若未設定個人 key，改用系統預設 key（並檢查 api_key_blacklist）"
          },
          {
            "sub_no": "②",
            "item": "若使用系統預設 key 且非 Admin：由 settings.default_ai_key_limits 讀取 rpm/rpd，進行 per-user 限流；超限回 429"
          },
          {
            "sub_no": "③",
            "item": "將前端 history 正規化為 LLM 可接受角色，並將使用者資訊/時區/當前日期與（可選）日期範圍附加到本次訊息作為上下文"
          },
          {
            "sub_no": "④",
            "item": "呼叫 LLM 並允許 Function Calling：依問題調度工具查詢 events/recordings/diary/vlogs，彙整結果後生成 final_message"
          },
          {
            "sub_no": "⑤",
            "item": "每次成功回覆將 token 使用量與 assistant_replies=1 寫入 llm_usage_logs"
          }
        ]
      }
    ],
    "OUTPUT": [
      {
        "step_no": 1,
        "title": "顯示回覆",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "前端移除載入中訊息並顯示 AI 回覆文字，並更新對話歷史與 localStorage"
          },
          {
            "sub_no": "②",
            "item": "若回傳 events/recordings/diaries/vlogs：顯示按鈕或預覽清單，並支援開啟列表視窗/播放視窗"
          }
        ]
      },
      {
        "step_no": 2,
        "title": "錯誤提示",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "401：顯示「登入已過期」並導向 /auth"
          },
          {
            "sub_no": "②",
            "item": "429/400/500/503：在對話中顯示錯誤訊息（含配額/限流原因）"
          }
        ]
      }
    ]
  },
  "資料表": {
    "table_name": "events; recordings; diary; vlogs; llm_usage_logs; settings; api_key_blacklist; users",
    "columns": [
      {
        "欄位": "id",
        "中文": "事件ID",
        "型態": "UUID",
        "長度": null,
        "空值": "否",
        "預設值": "uuid7",
        "備註": "events.id；Primary Key"
      },
      {
        "欄位": "user_id",
        "中文": "使用者ID",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "events.user_id / recordings.user_id / diary.user_id / vlogs.user_id / llm_usage_logs.user_id"
      },
      {
        "欄位": "recording_id",
        "中文": "錄影ID",
        "型態": "UUID",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "events.recording_id（關聯 recordings.id）"
      },
      {
        "欄位": "action",
        "中文": "行為",
        "型態": "VARCHAR",
        "長度": 128,
        "空值": "是",
        "預設值": null,
        "備註": "events.action"
      },
      {
        "欄位": "scene",
        "中文": "地點",
        "型態": "VARCHAR",
        "長度": 128,
        "空值": "是",
        "預設值": null,
        "備註": "events.scene"
      },
      {
        "欄位": "summary",
        "中文": "摘要",
        "型態": "TEXT",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "events.summary（關聯資料顯示/關鍵字查詢）"
      },
      {
        "欄位": "objects",
        "中文": "物件清單",
        "型態": "ARRAY(VARCHAR)",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "events.objects"
      },
      {
        "欄位": "start_time",
        "中文": "開始時間",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "events.start_time / recordings.start_time（會轉換為使用者時區顯示）"
      },
      {
        "欄位": "duration",
        "中文": "持續秒數",
        "型態": "FLOAT",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "events.duration / recordings.duration / vlogs.duration"
      },
      {
        "欄位": "s3_key",
        "中文": "S3 路徑",
        "型態": "TEXT",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "recordings.s3_key（必填）/ vlogs.s3_key（可選）"
      },
      {
        "欄位": "thumbnail_s3_key",
        "中文": "縮圖S3路徑",
        "型態": "TEXT",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "recordings.thumbnail_s3_key / vlogs.thumbnail_s3_key"
      },
      {
        "欄位": "diary_date",
        "中文": "日記日期",
        "型態": "DATE",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "diary.diary_date"
      },
      {
        "欄位": "content",
        "中文": "內容",
        "型態": "TEXT",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "diary.content"
      },
      {
        "欄位": "status",
        "中文": "狀態",
        "型態": "VARCHAR",
        "長度": 50,
        "空值": "否",
        "預設值": "pending",
        "備註": "vlogs.status（pending/processing/completed/failed）"
      },
      {
        "欄位": "target_date",
        "中文": "目標日期",
        "型態": "DATE",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "vlogs.target_date"
      },
      {
        "欄位": "assistant_replies",
        "中文": "AI 助手回覆次數",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": 0,
        "備註": "llm_usage_logs.assistant_replies"
      },
      {
        "欄位": "key",
        "中文": "設定鍵",
        "型態": "VARCHAR",
        "長度": 100,
        "空值": "否",
        "預設值": null,
        "備註": "settings.key（例如 default_ai_key_limits）"
      },
      {
        "欄位": "value",
        "中文": "設定值",
        "型態": "TEXT",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "settings.value（JSON 字串）"
      },
      {
        "欄位": "user_id",
        "中文": "黑名單使用者ID",
        "型態": "INTEGER",
        "長度": null,
        "空值": "否",
        "預設值": null,
        "備註": "api_key_blacklist.user_id（Primary Key；ForeignKey(users.id)）"
      },
      {
        "欄位": "account",
        "中文": "帳號",
        "型態": "VARCHAR",
        "長度": 50,
        "空值": "否",
        "預設值": null,
        "備註": "users.account（unique/index）"
      },
      {
        "欄位": "settings",
        "中文": "使用者設定(JSON)",
        "型態": "JSONB",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "users.settings（含時區/LLM 設定等）"
      },
      {
        "欄位": "created_at",
        "中文": "建立時間(UTC)",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "否",
        "預設值": "timezone('UTC', now())",
        "備註": "TimestampMixin"
      },
      {
        "欄位": "updated_at",
        "中文": "更新時間(UTC)",
        "型態": "TIMESTAMP WITH TIME ZONE",
        "長度": null,
        "空值": "是",
        "預設值": null,
        "備註": "TimestampMixin；更新時由資料庫 onupdate"
      }
    ]
  }
}
