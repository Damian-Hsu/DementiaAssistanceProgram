{
  "功能編號": "2-2-8",
  "功能名稱": "播放及時串流",
  "功能說明": "當鏡頭串流狀態為 running 時，前端透過後端取得 WebRTC 播放 URL（WHEP endpoint，含 token），並以 RTCPeerConnection 建立接收端連線；成功後將遠端 MediaStream 指派到 <video> 以播放即時畫面，若連線失敗則採用重連策略。",
  "程式名稱": "services/WebUIServer/app/template/camera.html; services/WebUIServer/app/static/js/camera.js; services/APIServer/app/router/Camera/service.py; services/APIServer/app/security/jwt_manager.py; deploy/mediamtx/mediamtx.yml",
  "輸入": [
    "camera_id",
    "ttl（30~10800 秒；前端使用 180 秒）",
    "Bearer JWT"
  ],
  "輸出": [
    "PlayWebRTCURLResp（play_webrtc_url/ttl/expires_at）",
    "video 元素播放的即時畫面（WebRTC MediaStream）"
  ],
  "INPUT_PROCESS_OUTPUT": {
    "INPUT": [
      {
        "step_no": 1,
        "title": "系統觸發",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "串流狀態變為 running 時自動啟動預覽（或使用者手動觸發）"
          }
        ]
      }
    ],
    "PROCESS": [
      {
        "step_no": 1,
        "title": "取得播放 URL",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "呼叫 GET /api/v1/camera/{id}/play-webrtc-url?ttl=... 取得 play_webrtc_url"
          }
        ]
      },
      {
        "step_no": 2,
        "title": "建立連線",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "前端建立 RTCPeerConnection 並 addTransceiver(recvonly)"
          },
          {
            "sub_no": "②",
            "item": "前端產生 SDP offer 並 POST 到 WHEP endpoint 取得 SDP answer"
          },
          {
            "sub_no": "③",
            "item": "前端 setRemoteDescription 並在 ontrack 將 track 加入 remoteStream"
          }
        ]
      },
      {
        "step_no": 3,
        "title": "重連處理",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "若連線失敗或 404：依重試策略延遲重連，最多重試指定次數"
          }
        ]
      }
    ],
    "OUTPUT": [
      {
        "step_no": 1,
        "title": "顯示結果",
        "sub_steps": [
          {
            "sub_no": "①",
            "item": "成功：video 顯示即時串流畫面"
          },
          {
            "sub_no": "②",
            "item": "失敗：顯示 placeholder，並依策略嘗試重連"
          }
        ]
      }
    ]
  },
  "資料表": {
    "table_name": null,
    "columns": []
  }
}
